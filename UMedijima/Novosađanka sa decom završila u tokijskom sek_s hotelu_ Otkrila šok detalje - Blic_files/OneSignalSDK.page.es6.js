!function(){"use strict";function t(t){return t&&t.t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var e,i;function n(){if(i)return e;i=1,e=function(e,i,s){"function"==typeof i&&(s=i,i={});i||(i={});var o,a,r=i.prefix||"__jp",c=i.name||r+t++,l=i.param||"callback",u=null!=i.timeout?i.timeout:6e4,h=encodeURIComponent,d=document.getElementsByTagName("script")[0]||document.head;u&&(a=setTimeout(function(){g(),s&&s(new Error("Timeout"))},u));function g(){o.parentNode&&o.parentNode.removeChild(o),window[c]=n,a&&clearTimeout(a)}return window[c]=function(t){g(),s&&s(null,t)},e=(e+=(~e.indexOf("?")?"&":"?")+l+"="+h(c)).replace("?&","?"),(o=document.createElement("script")).src=e,d.parentNode.insertBefore(o,d),function(){window[c]&&g()}};var t=0;function n(){}return e}const s=t(n()),o="Email",a="SMS",r="Push",c="ChromePush",l="Email",u="SMS",h="SafariPush",d="SafariLegacyPush",g="FirefoxPush",p=0,w=1,f=-2,m=-23,b=-24,y="chrome",S="edge",v="safari",O="firefox",I="other",k=[{i:"Opera",o:/(?:opera|opr|opios)/i,l:/(?:opera|opr|opios)[ /](\d+(?:\.\d+)?)/i},{i:"Facebook",o:/FBAN\//i,l:/FBAV\/(\d+(?:\.\d+)?)/i},{i:"Samsung Browser",o:/samsungbrowser/i,l:/samsungbrowser[ /](\d+(?:\.\d+)?)/i},{i:"Yandex Browser",o:/yabrowser/i,l:/yabrowser[ /](\d+(?:\.\d+)?)/i},{i:"Vivaldi",o:/vivaldi/i,l:/vivaldi[ /](\d+(?:\.\d+)?)/i},{i:"UC Browser",o:/ucbrowser/i,l:/ucbrowser[ /](\d+(?:\.\d+)?)/i},{i:"Microsoft Edge",o:/edg/i,l:/edg[ /](\d+(?:\.\d+)?)/i},{i:"Firefox",o:/firefox|iceweasel|fxios/i,l:/(?:firefox|iceweasel|fxios)[ /](\d+(?:\.\d+)?)/i},{i:"Chromium",o:/chromium/i,l:/chromium[ /](\d+(?:\.\d+)?)/i},{i:"Chrome",o:/chrome|crios|crmo/i,l:/(?:chrome|crios|crmo)[ /](\d+(?:\.\d+)?)/i},{i:"Safari",o:/safari|applewebkit/i,l:/version[ /](\d+(?:\.\d+)?)/i}];function x(t){for(const e of k)if(e.o.test(t)){const i=t.match(e.l)?.[1]??"";return{name:e.i,version:i}}return{name:"Unknown",version:""}}const C=t=>!/like android/i.test(t)&&/android/i.test(t),E=t=>t.match(/(iphone|ipod|ipad)/i)?.[1]?.toLowerCase()||"";function P(t=navigator.userAgent){const e=E(t);return/tablet/i.test(t)&&!/tablet pc/i.test(t)||"ipad"===e||C(t)&&!/[^-]mobi/i.test(t)||!/nexus\s*[0-6]\s*/i.test(t)&&/nexus\s*\d+/i.test(t)}function $(t=navigator.userAgent){if(P(t))return!1;const e=E(t);return/[^-]mobi/i.test(t)||"iphone"===e||"ipod"===e||C(t)}const T={Chrome:y,Chromium:y,Firefox:O,"Microsoft Edge":S,Safari:v};function _(){return T[x(navigator.userAgent).name]||I}const N=()=>{const t=x(navigator.userAgent).version;if(!t)return-1;const[e,i="0"]=t.split(".");return+`${e}.${i}`};function A(){const t=_(),e=N();return t===O&&e>=72||t===v&&e>=12.1}const M="160504",D="undefined"!=typeof window,U=()=>D&&void 0!==window.safari,B=()=>"undefined"!=typeof navigator&&"serviceWorker"in navigator,L="Browser",R=()=>D&&null!=window.safari?.pushNotification,W="undefined"!=typeof PushSubscriptionOptions&&PushSubscriptionOptions.prototype.hasOwnProperty("applicationServerKey"),F=({action:t,legacy:e=!1}={})=>new URL(e?"https://onesignal.com/api/v1/":"https://api.onesignal.com/"),j=()=>_()===O?g:_()===v&&W&&!R()?h:R()?d:c;function K(){return String(N())}function z(){return navigator.platform}const H="set-alias",V="delete-alias",q="set-property",G="refresh-user",J="login-user",Y="create-subscription",Q="update-subscription",Z="delete-subscription",X="transfer-subscription",tt="custom-event",et="external_id",it="onesignal_id",nt=0,st=1,ot=2;class at extends Error{status;statusText;constructor(t,e){super("Registration of a Service Worker failed."),this.status=t,this.statusText=e}}class rt extends Error{reason;constructor(t){let e;switch(t){case st:e="Invalid email";break;case nt:e="Invalid sms";break;case ot:e="Invalid email & sms"}super(e),this.reason=t}}const ct=new Error("Missing app ID"),lt=new Error("Retry limit reached"),ut=new Error("Permission blocked"),ht=new Error("AppID doesn't match existing apps"),dt=new Error("Safari web platform must be enabled"),gt=t=>new Error(`Channel '${t}' already exists`),pt=t=>new Error(`"${t}" is empty`),wt=t=>new Error(`"${t}" is malformed`),ft=t=>new Error(`"${t}" is the wrong type`);function mt(t){return"object"==typeof t&&null!==t&&!Array.isArray(t)}function bt(t,e){if(e&&e.allowNull&&null===t)return!0;if(e&&e.allowEmpty&&null==t)return!0;try{const i=new URL(t);return!e||!e.requireHttps||"https:"===i.protocol}catch(i){return!1}}function yt(t){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/.test(t)}function St(t){return new Promise(e=>setTimeout(e,t))}function vt(){return Promise.resolve()}function Ot(t,e){return null!=t?t:e}function It(){return location.origin}class kt{static u(){try{const t=window.localStorage.getItem("loglevel");return"trace"===t?.toLowerCase()}catch(t){return!1}}static setLevel(t){try{window.localStorage.setItem("loglevel",t)}catch(e){console.error(e)}}static createLogMethod(t){return(...e)=>{(this.u()||"error"===t)&&console[t](...e)}}static debug=kt.createLogMethod("debug");static info=kt.createLogMethod("info");static warn=kt.createLogMethod("warn");static error=kt.createLogMethod("error")}const xt={5:1e4,4:2e4,3:3e4,2:3e4,1:3e4};class Ct{static get(t,e,i){return Ct.call("GET",t,e,i)}static post(t,e,i){return Ct.call("POST",t,e,i)}static put(t,e,i){return Ct.call("PUT",t,e,i)}static delete(t,e,i){return Ct.call("DELETE",t,e,i)}static patch(t,e,i){return Ct.call("PATCH",t,e,i)}static call(t,e,i,n){if(!this.requestHasAppId(e,i))return Promise.reject(ct);const s=new Headers;if(s.append("Origin",window.location.origin),s.append("SDK-Version",`onesignal/web/${M}`),s.append("Content-Type","application/json;charset=UTF-8"),s.append("Accept","application/vnd.onesignal.v1+json"),n)for(const r of Object.keys(n))s.append(r,n[r]);const o={method:t||"NO_METHOD_SPECIFIED",headers:s,cache:"no-cache"};i&&(o.body=JSON.stringify(i));const a=`${F({action:e}).toString()}${e}`;return Ct.executeFetch(a,o)}static async executeFetch(t,e,i=5){if(0===i)return Promise.reject(lt);try{const i=await fetch(t,e),{status:n,headers:s}=i,o=await i.json(),a=s?.get("Retry-After");return{ok:i.ok,result:o,status:n,retryAfterSeconds:a?parseInt(a):void 0}}catch(n){if(n instanceof Error&&"TypeError"===n.name)return await St(xt[i]),kt.error(`OneSignal: Network timed out while calling ${t}. Retrying...`),Ct.executeFetch(t,e,i-1);throw new Error(`Failed to execute HTTP call: ${n}`)}}static requestHasAppId(t,e){if(t.startsWith("apps/")){return yt(t.split("/")[1])}if(t.startsWith("sync/")){return yt(t.split("/")[1])}return!(!e||"string"!=typeof e.app_id)&&yt(e.app_id)}}function Et(t){return encodeURIComponent(t).replace(/[!'()*]/g,t=>`%${t.charCodeAt(0).toString(16).toUpperCase()}`)}async function Pt(t,e,i){const{appId:n,subscriptionId:s}=t;if(!yt(n))throw ht;const o=s?{"OneSignal-Subscription-Id":s}:void 0;let a={};o&&(a={...a,...o}),t.jwtHeader&&(a={...a,...t.jwtHeader});const r=Et(e.label),c=Et(e.id);return Ct.patch(`apps/${n}/users/by/${r}/${c}`,i,a)}function $t(t,e){return!!t&&-1!==t.indexOf(e)}function Tt(t){return JSON.stringify(t,(t,e)=>"function"==typeof e?"[Function]":e,4)}function _t(t){let e="";const i=Object.keys(t);for(const n of i){const i=t[n];e+=`${encodeURIComponent(n)}=${encodeURIComponent(i)}`}return e}const Nt=1,At=2,Mt=3,Dt=4;class Ut{static async sendOutcome(t){kt.info("Outcome payload:",t);try{await Ct.post("outcomes/measure",t)}catch(e){kt.error("sendOutcome",e)}}}class Bt{static jsonpLib(t,e){s(t,void 0,e)}static async downloadServerAppConfig(t){return await new Promise((e,i)=>{Bt.jsonpLib(`${F().toString()}sync/${t}/web`,(t,n)=>{t?i(t):n.success?e(n):i(n)})})}}function Lt(t){if(t.restrictedOriginEnabled&&!function(t){try{return location.origin===new URL(t).origin}catch(e){return!1}}(t.origin))throw new Error(`Can only be used on: ${new URL(t.origin).origin}`)}const Rt={scope:"/"},Wt="OneSignalSDKWorker.js",Ft="native",jt="push",Kt="category",zt="sms",Ht="email",Vt="smsAndEmail",qt={pageViews:1,timeDelay:0},Gt="We'd like to show you notifications for the latest news and updates.",Jt="Allow",Yt="Cancel",Qt="Try Again",Zt={updateMessage:"Update your push notification subscription preferences.",positiveUpdateButton:"Save Preferences",negativeUpdateButton:"Cancel"},Xt="Saving...",te="Thank You!",ee={type:jt,text:{actionMessage:Gt,acceptButton:Jt,cancelButton:Yt},autoPrompt:!1,delay:qt},ie="wordpress",ne="custom";function se(t){const e=t.config.staticPrompts,i=e.native?{enabled:e.native.enabled,autoPrompt:e.native.enabled&&!1!==e.native.autoPrompt,pageViews:Ot(e.native.pageViews,qt.pageViews),timeDelay:Ot(e.native.timeDelay,qt.timeDelay)}:{enabled:!1,autoPrompt:!1,pageViews:qt.pageViews,timeDelay:qt.timeDelay},{prompts:n}=e.slidedown;return{autoPrompt:i.autoPrompt||oe(n),native:i,slidedown:{prompts:n},fullscreen:{enabled:e.fullscreen.enabled,actionMessage:e.fullscreen.actionMessage,acceptButton:e.fullscreen.acceptButton,cancelButton:e.fullscreen.cancelButton,title:e.fullscreen.title,message:e.fullscreen.message,caption:e.fullscreen.caption,autoAcceptTitle:e.fullscreen.autoAcceptTitle},customlink:ae(t)}}function oe(t){if(!t)return!1;for(let e=0;e<t.length;e++)if(t[e].autoPrompt)return!0;return!1}function ae(t){const e={enabled:!1,style:"button",size:"medium",unsubscribeEnabled:!1,text:{explanation:"",subscribe:"",unsubscribe:""},color:{button:"",text:""}};if(!(t&&t.config&&t.config.staticPrompts&&t.config.staticPrompts.customlink&&t.config.staticPrompts.customlink.enabled))return e;const i=t.config.staticPrompts.customlink;return{enabled:i.enabled,style:i.style,size:i.size,unsubscribeEnabled:i.unsubscribeEnabled,text:i.text?{subscribe:i.text.subscribe,unsubscribe:i.text.unsubscribe,explanation:i.text.explanation}:e.text,color:i.color?{button:i.color.button,text:i.color.text}:e.color}}const re=0,ce=1;function le(t){switch(t){case ne:case ie:return{configuration:ce};default:return{configuration:re}}}function ue(t,e,i){switch(le(t).configuration){case re:{const{path:t,serviceWorkerPath:n,serviceWorkerParam:s}=function(t,e){const{serviceWorker:i}=e.config,n=t.serviceWorkerOverrideForTypical;return{path:n?Ot(t.path,i.path):i.path,serviceWorkerParam:n?Ot(t.serviceWorkerParam,{scope:i.registrationScope}):{scope:i.registrationScope},serviceWorkerPath:n?Ot(t.serviceWorkerPath,i.workerName):i.workerName}}(e,i);return{appId:i.app_id,autoRegister:!1,autoResubscribe:i.config.autoResubscribe,path:t,serviceWorkerPath:n,serviceWorkerParam:s,subdomainName:i.config.siteInfo.proxyOrigin,promptOptions:se(i),welcomeNotification:{disable:!i.config.welcomeNotification.enable,title:i.config.welcomeNotification.title,message:i.config.welcomeNotification.message,url:i.config.welcomeNotification.url},notifyButton:{enable:i.config.staticPrompts.bell.enabled,displayPredicate:i.config.staticPrompts.bell.hideWhenSubscribed?()=>!OneSignal.User.PushSubscription.optedIn:null,size:i.config.staticPrompts.bell.size,position:i.config.staticPrompts.bell.location,showCredit:!1,offset:{bottom:`${i.config.staticPrompts.bell.offset.bottom}px`,left:`${i.config.staticPrompts.bell.offset.left}px`,right:`${i.config.staticPrompts.bell.offset.right}px`},colors:{"circle.background":i.config.staticPrompts.bell.color.main,"circle.foreground":i.config.staticPrompts.bell.color.accent,"badge.background":"black","badge.foreground":"white","badge.bordercolor":"black","pulse.color":i.config.staticPrompts.bell.color.accent,"dialog.button.background.hovering":i.config.staticPrompts.bell.color.main,"dialog.button.background.active":i.config.staticPrompts.bell.color.main,"dialog.button.background":i.config.staticPrompts.bell.color.main,"dialog.button.foreground":"white"},text:{"tip.state.unsubscribed":i.config.staticPrompts.bell.tooltip.unsubscribed,"tip.state.subscribed":i.config.staticPrompts.bell.tooltip.subscribed,"tip.state.blocked":i.config.staticPrompts.bell.tooltip.blocked,"message.prenotify":i.config.staticPrompts.bell.tooltip.unsubscribed,"message.action.subscribing":i.config.staticPrompts.bell.message.subscribing,"message.action.subscribed":i.config.staticPrompts.bell.message.subscribing,"message.action.resubscribed":i.config.staticPrompts.bell.message.subscribing,"message.action.unsubscribed":i.config.staticPrompts.bell.message.unsubscribing,"dialog.main.title":i.config.staticPrompts.bell.dialog.main.title,"dialog.main.button.subscribe":i.config.staticPrompts.bell.dialog.main.subscribeButton,"dialog.main.button.unsubscribe":i.config.staticPrompts.bell.dialog.main.unsubscribeButton,"dialog.blocked.title":i.config.staticPrompts.bell.dialog.blocked.title,"dialog.blocked.message":i.config.staticPrompts.bell.dialog.blocked.message}},persistNotification:i.config.notificationBehavior?i.config.notificationBehavior.display.persist:void 0,webhooks:{cors:i.config.webhooks.corsEnable,"notification.willDisplay":i.config.webhooks.notificationDisplayedHook,"notification.clicked":i.config.webhooks.notificationClickedHook,"notification.dismissed":i.config.webhooks.notificationDismissedHook},notificationClickHandlerMatch:i.config.notificationBehavior?i.config.notificationBehavior.click.match:void 0,notificationClickHandlerAction:i.config.notificationBehavior?i.config.notificationBehavior.click.action:void 0,outcomes:{direct:i.config.outcomes.direct,indirect:{enabled:i.config.outcomes.indirect.enabled,influencedTimePeriodMin:i.config.outcomes.indirect.notification_attribution.minutes_since_displayed,influencedNotificationsLimit:i.config.outcomes.indirect.notification_attribution.limit},unattributed:i.config.outcomes.unattributed}}}case ce:{const t={...e,promptOptions:he(e.promptOptions,i.config.staticPrompts,e),serviceWorkerParam:e.serviceWorkerParam?e.serviceWorkerParam:Rt,serviceWorkerPath:e.serviceWorkerPath?e.serviceWorkerPath:Wt,path:e.path?e.path:"/",outcomes:{direct:i.config.outcomes.direct,indirect:{enabled:i.config.outcomes.indirect.enabled,influencedTimePeriodMin:i.config.outcomes.indirect.notification_attribution.minutes_since_displayed,influencedNotificationsLimit:i.config.outcomes.indirect.notification_attribution.limit},unattributed:i.config.outcomes.unattributed}};return Object.prototype.hasOwnProperty.call(e,"autoResubscribe")?t.autoResubscribe=!!e.autoResubscribe:Object.prototype.hasOwnProperty.call(e,"autoRegister")?t.autoResubscribe=!!e.autoRegister:t.autoResubscribe=!!i.config.autoResubscribe,t}}}function he(t,e,i){let n={enabled:!1};t&&t.customlink&&(n=t.customlink);const s=e.customlink,o={...t,customlink:{enabled:Ot(n.enabled,s.enabled),style:Ot(n.style,s.style),size:Ot(n.size,s.size),unsubscribeEnabled:Ot(n.unsubscribeEnabled,s.unsubscribeEnabled),text:{subscribe:Ot(n.text?n.text.subscribe:void 0,s.text.subscribe),unsubscribe:Ot(n.text?n.text.unsubscribe:void 0,s.text.unsubscribe),explanation:Ot(n.text?n.text.explanation:void 0,s.text.explanation)},color:{button:Ot(n.color?n.color.button:void 0,s.color.button),text:Ot(n.color?n.color.text:void 0,s.color.text)}}};if(o.slidedown?o.slidedown.prompts=o.slidedown?.prompts?.map(t=>{if(t.type=Ot(t.type,jt),t.type===Kt&&(t.text={...t.text,positiveUpdateButton:Ot(t.text?.positiveUpdateButton,Zt.positiveUpdateButton),negativeUpdateButton:Ot(t.text?.negativeUpdateButton,Zt.negativeUpdateButton),updateMessage:Ot(t.text?.updateMessage,Zt.updateMessage)}),t.text={...t.text,actionMessage:Ot(t.text?.actionMessage,Gt),acceptButton:Ot(t.text?.acceptButton,Jt),cancelButton:Ot(t.text?.cancelButton,Yt),confirmMessage:Ot(t.text?.confirmMessage,te)},t.autoPrompt=Ot(t.autoPrompt,!0),t.delay={pageViews:Ot(t.delay?.pageViews,qt.pageViews),timeDelay:Ot(t.delay?.timeDelay,qt.timeDelay)},t.categories){const{categories:i}=t;t.categories=(e=10,structuredClone(i).slice(0,e))}var e;return t}):(o.slidedown={prompts:[]},o.slidedown.prompts=[ee]),o.native){const t=Object.prototype.hasOwnProperty.call(o.native,"autoPrompt");o.native.autoPrompt=t?!!o.native.enabled&&!!o.native.autoPrompt:!!o.native.enabled,o.native.enabled=!!o.native.enabled,o.native.pageViews=Ot(o.native.pageViews,qt.pageViews),o.native.timeDelay=Ot(o.native.timeDelay,qt.timeDelay)}else o.native={enabled:!1,autoPrompt:!1,pageViews:qt.pageViews,timeDelay:qt.timeDelay};return!0===i.autoRegister&&(o.native.enabled=!0,o.native.autoPrompt=!0),o.autoPrompt=o.native.autoPrompt||oe(o.slidedown.prompts),o}function de(t){(function(t){if(!t)return!1;return["acceptButtonText","cancelButtonText","actionMessage"].some(e=>Object.prototype.hasOwnProperty.call(t,e))})(t.promptOptions)&&(t.promptOptions=function(t){t.slidedown||(t.slidedown={});const{slidedown:e}=t;return e.acceptButtonText=e.acceptButtonText??t.acceptButtonText??t.acceptButton,e.cancelButtonText=e.cancelButtonText??t.cancelButtonText??t.cancelButton,e.actionMessage=e.actionMessage??t.actionMessage,t}(t.promptOptions)),function(t){if(!t)return!1;return["enabled","autoPrompt","pageViews","timeDelay","acceptButton","acceptButtonText","cancelButton","cancelButtonText","actionMessage","customizeTextEnabled","categories"].some(e=>Object.prototype.hasOwnProperty.call(t,e))}(t.promptOptions?.slidedown)&&t.promptOptions?.slidedown&&(t.promptOptions.slidedown=function(t){const e=(a=t,(a?.categories?.tags?.length||0)>0),i=e?Kt:jt,{categories:n,prompts:s=[]}=t,o={type:i,autoPrompt:t.autoPrompt,text:{actionMessage:t.actionMessage,acceptButton:t.acceptButton??t.acceptButtonText,cancelButton:t.cancelButton??t.cancelButtonText,...e&&{positiveUpdateButton:n?.positiveUpdateButton,negativeUpdateButton:n?.negativeUpdateButton,updateMessage:n?.updateMessage}},delay:{pageViews:t.pageViews,timeDelay:t.timeDelay},categories:n?.tags};var a;return{prompts:[...s,o]}}(t.promptOptions?.slidedown))}const ge=30,pe=!1,we=!0;async function fe(t){return async function(t,e){try{if(!t||!t.appId||!yt(t.appId))throw ht;const i=await e(t.appId);de(t);const n=function(t,e){const i=function(t){return t.config.integration?.kind??ne}(e),n=function(t,e,i){switch(le(t).configuration){case re:return i.config.siteInfo.proxyOriginEnabled;case ce:return!!e.subdomainName}}(i,t,e),s=ue(i,t,e);return{appId:e.app_id,hasUnsupportedSubdomain:n,siteName:e.config.siteInfo.name,origin:e.config.origin,restrictedOriginEnabled:e.features.restrict_origin&&e.features.restrict_origin.enable,safariWebId:e.config.safari_web_id,vapidPublicKey:e.config.vapid_public_key,onesignalVapidPublicKey:e.config.onesignal_vapid_public_key,userConfig:s,enableOnSession:Ot(e.features.enable_on_session,pe),sessionThreshold:Ot(e.features.session_threshold,ge),enableSessionDuration:Ot(e.features.web_on_focus_enabled,we)}}(t,i);return function(t){const e=!self.isSecureContext;if(t.hasUnsupportedSubdomain||e)throw e?new Error("OneSignalSDK: HTTP sites are no longer supported starting with version 16 (User Model), your public site must start with https://."):new Error('OneSignalSDK: The "My site is not fully HTTPS" option is no longer supported starting with version 16 (User Model) of the OneSignal SDK.')}(n),Lt(n),n}catch(i){if(i instanceof Object&&"code"in i){if(1===i.code)throw ht;if(2===i.code)throw new Error("App not configured for web push")}throw i}}(t,Bt.downloadServerAppConfig)}const me=(t,e)=>e.some(e=>t instanceof e);let be,ye;const Se=new WeakMap,ve=new WeakMap,Oe=new WeakMap;let Ie={get(t,e,i){if(t instanceof IDBTransaction){if("done"===e)return Se.get(t);if("store"===e)return i.objectStoreNames[1]?void 0:i.objectStore(i.objectStoreNames[0])}return Ee(t[e])},set:(t,e,i)=>(t[e]=i,!0),has:(t,e)=>t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t};function ke(t){Ie=t(Ie)}function xe(t){return(ye||(ye=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(Pe(this),e),Ee(this.request)}:function(...e){return Ee(t.apply(Pe(this),e))}}function Ce(t){return"function"==typeof t?xe(t):(t instanceof IDBTransaction&&function(t){if(Se.has(t))return;const e=new Promise((e,i)=>{const n=()=>{t.removeEventListener("complete",s),t.removeEventListener("error",o),t.removeEventListener("abort",o)},s=()=>{e(),n()},o=()=>{i(t.error||new DOMException("AbortError","AbortError")),n()};t.addEventListener("complete",s),t.addEventListener("error",o),t.addEventListener("abort",o)});Se.set(t,e)}(t),me(t,be||(be=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(t,Ie):t)}function Ee(t){if(t instanceof IDBRequest)return function(t){const e=new Promise((e,i)=>{const n=()=>{t.removeEventListener("success",s),t.removeEventListener("error",o)},s=()=>{e(Ee(t.result)),n()},o=()=>{i(t.error),n()};t.addEventListener("success",s),t.addEventListener("error",o)});return Oe.set(e,t),e}(t);if(ve.has(t))return ve.get(t);const e=Ce(t);return e!==t&&(ve.set(t,e),Oe.set(e,t)),e}const Pe=t=>Oe.get(t);const $e=["get","getKey","getAll","getAllKeys","count"],Te=["put","add","delete","clear"],_e=new Map;function Ne(t,e){if(!(t instanceof IDBDatabase)||e in t||"string"!=typeof e)return;if(_e.get(e))return _e.get(e);const i=e.replace(/FromIndex$/,""),n=e!==i,s=Te.includes(i);if(!(i in(n?IDBIndex:IDBObjectStore).prototype)||!s&&!$e.includes(i))return;const o=async function(t,...e){const o=this.transaction(t,s?"readwrite":"readonly");let a=o.store;return n&&(a=a.index(e.shift())),(await Promise.all([a[i](...e),s&&o.done]))[0]};return _e.set(e,o),o}ke(t=>({...t,get:(e,i,n)=>Ne(e,i)||t.get(e,i,n),has:(e,i)=>!!Ne(e,i)||t.has(e,i)}));const Ae=["continue","continuePrimaryKey","advance"],Me={},De=new WeakMap,Ue=new WeakMap,Be={get(t,e){if(!Ae.includes(e))return t[e];let i=Me[e];return i||(i=Me[e]=function(...t){De.set(this,Ue.get(this)[e](...t))}),i}};async function*Le(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;const i=new Proxy(e,Be);for(Ue.set(i,e),Oe.set(i,Pe(e));e;)yield i,e=await(De.get(i)||e.continue()),De.delete(i)}function Re(t,e){return e===Symbol.asyncIterator&&me(t,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===e&&me(t,[IDBIndex,IDBObjectStore])}ke(t=>({...t,get:(e,i,n)=>Re(e,i)?Le:t.get(e,i,n),has:(e,i)=>Re(e,i)||t.has(e,i)}));const We=1,Fe=2,je=3,Ke=4,ze=5,He=7,Ve=8;let qe=(async(t=7)=>function(t,e,{blocked:i,upgrade:n,blocking:s,terminated:o}={}){const a=indexedDB.open(t,e),r=Ee(a);return n&&a.addEventListener("upgradeneeded",t=>{n(Ee(a.result),t.oldVersion,t.newVersion,Ee(a.transaction),t)}),i&&a.addEventListener("blocked",t=>i(t.oldVersion,t.newVersion,t)),r.then(t=>{o&&t.addEventListener("close",()=>o()),s&&t.addEventListener("versionchange",t=>s(t.oldVersion,t.newVersion,t))}).catch(()=>{}),r}("ONE_SIGNAL_SDK_DB",t,{upgrade(e,i,n,s){const o=n||t;o>=1&&i<1&&(e.createObjectStore("Ids",{keyPath:"type"}),e.createObjectStore("NotificationOpened",{keyPath:"url"}),e.createObjectStore("Options",{keyPath:"key"})),o>=2&&i<2&&(e.createObjectStore("Sessions",{keyPath:"sessionKey"}),e.createObjectStore("NotificationReceived",{keyPath:"notificationId"}),e.createObjectStore("NotificationClicked",{keyPath:"notificationId"})),o>=3&&i<3&&e.createObjectStore("SentUniqueOutcome",{keyPath:"outcomeName"}),o>=4&&i<4&&(e.createObjectStore("identity",{keyPath:"modelId"}),e.createObjectStore("properties",{keyPath:"modelId"}),e.createObjectStore("pushSubscriptions",{keyPath:"modelId"}),e.createObjectStore("smsSubscriptions",{keyPath:"modelId"}),e.createObjectStore("emailSubscriptions",{keyPath:"modelId"})),o>=5&&i<5&&(async function(t,e){const i="NotificationClicked",n="Outcomes.NotificationClicked";t.createObjectStore(n,{keyPath:"notificationId"});let s=await e.objectStore(i).openCursor();for(;s;){const t=s.value;await e.objectStore(n).put({notificationId:t.notificationId||t.notification.id,appId:t.appId,timestamp:t.timestamp}),s=await s.continue()}t.deleteObjectStore(i)}(e,s),async function(t,e){const i="NotificationReceived",n="Outcomes.NotificationReceived";t.createObjectStore(n,{keyPath:"notificationId"});let s=await e.objectStore(i).openCursor();for(;s;)await e.objectStore(n).put(s.value),s=await s.continue();t.deleteObjectStore(i)}(e,s)),o>=6&&i<6&&async function(t,e){const i="subscriptions";let n;t.createObjectStore(i,{keyPath:"modelId"});const s=await e.objectStore("identity").getAll();s.length>0&&(n=s[0].externalId);for(const o of["emailSubscriptions","pushSubscriptions","smsSubscriptions"]){let s=await e.objectStore(o).openCursor();for(;s;)await e.objectStore(i).put({...s.value,modelName:"subscriptions",externalId:n}),s=await s.continue();t.deleteObjectStore(o)}}(e,s),o>=7&&i<7&&e.createObjectStore("operations",{keyPath:"modelId"}),"undefined"!=typeof OneSignal&&(OneSignal.h=!0)},blocked(){kt.debug("IndexedDB: Blocked event")}}))();const Ge={get:async(t,e)=>(await qe).get(t,e),getAll:async t=>(await qe).getAll(t),put:async(t,e)=>(await qe).put(t,e),delete:async(t,e)=>(await qe).delete(t,e),clear:async t=>(await qe).clear(t),close:async()=>(await qe).close()},Je=async t=>{const e=await Ge.get("Options",t);return e&&"value"in e?e.value:null},Ye=async()=>await Ge.get("Sessions","oneSignalSession")??null;class Qe{defaultNotificationUrl;defaultNotificationTitle;lastKnownPushEnabled;lastKnownPushToken;lastKnownPushId;lastKnownOptedIn=!0}const Ze=async()=>{const t={},e=await(async t=>{const e=await Ge.get("Ids",t);return e&&"id"in e?e.id:null})("appId");return t.appId=e,t.vapidPublicKey=await Je("vapidPublicKey"),t},Xe=async()=>{const t=new Qe;return t.defaultNotificationUrl=await Je("defaultUrl"),t.defaultNotificationTitle=await Je("defaultTitle"),t.lastKnownPushEnabled=await Je("isPushEnabled"),t.lastKnownOptedIn=await Je("lastOptedIn"),t.lastKnownPushId=await Je("lastPushId")??void 0,t.lastKnownPushToken=await Je("lastPushToken")??void 0,t},ti=async t=>{t.defaultNotificationUrl&&await Ge.put("Options",{key:"defaultUrl",value:t.defaultNotificationUrl}),(t.defaultNotificationTitle||""===t.defaultNotificationTitle)&&await Ge.put("Options",{key:"defaultTitle",value:t.defaultNotificationTitle}),null!=t.lastKnownPushEnabled&&await Ge.put("Options",{key:"isPushEnabled",value:t.lastKnownPushEnabled}),null!=t.lastKnownPushId&&await Ge.put("Options",{key:"lastPushId",value:t.lastKnownPushId}),null!=t.lastKnownPushToken&&await Ge.put("Options",{key:"lastPushToken",value:t.lastKnownPushToken}),null!=t.lastKnownOptedIn&&await Ge.put("Options",{key:"lastOptedIn",value:t.lastKnownOptedIn})},ei=async()=>await Je("consentGiven");class ii{deviceId;subscriptionToken;optedOut;createdAt;expirationTime;serialize(){return{deviceId:this.deviceId,subscriptionToken:this.subscriptionToken,optedOut:this.optedOut,createdAt:this.createdAt,expirationTime:this.expirationTime}}static deserialize(t){const e=new ii;return e.deviceId=t.deviceId,e.subscriptionToken=t.subscriptionToken,e.optedOut=t.optedOut,e.createdAt=t.createdAt,e.expirationTime=t.expirationTime,e}}const ni=async()=>{const t=new ii;t.deviceId=(await Ge.get("Ids","userId"))?.id,t.subscriptionToken=(await Ge.get("Ids","registrationId"))?.id;const e=await Je("optedOut"),i=await Je("subscription"),n=await Je("subscriptionCreatedAt"),s=await Je("subscriptionExpirationTime");return t.optedOut=null!=e?e:null!=i&&!i,t.createdAt=n??null,t.expirationTime=s??null,t},si=async t=>{t.deviceId&&await Ge.put("Ids",{type:"userId",id:t.deviceId}),void 0!==t.subscriptionToken&&await Ge.put("Ids",{type:"registrationId",id:t.subscriptionToken}),null!=t.optedOut&&await Ge.put("Options",{key:"optedOut",value:t.optedOut}),null!=t.createdAt&&await Ge.put("Options",{key:"subscriptionCreatedAt",value:t.createdAt}),null!=t.expirationTime?await Ge.put("Options",{key:"subscriptionExpirationTime",value:t.expirationTime}):await Ge.delete("Options","subscriptionExpirationTime")};function oi(t,e,i){let n;if(n="string"==typeof t?document.querySelector(t):t,!n)throw new Error(`${t} must be a CSS selector string or DOM Element object.`);n.insertAdjacentHTML(e,i)}function ai(t){const e=document.querySelectorAll(t);if(e.length>0)for(let i=0;i<e.length;i++){const t=e[i].parentNode;t&&t.removeChild(e[i])}}function ri(t){const e=document.querySelector(t);return e||(kt.debug(`No instance of ${t} found. Returning stub.`),document.createElement("div"))}function ci(t,e){if("string"==typeof t){const i=document.querySelector(t);if(null===i)throw new Error(`Cannot find element with selector "${t}"`);i.classList.add(e)}else{if("object"!=typeof t)throw new Error(`${t} must be a CSS selector string or DOM Element object.`);t.classList.add(e)}}function li(t,e){if("string"==typeof t){const i=document.querySelector(t);if(null===i)throw new Error(`Cannot find element with selector "${t}"`);i.classList.remove(e)}else{if("object"!=typeof t)throw new Error(`${t} must be a CSS selector string or DOM Element object.`);t.classList.remove(e)}}function ui(t,e){if("string"==typeof t){const i=document.querySelector(t);if(null===i)throw new Error(`Cannot find element with selector "${t}"`);return i.classList.contains(e)}if("object"==typeof t)return t.classList.contains(e);throw new Error(`${t} must be a CSS selector string or DOM Element object.`)}function hi(t){if("undefined"==typeof DOMParser)return t;return(new DOMParser).parseFromString(t,"text/html").documentElement.textContent||""}const di="push",gi="nonPush",pi="promptDismissCount",wi="nonPushPromptsDismissCount",fi="onesignal-notification-prompt",mi="onesignal-non-push-prompt";class bi{static isLocalStorageSupported(){try{return"undefined"!=typeof localStorage&&(localStorage.getItem("test"),!0)}catch(t){return!1}}static setItem(t,e,i){if(!bi.isLocalStorageSupported())return;const n=void 0!==i?60*i*1e3:0,s={value:JSON.stringify(e),timestamp:void 0!==i?(new Date).getTime()+n:void 0};localStorage.setItem(t,JSON.stringify(s))}static getItem(t){if(!bi.isLocalStorageSupported())return null;const e=localStorage.getItem(t);let i;try{i=JSON.parse(e)}catch(s){return null}if(null===i)return null;if(i.timestamp&&(new Date).getTime()>=i.timestamp)return localStorage.removeItem(t),null;let n=i.value;try{n=JSON.parse(i.value)}catch(s){return n}return n}static removeItem(t){if(!bi.isLocalStorageSupported())return null;localStorage.removeItem(t)}}const yi={[di]:pi,[gi]:wi},Si={[di]:fi,[gi]:mi};class vi{static async markPromptDismissedWithType(t){const e=yi[t],i=Si[t];let n=await Je(e);n||(n=0),n+=1;let s=3;2==n?s=7:n>2&&(s=30),kt.debug(`(${L} environment) OneSignal: User dismissed the ${t} notification prompt; reprompt after ${s} days.`),await Ge.put("Options",{key:e,value:n});const o=24*s*60;return bi.setItem(i,"dismissed",o)}static wasPromptOfTypeDismissed(t){switch(t){case di:return"dismissed"===bi.getItem(fi);case gi:return"dismissed"===bi.getItem(mi)}return!1}}async function Oi(){return new Promise(t=>{OneSignal.initialized?t():OneSignal.emitter.once(OneSignal.EVENTS.SDK_INITIALIZED,t)})}function Ii(t,...e){return kt.debug(`Called ${t}(${e.map(Tt).join(", ")})`)}function ki(t,e,i,n=!1){if(e||kt.error("Cannot call on() with no event: ",e),i||kt.error("Cannot call on() with no task: ",i),"string"==typeof t){const n=document.querySelectorAll(t);if(n.length>0)for(let t=0;t<n.length;t++)ki(n[t],e,i)}else if(Array.isArray(t))for(let s=0;s<t.length;s++)ki(t[s],e,i);else{if("object"!=typeof t)throw new Error(`${t} must be a CSS selector string or DOM Element object.`);{const s=function(){return function(e){const o=function(){t.removeEventListener(e.type,s)};n||o(),i?.(e,o)}}();t.addEventListener(e,s)}}}function xi(){return window.__oneSignalSdkLoadCount||0}function Ci(t){if(!t)return"default-icon";const e=_();return e===v&&t.safari?t.safari:e===O&&t.firefox?t.firefox:t.chrome||t.firefox||t.safari||"default-icon"}class Ei{p;constructor(){this.p={}}on(t,e){return this.p[t]=this.p[t]||[],this.p[t].push(e),this}once(t,e){const i=this;function n(){i.off(t,n),e.apply(this,arguments)}return n.listener=e,this.on(t,n),this}off(t,e){const i=this.p[t];if(void 0!==i){for(let t=0;t<i.length;t+=1)if(i[t]===e||i[t].listener===e){i.splice(t,1);break}0===i.length&&this.removeAllListeners(t)}return this}removeAllListeners(t){return t?delete this.p[t]:this.p={},this}listeners(t){try{return this.p[t]}catch(e){return}}numberOfListeners(t){const e=this.listeners(t);return e?e.length:0}async emit(...t){const e=t.shift();let i=this.p[e];if(void 0!==i){i=i.slice(0);const e=i.length;for(let n=0;n<e;n+=1)await i[n].apply(this,t)}return this}}const Pi=["notifyButtonHovering","notifyButtonHover","notifyButtonButtonClick","notifyButtonLauncherClick","animatedElementHiding","animatedElementHidden","animatedElementShowing","animatedElementShown","activeAnimatedElementActivating","activeAnimatedElementActive","activeAnimatedElementInactivating","activeAnimatedElementInactive"];class $i{static async trigger(t,e,i){if(!$t(Pi,t)){const i=e;i||!1===i?kt.debug(`(${L}) » ${t}:`,i):kt.debug(`(${L}) » ${t}`)}if(t===OneSignal.EVENTS.SDK_INITIALIZED){if(OneSignal.initialized)return;OneSignal.initialized=!0}i?await i.emit(t,e):await OneSignal.emitter.emit(t,e)}}let Ti=!1;const _i=async(t=!1)=>{if(!Ti){Ti=!0;try{await Ni(t)}finally{Ti=!1}}},Ni=async t=>{const e=await OneSignal.context.permissionManager.getPermissionStatus(),i=await Je("notificationPermission");(e!==i||t)&&(await Ge.put("Options",{key:"notificationPermission",value:e}),await $i.trigger(OneSignal.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_STRING,e),Ai(i,e,t))},Ai=(t,e,i)=>{const n="granted"===e;(n!==("granted"===t)||i)&&$i.trigger(OneSignal.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_BOOLEAN,n)};class Mi{static async showLocalNotification(t,e,i,n,s,o){Ii("MainHelper:showLocalNotification: ",t,e,i,n,s,o);if(!(await Ze()).appId)throw ct;if(!OneSignal.Notifications.permission)throw new Error("User is not subscribed");if(!bt(i))throw wt("url");if(!bt(n,{allowEmpty:!0,requireHttps:!0}))throw wt("icon");if(!n){const t=await Mi.getNotificationIcons();n=Ci(t)}const a=t=>{const e=[];for(let i=0;i<t.length;i++){const n=t[i];e.push({action:n.id,title:n.text,icon:n.icon,url:n.url})}return e},r={data:s,launchURL:i,buttons:o?a(o):void 0};OneSignal.context.serviceWorkerManager.getRegistration().then(async i=>{if(!i)return void kt.error("Service worker registration not available.");const s={body:e,data:r,icon:n,actions:o?a(o):[]};i.showNotification(t,s)})}static async checkAndTriggerNotificationPermissionChanged(){const t=await Je("notificationPermission"),e=await OneSignal.context.permissionManager.getPermissionStatus();t!==e&&(await _i(),await Ge.put("Options",{key:"notificationPermission",value:e}))}static async getNotificationIcons(){const t=Mi.getAppId();if(!t)throw ct;const e=`${F().toString()}apps/${t}/icon`,i=await fetch(e),n=await i.json();if(n.errors)throw kt.error(`API call ${e}`,"failed with:",n.errors),new Error("Failed to get notification icons.");return n}static getSlidedownOptions(t){return Ot(t.slidedown,{prompts:[]})}static getFullscreenPermissionMessageOptions(t){return t?t.fullscreen?{autoAcceptTitle:t.fullscreen.autoAcceptTitle,actionMessage:t.fullscreen.actionMessage,exampleNotificationTitleDesktop:t.fullscreen.title,exampleNotificationTitleMobile:t.fullscreen.title,exampleNotificationMessageDesktop:t.fullscreen.message,exampleNotificationMessageMobile:t.fullscreen.message,exampleNotificationCaption:t.fullscreen.caption,acceptButton:t.fullscreen.acceptButton,cancelButton:t.fullscreen.cancelButton}:t:null}static getPromptOptionsQueryString(){let t="";if(Mi.getFullscreenPermissionMessageOptions(OneSignal.config?.userConfig.promptOptions)){const e=Mi.getPromptOptionsPostHash();for(const i of Object.keys(e)){t+="&"+i+"="+e[i]}}return t}static getPromptOptionsPostHash(){const t=Mi.getFullscreenPermissionMessageOptions(OneSignal.config?.userConfig.promptOptions),e={};if(t){const i={exampleNotificationTitleDesktop:"exampleNotificationTitle",exampleNotificationMessageDesktop:"exampleNotificationMessage",exampleNotificationTitleMobile:"exampleNotificationTitle",exampleNotificationMessageMobile:"exampleNotificationMessage"};for(const e of Object.keys(i)){const n=i[e];t[e]&&(t[n]=t[e])}const n=["autoAcceptTitle","siteName","autoAcceptTitle","subscribeText","showGraphic","actionMessage","exampleNotificationTitle","exampleNotificationMessage","exampleNotificationCaption","acceptButton","cancelButton","timeout"];for(let s=0;s<n.length;s++){const i=n[s],o=t[i],a=encodeURIComponent(o);(o||!1===o||""===o)&&(e[i]=a)}}return e}static getAppId(){return OneSignal.config?.appId||""}static async getDeviceId(){return(await ni()).deviceId||void 0}static async getCurrentPushToken(){if(R()){const t=window.safari?.pushNotification?.permission(OneSignal.config?.safariWebId).deviceToken;return t?.toLowerCase()||void 0}const t=await OneSignal.context.serviceWorkerManager.getRegistration();if(!t)return;const e=await t.pushManager.getSubscription();return e?.endpoint}}const Di=0,Ui=1,Bi=0,Li=1;class Ri{cache;constructor(){this.cache={}}getCache(){return{...this.cache}}async loadSdkStylesheet(){const t=(()=>{let t;return t="https://onesignal.com",new URL("https://onesignal.com/sdks/web/v16")})();return this.loadIfNew(Di,new URL(`${t}/OneSignalSDK.page.styles.css?v=${M}`))}async loadIfNew(t,e){return this.cache[e.toString()]||(this.cache[e.toString()]=Ri.load(t,e)),this.cache[e.toString()]}static async load(t,e){try{let i;return await new Promise((n,s)=>{switch(t){case Ui:i=document.createElement("script"),i.setAttribute("type","text/javascript"),i.setAttribute("async","async"),i.setAttribute("src",e.toString());break;case Di:i=document.createElement("link"),i.setAttribute("rel","stylesheet"),i.setAttribute("href",e.toString())}i.onerror=s,i.onload=n,document.querySelector("head")?.appendChild(i)}),Bi}catch(i){return Li}}}class Wi{selector;showClass;hideClass;state;targetTransitionEvents;nestedContentSelector;transitionCheckTimeout;constructor(t,e,i,n="shown",s=["opacity","transform"],o,a=500){this.selector=t,this.showClass=e,this.hideClass=i,this.state=n,this.targetTransitionEvents=s,this.nestedContentSelector=o,this.transitionCheckTimeout=a}show(){return this.hidden?new Promise(t=>{this.state="showing",$i.trigger(Wi.EVENTS.SHOWING,this);const e=this.element;if(e?(this.hideClass&&li(e,this.hideClass),this.showClass&&ci(e,this.showClass)):kt.error(`(show) could not find animated element with selector ${this.selector}`),0==this.targetTransitionEvents.length)return t(this);{const e=setTimeout(()=>{kt.debug(`Element did not completely show (state: ${this.state}).`)},this.transitionCheckTimeout);ki(this.element,"transitionend",(i,n)=>{if(i.target===this.element&&$t(this.targetTransitionEvents,i.propertyName))return clearTimeout(e),n(),this.state="shown",$i.trigger(Wi.EVENTS.SHOWN,this),t(this)},!0)}}):Promise.resolve(this)}hide(){return this.shown?new Promise(t=>{this.state="hiding",$i.trigger(Wi.EVENTS.HIDING,this);const e=this.element;if(e?(this.showClass&&li(e,this.showClass),this.hideClass&&ci(e,this.hideClass)):kt.error(`(hide) could not find animated element with selector ${this.selector}`),0==this.targetTransitionEvents.length)return t(this);ki(this.element,"transitionend",(e,i)=>{const n=setTimeout(()=>{kt.debug(`Element did not completely hide (state: ${this.state}).`)},this.transitionCheckTimeout);if(e.target===this.element&&$t(this.targetTransitionEvents,e.propertyName))return clearTimeout(n),i(),this.state="hidden",$i.trigger(Wi.EVENTS.HIDDEN,this),t(this)},!0)}):Promise.resolve(this)}waitUntilShown(){return"shown"===this.state?Promise.resolve(this):new Promise(t=>{OneSignal.emitter.once(Wi.EVENTS.SHOWN,e=>{if(e===this)return t(this)})})}waitUntilHidden(){return"hidden"===this.state?Promise.resolve(this):new Promise(t=>{OneSignal.emitter.once(Wi.EVENTS.HIDDEN,e=>{if(e===this)return t(this)})})}static get EVENTS(){return{SHOWING:"animatedElementShowing",SHOWN:"animatedElementShown",HIDING:"animatedElementHiding",HIDDEN:"animatedElementHidden"}}get content(){if(!this.element)return"";if(this.nestedContentSelector){const t=this.element.querySelector(this.nestedContentSelector);return t?t.innerHTML:""}return this.element.innerHTML}set content(t){if(this.element)if(this.nestedContentSelector){const e=this.element.querySelector(this.nestedContentSelector);e&&(e.textContent=t)}else this.element.textContent=t}get element(){return document.querySelector(this.selector)}get showing(){return"showing"===this.state}get shown(){return"shown"===this.state}get hiding(){return"hiding"===this.state}get hidden(){return"hidden"===this.state}}class Fi extends Wi{activeClass;inactiveClass;activeState;nestedContentSelector;constructor(t,e,i,n,s,o="shown",a="active",r=["opacity","transform"],c){super(t,e,i,o,r),this.activeClass=n,this.inactiveClass=s,this.activeState=a,this.nestedContentSelector=c}activate(){return this.inactive&&this.shown?new Promise(t=>{this.activeState="activating",$i.trigger(Fi.EVENTS.ACTIVATING,this);const e=this.element;if(e?(this.inactiveClass&&li(e,this.inactiveClass),this.activeClass&&ci(e,this.activeClass)):kt.error("Could not find active animated element"),!this.shown)return kt.debug("Ending activate() transition (alternative)."),this.activeState="active",$i.trigger(Fi.EVENTS.ACTIVE,this),t(this);if(0==this.targetTransitionEvents.length)return t(this);{const e=setTimeout(()=>{kt.debug(`Element did not completely activate (state: ${this.state}, activeState: ${this.activeState}).`)},this.transitionCheckTimeout);ki(this.element,"transitionend",(i,n)=>{if(i.target===this.element&&$t(this.targetTransitionEvents,i.propertyName))return clearTimeout(e),n(),this.activeState="active",$i.trigger(Fi.EVENTS.ACTIVE,this),t(this)},!0)}}):Promise.resolve(this)}inactivate(){return this.active?new Promise(t=>{this.activeState="inactivating",$i.trigger(Fi.EVENTS.INACTIVATING,this);const e=this.element;if(e?(this.activeClass&&li(e,this.activeClass),this.inactiveClass&&ci(e,this.inactiveClass)):kt.error("Could not find active animated element"),!this.shown)return this.activeState="inactive",$i.trigger(Fi.EVENTS.INACTIVE,this),t(this);if(0==this.targetTransitionEvents.length)return t(this);{const e=setTimeout(()=>{kt.debug(`Element did not completely inactivate (state: ${this.state}, activeState: ${this.activeState}).`)},this.transitionCheckTimeout);ki(this.element,"transitionend",(i,n)=>{if(i.target===this.element&&$t(this.targetTransitionEvents,i.propertyName))return clearTimeout(e),n(),this.activeState="inactive",$i.trigger(Fi.EVENTS.INACTIVE,this),t(this)},!0)}}):Promise.resolve(this)}waitUntilActive(){return this.active?Promise.resolve(this):new Promise(t=>{OneSignal.emitter.once(Fi.EVENTS.ACTIVE,e=>{if(e===this)return t(this)})})}waitUntilInactive(){return this.inactive?Promise.resolve(this):new Promise(t=>{OneSignal.emitter.once(Fi.EVENTS.INACTIVE,e=>{if(e===this)return t(this)})})}static get EVENTS(){return{...Wi.EVENTS,ACTIVATING:"activeAnimatedElementActivating",ACTIVE:"activeAnimatedElementActive",INACTIVATING:"activeAnimatedElementInactivating",INACTIVE:"activeAnimatedElementInactive"}}get activating(){return"activating"===this.activeState}get active(){return"active"===this.activeState}get inactivating(){return"inactivating"===this.activeState}get inactive(){return"inactive"===this.activeState}}class ji extends Fi{constructor(){super(".onesignal-bell-launcher-badge","onesignal-bell-launcher-badge-opened",void 0,"onesignal-bell-launcher-badge-active",void 0,"hidden")}increment(){if(!isNaN(this.content)){let t=+this.content;t+=1,this.content=t.toString()}}show(){const t=super.show();return OneSignal.notifyButton?.setCustomColorsIfSpecified(),t}decrement(){if(!isNaN(this.content)){let t=+this.content;t-=1,this.content=t>0?t.toString():""}}}class Ki{static store={};static LIMIT=2;static put(t,e){return void 0===Ki.store[t]&&(Ki.store[t]=[null,null]),Ki.store[t].push(e),Ki.store[t].length==Ki.LIMIT+1&&Ki.store[t].shift(),Ki.store[t]}static get(t){return void 0===Ki.store[t]&&(Ki.store[t]=[null,null]),Ki.store[t]}static getFirst(t){return Ki.get(t)[0]}static getLast(t){return Ki.get(t)[1]}static remove(t){delete Ki.store[t]}static isEmpty(t){const e=Ki.get(t);return null===e[0]&&null===e[1]}}class zi extends Wi{bell;contentType;queued;constructor(t){super(".onesignal-bell-launcher-message","onesignal-bell-launcher-message-opened",void 0,"hidden",["opacity","transform"],".onesignal-bell-launcher-message-body"),this.bell=t,this.contentType="",this.queued=[]}static get TIMEOUT(){return 2500}static get TYPES(){return{TIP:"tip",MESSAGE:"message",QUEUED:"queued"}}display(t,e,i=0){return kt.debug(`Calling display(${t}, ${e}, ${i}).`),(this.shown?this.hide():vt()).then(()=>{this.content=hi(e),this.contentType=t}).then(()=>this.show()).then(()=>St(i)).then(()=>this.hide()).then(()=>{this.content=this.getTipForState(),this.contentType="tip"})}getTipForState(){return this.bell.state===Ji.STATES.UNSUBSCRIBED?this.bell.options.text["tip.state.unsubscribed"]:this.bell.state===Ji.STATES.SUBSCRIBED?this.bell.options.text["tip.state.subscribed"]:this.bell.state===Ji.STATES.BLOCKED?this.bell.options.text["tip.state.blocked"]:""}enqueue(t){return this.queued.push(hi(t)),new Promise(t=>{this.bell.badge.shown?this.bell.badge.hide().then(()=>this.bell.badge.increment()).then(()=>this.bell.badge.show()).then(t):(this.bell.badge.increment(),this.bell.initialized?this.bell.badge.show().then(t):t())})}dequeue(t){const e=this.queued.pop(t);return new Promise(t=>{this.bell.badge.shown?this.bell.badge.hide().then(()=>this.bell.badge.decrement()).then(t=>t>0?this.bell.badge.show():Promise.resolve(this)).then(t(e)):(this.bell.badge.decrement(),t(e))})}}class Hi extends Fi{events;bell;constructor(t){super(".onesignal-bell-launcher-button",void 0,void 0,"onesignal-bell-launcher-button-active",void 0,"shown",""),this.bell=t,this.events={mouse:"bell.launcher.button.mouse"};const e=this.element;e&&(e.addEventListener("touchstart",()=>{this.onHovering(),this.onTap()},{passive:!0}),e.addEventListener("mouseenter",()=>{this.onHovering()}),e.addEventListener("mouseleave",()=>{this.onHovered()}),e.addEventListener("touchmove",()=>{this.onHovered()},{passive:!0}),e.addEventListener("mousedown",()=>{this.onTap()}),e.addEventListener("mouseup",()=>{this.onEndTap()}),e.addEventListener("click",()=>{this.onHovered(),this.onClick()}))}onHovering(){(Ki.isEmpty(this.events.mouse)||"out"===Ki.getLast(this.events.mouse))&&$i.trigger(Ji.EVENTS.HOVERING),Ki.put(this.events.mouse,"over")}onHovered(){Ki.put(this.events.mouse,"out"),$i.trigger(Ji.EVENTS.HOVERED)}onTap(){this.pulse(),this.activate(),this.bell.badge.activate()}onEndTap(){this.inactivate(),this.bell.badge.inactivate()}onClick(){if($i.trigger(Ji.EVENTS.BELL_CLICK),$i.trigger(Ji.EVENTS.LAUNCHER_CLICK),this.bell.message.shown&&this.bell.message.contentType==zi.TYPES.MESSAGE)return;const t=Ki.getLast("subscription.optedOut");return this.bell.unsubscribed?t?this.bell.launcher.activateIfInactive().then(()=>{this.bell.showDialogProcedure()}):(Hs(),this.bell.m=!0,OneSignal.emitter.once(OneSignal.EVENTS.SUBSCRIPTION_CHANGED,()=>{this.bell.message.display(zi.TYPES.MESSAGE,this.bell.options.text["message.action.subscribed"],zi.TIMEOUT).then(()=>{this.bell.m=!1,this.bell.launcher.inactivate()})})):(this.bell.subscribed||this.bell.blocked)&&this.bell.launcher.activateIfInactive().then(()=>{this.bell.showDialogProcedure()}),this.bell.message.hide()}pulse(){ai(".pulse-ring"),this.element&&oi(this.element,"beforeend",'<div class="pulse-ring"></div>'),this.bell.setCustomColorsIfSpecified()}}const Vi=new URL("https://media.onesignal.com/web-sdk");class qi extends Wi{bell;subscribeButtonId;unsubscribeButtonId;notificationIcons;constructor(t){super(".onesignal-bell-launcher-dialog","onesignal-bell-launcher-dialog-opened",void 0,"hidden",["opacity","transform"],".onesignal-bell-launcher-dialog-body"),this.bell=t,this.subscribeButtonId="#onesignal-bell-container .onesignal-bell-launcher #subscribe-button",this.unsubscribeButtonId="#onesignal-bell-container .onesignal-bell-launcher #unsubscribe-button",this.notificationIcons=null}show(){return this.updateBellLauncherDialogBody().then(()=>super.show())}get subscribeButtonSelectorId(){return"subscribe-button"}get unsubscribeButtonSelectorId(){return"unsubscribe-button"}get subscribeButton(){return this.element?this.element.querySelector("#"+this.subscribeButtonSelectorId):null}get unsubscribeButton(){return this.element?this.element.querySelector("#"+this.unsubscribeButtonSelectorId):null}updateBellLauncherDialogBody(){return OneSignal.context.subscriptionManager.isPushNotificationsEnabled().then(t=>{this.nestedContentSelector&&function(t){if("string"==typeof t){const e=document.querySelector(t);if(null===e)throw new Error(`Cannot find element with selector "${t}"`);for(;e.firstChild;)e.removeChild(e.firstChild)}else{if("object"!=typeof t)throw new Error(`${t} must be a CSS selector string or DOM Element object.`);for(;t.firstChild;)t.removeChild(t.firstChild)}}(this.nestedContentSelector);let e="Nothing to show.",i="";if(this.bell.options.showCredit&&(i='<div class="divider"></div><div class="kickback">Powered by <a href="https://onesignal.com" class="kickback" target="_blank">OneSignal</a></div>'),this.bell.state===Ji.STATES.SUBSCRIBED&&!0===t||this.bell.state===Ji.STATES.UNSUBSCRIBED&&!1===t){let t="";const n=Ci(this.notificationIcons);t="default-icon"!=n?`<div class="push-notification-icon"><img src="${n}"></div>`:'<div class="push-notification-icon push-notification-icon-default"></div>';let s="";s=this.bell.state!==Ji.STATES.SUBSCRIBED?`<button type="button" class="action" id="${this.subscribeButtonSelectorId}">${this.bell.options.text["dialog.main.button.subscribe"]}</button>`:`<button type="button" class="action" id="${this.unsubscribeButtonSelectorId}">${this.bell.options.text["dialog.main.button.unsubscribe"]}</button>`,e=`<h1>${this.bell.options.text["dialog.main.title"]}</h1><div class="divider"></div><div class="push-notification">${t}<div class="push-notification-text-container"><div class="push-notification-text push-notification-text-short"></div><div class="push-notification-text"></div><div class="push-notification-text push-notification-text-medium"></div><div class="push-notification-text"></div><div class="push-notification-text push-notification-text-medium"></div></div></div><div class="action-container">${s}</div>${i}`}else if(this.bell.state===Ji.STATES.BLOCKED){let t=null;const n=_();n===y?$()||P()||(t="/bell/chrome-unblock.jpg"):n===O?t="/bell/firefox-unblock.jpg":n===v?t="/bell/safari-unblock.jpg":n===S&&(t="/bell/edge-unblock.png");let s="";t&&(t=Vi+t,s=`<a href="${t}" target="_blank"><img src="${t}"></a></div>`),($()||P())&&n===y&&(s="<ol><li>Access <strong>Settings</strong> by tapping the three menu dots <strong>⋮</strong></li><li>Click <strong>Site settings</strong> under Advanced.</li><li>Click <strong>Notifications</strong>.</li><li>Find and click this entry for this website.</li><li>Click <strong>Notifications</strong> and set it to <strong>Allow</strong>.</li></ol>"),e=`<h1>${this.bell.options.text["dialog.blocked.title"]}</h1><div class="divider"></div><div class="instructions"><p>${this.bell.options.text["dialog.blocked.message"]}</p>${s}</div>${i}`}this.nestedContentSelector&&oi(this.nestedContentSelector,"beforeend",e),this.subscribeButton&&this.subscribeButton.addEventListener("click",()=>{OneSignal.S=!1,$i.trigger(Ji.EVENTS.SUBSCRIBE_CLICK)}),this.unsubscribeButton&&this.unsubscribeButton.addEventListener("click",()=>$i.trigger(Ji.EVENTS.UNSUBSCRIBE_CLICK)),this.bell.setCustomColorsIfSpecified()})}}class Gi extends Fi{bell;wasInactive;constructor(t){super(".onesignal-bell-launcher","onesignal-bell-launcher-active",void 0,void 0,"onesignal-bell-launcher-inactive","hidden","active"),this.bell=t,this.wasInactive=!1}async resize(t){if(!this.element)throw new Error("Missing DOM element");if("small"===t&&ui(this.element,"onesignal-bell-launcher-sm")||"medium"===t&&ui(this.element,"onesignal-bell-launcher-md")||"large"===t&&ui(this.element,"onesignal-bell-launcher-lg"))return Promise.resolve(this);if(li(this.element,"onesignal-bell-launcher-sm"),li(this.element,"onesignal-bell-launcher-md"),li(this.element,"onesignal-bell-launcher-lg"),"small"===t)ci(this.element,"onesignal-bell-launcher-sm");else if("medium"===t)ci(this.element,"onesignal-bell-launcher-md");else{if("large"!==t)throw new Error("Invalid OneSignal bell size "+t);ci(this.element,"onesignal-bell-launcher-lg")}return this.shown?await new Promise(t=>{if(0==this.targetTransitionEvents.length)return t(this);{const e=setTimeout(()=>{kt.debug(`Launcher did not completely resize (state: ${this.state}, activeState: ${this.activeState}).`)},this.transitionCheckTimeout);ki(this.element,"transitionend",(i,n)=>{if(i.target===this.element&&$t(this.targetTransitionEvents,i.propertyName))return clearTimeout(e),n(),t(this)},!0)}}):this}activateIfInactive(){return this.inactive?(this.wasInactive=!0,this.activate()):vt()}inactivateIfWasInactive(){return this.wasInactive?(this.wasInactive=!1,this.inactivate()):vt()}clearIfWasInactive(){this.wasInactive=!1}inactivate(){return this.bell.message.hide().then(()=>this.bell.badge.content.length>0?this.bell.badge.hide().then(()=>Promise.all([super.inactivate(),this.resize("small")])).then(()=>this.bell.badge.show()):Promise.all([super.inactivate(),this.resize("small")]))}activate(){return this.bell.badge.content.length>0?this.bell.badge.hide().then(()=>Promise.all([super.activate(),this.resize(this.bell.options.size)])):Promise.all([super.activate(),this.resize(this.bell.options.size)])}}class Ji{options;state=Ji.STATES.UNINITIALIZED;m=!1;hovering=!1;initialized=!1;v;O;I;k;C;DEFAULT_SIZE="medium";DEFAULT_POSITION="bottom-right";DEFAULT_THEME="default";static get EVENTS(){return{STATE_CHANGED:"notifyButtonStateChange",LAUNCHER_CLICK:"notifyButtonLauncherClick",BELL_CLICK:"notifyButtonButtonClick",SUBSCRIBE_CLICK:"notifyButtonSubscribeClick",UNSUBSCRIBE_CLICK:"notifyButtonUnsubscribeClick",HOVERING:"notifyButtonHovering",HOVERED:"notifyButtonHover"}}static get STATES(){return{UNINITIALIZED:"uninitialized",SUBSCRIBED:"subscribed",UNSUBSCRIBED:"unsubscribed",BLOCKED:"blocked"}}static get TEXT_SUBS(){return{"prompt.native.grant":{default:"Allow",chrome:"Allow",firefox:"Always Receive Notifications",safari:"Allow"}}}constructor(t,e){this.options={enable:t.enable||!1,size:t.size||this.DEFAULT_SIZE,position:t.position||this.DEFAULT_POSITION,theme:t.theme||this.DEFAULT_THEME,showLauncherAfter:t.showLauncherAfter||10,showBadgeAfter:t.showBadgeAfter||300,text:this.setDefaultTextOptions(t.text||{}),prenotify:t.prenotify,showCredit:t.showCredit,colors:t.colors,offset:t.offset},e&&(this.v=e),this.options.enable&&(this.validateOptions(this.options),this.state=Ji.STATES.UNINITIALIZED,this.m=!1,this.installEventHooks(),this.updateState())}showDialogProcedure(){this.dialog.shown||this.dialog.show().then(()=>{ki(document,"click",(t,e)=>{this.dialog.element.contains(t.target)||(e(),this.dialog.shown&&this.dialog.hide().then(()=>{this.launcher.inactivateIfWasInactive()}))},!0)})}validateOptions(t){if(!t.size||!$t(["small","medium","large"],t.size))throw new Error(`Invalid size ${t.size} for notify button. Choose among 'small', 'medium', or 'large'.`);if(!t.position||!$t(["bottom-left","bottom-right"],t.position))throw new Error(`Invalid position ${t.position} for notify button. Choose either 'bottom-left', or 'bottom-right'.`);if(!t.theme||!$t(["default","inverse"],t.theme))throw new Error(`Invalid theme ${t.theme} for notify button. Choose either 'default', or 'inverse'.`);if(!t.showLauncherAfter||t.showLauncherAfter<0)throw new Error(`Invalid delay duration of ${this.options.showLauncherAfter} for showing the notify button. Choose a value above 0.`);if(!t.showBadgeAfter||t.showBadgeAfter<0)throw new Error(`Invalid delay duration of ${this.options.showBadgeAfter} for showing the notify button's badge. Choose a value above 0.`)}setDefaultTextOptions(t){return{"tip.state.unsubscribed":t["tip.state.unsubscribed"]||"Subscribe to notifications","tip.state.subscribed":t["tip.state.subscribed"]||"You're subscribed to notifications","tip.state.blocked":t["tip.state.blocked"]||"You've blocked notifications","message.prenotify":t["message.prenotify"]||"Click to subscribe to notifications","message.action.subscribed":t["message.action.subscribed"]||"Thanks for subscribing!","message.action.resubscribed":t["message.action.resubscribed"]||"You're subscribed to notifications","message.action.subscribing":t["message.action.subscribing"]||"Click <strong>{{prompt.native.grant}}</strong> to receive notifications","message.action.unsubscribed":t["message.action.unsubscribed"]||"You won't receive notifications again","dialog.main.title":t["dialog.main.title"]||"Manage Site Notifications","dialog.main.button.subscribe":t["dialog.main.button.subscribe"]||"SUBSCRIBE","dialog.main.button.unsubscribe":t["dialog.main.button.unsubscribe"]||"UNSUBSCRIBE","dialog.blocked.title":t["dialog.blocked.title"]||"Unblock Notifications","dialog.blocked.message":t["dialog.blocked.message"]||"Follow these instructions to allow notifications:"}}installEventHooks(){OneSignal.emitter.on(Ji.EVENTS.SUBSCRIBE_CLICK,()=>{this.dialog.subscribeButton.disabled=!0,this.m=!0,OneSignal.User.PushSubscription.optIn().then(()=>(this.dialog.subscribeButton.disabled=!1,this.dialog.hide())).then(()=>this.message.display(zi.TYPES.MESSAGE,this.options.text["message.action.resubscribed"],zi.TIMEOUT)).then(()=>(this.m=!1,this.launcher.clearIfWasInactive(),this.launcher.inactivate())).then(()=>this.updateState()).catch(t=>{throw t})}),OneSignal.emitter.on(Ji.EVENTS.UNSUBSCRIBE_CLICK,()=>{this.dialog.unsubscribeButton.disabled=!0,OneSignal.User.PushSubscription.optOut().then(()=>(this.dialog.unsubscribeButton.disabled=!1,this.dialog.hide())).then(()=>(this.launcher.clearIfWasInactive(),this.launcher.activate())).then(()=>this.message.display(zi.TYPES.MESSAGE,this.options.text["message.action.unsubscribed"],zi.TIMEOUT)).then(()=>this.updateState())}),OneSignal.emitter.on(Ji.EVENTS.HOVERING,()=>{this.hovering=!0,this.launcher.activateIfInactive(),this.message.shown||this.dialog.shown?this.hovering=!1:this.message.contentType!==zi.TYPES.MESSAGE?new Promise(t=>{if(this.message.queued.length>0)return this.message.dequeue().then(e=>{this.message.content=e,this.message.contentType=zi.TYPES.QUEUED,t()});this.message.content=hi(this.message.getTipForState()),this.message.contentType=zi.TYPES.TIP,t()}).then(()=>this.message.show()).then(()=>{this.hovering=!1}).catch(t=>{kt.error(t)}):this.hovering=!1}),OneSignal.emitter.on(Ji.EVENTS.HOVERED,()=>{this.message.contentType!==zi.TYPES.MESSAGE&&this.dialog.hidden&&(this.hovering&&(this.hovering=!1,this.message.waitUntilShown().then(()=>St(zi.TIMEOUT)).then(()=>this.message.hide()).then(()=>{this.launcher.wasInactive&&this.dialog.hidden&&(this.launcher.inactivate(),this.launcher.wasInactive=!1)})),this.message.shown&&this.message.hide().then(()=>{this.launcher.wasInactive&&this.dialog.hidden&&(this.launcher.inactivate(),this.launcher.wasInactive=!1)}))}),OneSignal.emitter.on(OneSignal.EVENTS.SUBSCRIPTION_CHANGED,async t=>{if(t.current.optedIn&&(this.badge.shown&&this.options.prenotify&&this.badge.hide(),null===this.dialog.notificationIcons)){const t=await Mi.getNotificationIcons();this.dialog.notificationIcons=t}const e=await OneSignal.context.permissionManager.getPermissionStatus();let i;i=t.current.optedIn?Ji.STATES.SUBSCRIBED:"denied"===e?Ji.STATES.BLOCKED:Ji.STATES.UNSUBSCRIBED,this.setState(i,this.m)}),OneSignal.emitter.on(Ji.EVENTS.STATE_CHANGED,t=>{this.launcher.element&&(t.to===Ji.STATES.SUBSCRIBED?this.launcher.inactivate():this.launcher.activate())}),OneSignal.emitter.on(OneSignal.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_STRING,()=>{this.updateState()})}addDefaultClasses(){const t=this.container;if("bottom-left"===this.options.position)t&&ci(t,"onesignal-bell-container-bottom-left"),ci(this.launcher.selector,"onesignal-bell-launcher-bottom-left");else{if("bottom-right"!==this.options.position)throw new Error(`Invalid OneSignal notify button position ${this.options.position}`);t&&ci(t,"onesignal-bell-container-bottom-right"),ci(this.launcher.selector,"onesignal-bell-launcher-bottom-right")}if("default"===this.options.theme)ci(this.launcher.selector,"onesignal-bell-launcher-theme-default");else{if("inverse"!==this.options.theme)throw new Error(`Invalid OneSignal notify button theme ${this.options.theme}`);ci(this.launcher.selector,"onesignal-bell-launcher-theme-inverse")}}async create(){if(!this.options.enable)return;if(await OneSignal.context.dynamicResourceLoader.loadSdkStylesheet()!==Bi)return void kt.debug("Not showing notify button because styles failed to load.");this.container&&ai("#onesignal-bell-container"),oi("body","beforeend",'<div id="onesignal-bell-container" class="onesignal-bell-container onesignal-reset"></div>'),this.container&&oi(this.container,"beforeend",'<div id="onesignal-bell-launcher" class="onesignal-bell-launcher"></div>'),oi(this.launcher.selector,"beforeend",'<div class="onesignal-bell-launcher-button"></div>'),oi(this.launcher.selector,"beforeend",'<div class="onesignal-bell-launcher-badge"></div>'),oi(this.launcher.selector,"beforeend",'<div class="onesignal-bell-launcher-message"></div>'),oi(this.message.selector,"beforeend",'<div class="onesignal-bell-launcher-message-body"></div>'),oi(this.launcher.selector,"beforeend",'<div class="onesignal-bell-launcher-dialog"></div>'),oi(this.dialog.selector,"beforeend",'<div class="onesignal-bell-launcher-dialog-body"></div>'),oi(this.button.selector,"beforeend",'<svg class="onesignal-bell-svg" xmlns="http://www.w3.org/2000/svg" width="99.7" height="99.7" viewBox="0 0 99.7 99.7"><circle class="background" cx="49.9" cy="49.9" r="49.9"/><path class="foreground" d="M50.1 66.2H27.7s-2-.2-2-2.1c0-1.9 1.7-2 1.7-2s6.7-3.2 6.7-5.5S33 52.7 33 43.3s6-16.6 13.2-16.6c0 0 1-2.4 3.9-2.4 2.8 0 3.8 2.4 3.8 2.4 7.2 0 13.2 7.2 13.2 16.6s-1 11-1 13.3c0 2.3 6.7 5.5 6.7 5.5s1.7.1 1.7 2c0 1.8-2.1 2.1-2.1 2.1H50.1zm-7.2 2.3h14.5s-1 6.3-7.2 6.3-7.3-6.3-7.3-6.3z"/><ellipse class="stroke" cx="49.9" cy="49.9" rx="37.4" ry="36.9"/></svg>');const t=await OneSignal.context.subscriptionManager.isPushNotificationsEnabled();vi.wasPromptOfTypeDismissed(di);const e=t?"small":this.options.size||this.DEFAULT_SIZE;await this.launcher.resize(e),this.addDefaultClasses(),this.applyOffsetIfSpecified(),this.setCustomColorsIfSpecified(),this.patchSafariSvgFilterBug(),kt.info("Showing the notify button."),await(t?this.launcher.inactivate():vt()).then(()=>t&&null===this.dialog.notificationIcons?Mi.getNotificationIcons().then(t=>{this.dialog.notificationIcons=t}):vt()).then(()=>St(this.options.showLauncherAfter||0)).then(()=>this.launcher.show()).then(()=>St(this.options.showBadgeAfter||0)).then(()=>this.options.prenotify&&!t&&OneSignal.h?this.message.enqueue(this.options.text["message.prenotify"]).then(()=>this.badge.show()):vt()).then(()=>this.initialized=!0)}patchSafariSvgFilterBug(){if(_()!==v){const t="drop-shadow(0 2px 4px rgba(34,36,38,0.35));",e="drop-shadow(0 2px 4px rgba(34,36,38,0));",i="drop-shadow(0px 2px 2px rgba(34,36,38,.15));";this.graphic.setAttribute("style",`filter: ${t}; -webkit-filter: ${t};`),this.badge.element.setAttribute("style",`filter: ${e}; -webkit-filter: ${e};`),this.dialog.element.setAttribute("style",`filter: ${i}; -webkit-filter: ${i};`)}else this.badge.element.setAttribute("style","display: none;")}applyOffsetIfSpecified(){const t=this.options.offset;if(t){const e=this.launcher.element;if(!e)return void kt.error("Could not find bell dom element");e.style.cssText="",t.bottom&&(e.style.cssText+=`bottom: ${t.bottom};`),"bottom-right"===this.options.position?t.right&&(e.style.cssText+=`right: ${t.right};`):"bottom-left"===this.options.position&&t.left&&(e.style.cssText+=`left: ${t.left};`)}}setCustomColorsIfSpecified(){const t=this.dialog.element.querySelector("button.action"),e=this.button.element.querySelector(".pulse-ring");this.graphic.querySelector(".background").style.cssText="";const i=this.graphic.querySelectorAll(".foreground");for(let n=0;n<i.length;n++){i[n].style.cssText=""}if(this.graphic.querySelector(".stroke").style.cssText="",this.badge.element.style.cssText="",t&&(t.style.cssText="",t.style.cssText=""),e&&(e.style.cssText=""),this.options.colors){const i=this.options.colors;if(i["circle.background"]&&(this.graphic.querySelector(".background").style.cssText+=`fill: ${i["circle.background"]}`),i["circle.foreground"]){const t=this.graphic.querySelectorAll(".foreground");for(let e=0;e<t.length;e++){t[e].style.cssText+=`fill: ${i["circle.foreground"]}`}this.graphic.querySelector(".stroke").style.cssText+=`stroke: ${i["circle.foreground"]}`}i["badge.background"]&&(this.badge.element.style.cssText+=`background: ${i["badge.background"]}`),i["badge.bordercolor"]&&(this.badge.element.style.cssText+=`border-color: ${i["badge.bordercolor"]}`),i["badge.foreground"]&&(this.badge.element.style.cssText+=`color: ${i["badge.foreground"]}`),t&&(i["dialog.button.background"]&&(this.dialog.element.querySelector("button.action").style.cssText+=`background: ${i["dialog.button.background"]}`),i["dialog.button.foreground"]&&(this.dialog.element.querySelector("button.action").style.cssText+=`color: ${i["dialog.button.foreground"]}`),i["dialog.button.background.hovering"]&&this.addCssToHead("onesignal-background-hover-style",`#onesignal-bell-container.onesignal-reset .onesignal-bell-launcher .onesignal-bell-launcher-dialog button.action:hover { background: ${i["dialog.button.background.hovering"]} !important; }`),i["dialog.button.background.active"]&&this.addCssToHead("onesignal-background-active-style",`#onesignal-bell-container.onesignal-reset .onesignal-bell-launcher .onesignal-bell-launcher-dialog button.action:active { background: ${i["dialog.button.background.active"]} !important; }`)),e&&i["pulse.color"]&&(this.button.element.querySelector(".pulse-ring").style.cssText=`border-color: ${i["pulse.color"]}`)}}addCssToHead(t,e){if(document.getElementById(t))return;const i=document.createElement("style");i.id=t,i.type="text/css",i.appendChild(document.createTextNode(e)),document.head.appendChild(i)}updateState(){Promise.all([OneSignal.context.subscriptionManager.isPushNotificationsEnabled(),OneSignal.context.permissionManager.getPermissionStatus()]).then(([t,e])=>{this.setState(t?Ji.STATES.SUBSCRIBED:Ji.STATES.UNSUBSCRIBED),"denied"===e&&this.setState(Ji.STATES.BLOCKED)}).catch(t=>{kt.error(t)})}setState(t,e=!1){const i=this.state;this.state=t,i===t||e||$i.trigger(Ji.EVENTS.STATE_CHANGED,{from:i,to:t})}get container(){return document.querySelector("#onesignal-bell-container")}get graphic(){return this.button.element.querySelector("svg")}get launcher(){return this.v||(this.v=new Gi(this)),this.v}get button(){return this.O||(this.O=new Hi(this)),this.O}get badge(){return this.I||(this.I=new ji),this.I}get message(){return this.k||(this.k=new zi(this)),this.k}get dialog(){return this.C||(this.C=new qi(this)),this.C}get subscribed(){return this.state===Ji.STATES.SUBSCRIBED}get unsubscribed(){return this.state===Ji.STATES.UNSUBSCRIBED}get blocked(){return this.state===Ji.STATES.BLOCKED}}const Yi="slidedown-body",Qi="onesignal-button-indicator-holder",Zi="onesignal-slidedown-container",Xi="onesignal-slidedown-dialog",tn="slidedown-footer",en="onesignal-reset",nn="onesignal-saving-state-button",sn="slide-up",on="slide-down",an="close-slidedown",rn="slidedown-body-icon",cn="slidedown-body-message",ln="default-icon",un="onesignal-loading-container",hn="clearfix",dn="onesignal-toast-text",gn="onesignal-toast-text",pn="onesignal-slidedown-allow-button",wn="slidedown-body",fn="onesignal-button-indicator-holder",mn="onesignal-slidedown-cancel-button",bn="onesignal-slidedown-container",yn="onesignal-slidedown-dialog",Sn="slidedown-footer",vn="normal-slidedown",On="onesignal-loading-container",In="align-right",kn="primary",xn="secondary",Cn="slidedown-button",En="onesignal-category-label-input",Pn="onesignal-category-label-text",$n="onesignal-category-label",Tn="onesignal-checkmark",_n="tagging-container",Nn="tagging-container-col",An="onesignal-loading-message",Mn="tagging-container",Dn="#95A1AC",Un="#FFFFFF",Bn="Fetching your preferences",Ln="channel-capture-container",Rn="input-with-validation-element",Wn="onesignal-error-input",Fn="iti-onesignal-sms-input",jn="onesignal-email-input",Kn="onesignal-validation-element-hidden",zn="onesignal-validation-element",Hn="sms-input-with-validation-element",Vn="email-input-with-validation-element",qn="iti-onesignal-sms-input",Gn="onesignal-email-input",Jn="onesignal-sms-validation-element",Yn="onesignal-email-validation-element",Qn="onesignal-customlink-subscribe",Zn="onesignal-customlink-explanation",Xn="onesignal-reset",ts="hide",es={subscribed:"state-subscribed",unsubscribed:"state-unsubscribed"},is={containerSelector:`.${"onesignal-customlink-container"}`};class ns{config;constructor(t){this.config=t}async initialize(){if(!this.config?.enabled)return;if(!(await this.loadSdkStyles()))return;kt.info("OneSignal: initializing customlink");const t=await OneSignal.context.subscriptionManager.isPushNotificationsEnabled();if(this.config?.unsubscribeEnabled||!t)for(let e=0;e<this.customlinkContainerElements.length;e++)await this.injectMarkup(this.customlinkContainerElements[e]);else this.hideCustomLinkContainers()}async injectMarkup(t){t.innerHTML="",await this.mountExplanationNode(t),await this.mountSubscriptionNode(t)}async mountExplanationNode(t){if(this.config?.text){if(this.config.text.explanation){const e=document.createElement("p");e.textContent=this.config.text.explanation,ci(e,Xn),ci(e,Zn),this.config.size&&ci(e,this.config.size),await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()?ci(e,es.subscribed):ci(e,es.unsubscribed),t.appendChild(e)}}else kt.error("CustomLink: required property 'text' is missing in the config")}async mountSubscriptionNode(t){if(this.config?.text){if(this.config.text.subscribe){const e=document.createElement("button");ci(e,Xn),ci(e,Qn),this.config.size&&ci(e,this.config.size),this.config.style&&ci(e,this.config.style),await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()?ci(e,es.subscribed):ci(e,es.unsubscribed),this.setCustomColors(e),await this.setTextFromPushStatus(e),e.addEventListener("click",async()=>{kt.info("CustomLink: subscribe clicked"),await this.handleClick(e)}),e.setAttribute("type","button"),t.appendChild(e)}}else kt.error("CustomLink: required property 'text' is missing in the config")}async loadSdkStyles(){return await OneSignal.context.dynamicResourceLoader.loadSdkStylesheet()===Bi||(kt.debug("Not initializing custom link button because styles failed to load."),!1)}hideElement(t){ci(t,ts)}hideCustomLinkContainers(){this.customlinkContainerElements.forEach(t=>{this.hideElement(t)})}async handleClick(t){if(!OneSignal.User.PushSubscription.optedIn)return await OneSignal.User.PushSubscription.optIn(),void(this.config?.unsubscribeEnabled||this.hideCustomLinkContainers());await OneSignal.User.PushSubscription.optOut(),await this.setTextFromPushStatus(t)}async setTextFromPushStatus(t){this.config?.text?.subscribe&&(await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()||(t.textContent=this.config.text.subscribe)),this.config?.text?.unsubscribe&&await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()&&(t.textContent=this.config.text.unsubscribe)}setCustomColors(t){this.config?.color&&this.config.color.text&&("button"===this.config?.style&&this.config?.color.button?(t.style.backgroundColor=this.config?.color.button,t.style.color=this.config?.color.text):"link"===this.config?.style&&(t.style.color=this.config?.color.text))}get customlinkContainerElements(){const t=document.querySelectorAll(is.containerSelector);return Array.prototype.slice.call(t)}}const ss=0,os=1,as="os_pageViews",rs="requiresPrivacyConsent";function cs(){return"true"===localStorage.getItem(rs)}function ls(){return Number(localStorage.getItem(as))}const us="onesignal-pageview-count";let hs=!1;function ds(){try{const t=sessionStorage.getItem(us),e=t?parseInt(t):0;return isNaN(e)?0:e}catch(t){return 0}}function gs(){if(hs)return;const t=ds()+1,e=ls()+1;!function(t){try{sessionStorage.setItem(us,t.toString())}catch(e){}}(t),function(t){localStorage.setItem(as,t.toString())}(e),hs=!0,kt.debug(`Incremented page view count: newCountSingleTab: ${t},\n      newCountAccrossTabs: ${e}.`)}function ps(){return 1===ds()}class ws{}const fs="NORMAL",ms="NO_PROPAGATE",bs="HYDRATE";class ys{subscribers=[];get hasSubscribers(){return this.subscribers.length>0}subscribe(t){this.subscribers.push(t)}unsubscribe(t){const e=this.subscribers.indexOf(t);-1!==e&&this.subscribers.splice(e,1)}subscribeAll(t){for(const e of t.subscribers)this.subscribe(e)}fire(t){for(const e of this.subscribers)t(e)}async suspendingFire(t){for(const e of this.subscribers)await t(e)}}class Ss{modelId;data=new Map;changeNotifier=new ys;constructor(){this.modelId=Math.random().toString(36).substring(2)}initializeFromJson(t){const{modelId:e,modelName:i,...n}=t;this.data.clear(),this.data=new Map(Object.entries(n)),e&&(this.modelId=e)}initializeFromModel(t,e){const i=new Map;e.data.forEach((t,e)=>{i.set(e,t)}),null!==t&&(this.modelId=t),this.data.clear(),this.data=i}setProperty(t,e,i=fs,n=!1){const s=this.data.get(t);(s!==e||n)&&(void 0!==e?this.data.set(t,e):this.data.has(t)&&this.data.delete(t),this.notifyChanged(t,i,s,e))}hasProperty(t){return this.data.has(t)}getProperty(t,e){return this.data.get(t)??e}notifyChanged(t,e,i,n){const s={model:this,property:t,oldValue:i,newValue:n};this.changeNotifier.fire(t=>t.onChanged(s,e))}toJSON(){return Object.fromEntries(this.data.entries())}subscribe(t){return this.changeNotifier.subscribe(t)}unsubscribe(t){this.changeNotifier.unsubscribe(t)}get hasSubscribers(){return this.changeNotifier.hasSubscribers}mergeData(t){for(const[e,i]of Object.entries(t))this.data.set(e,i)}}class vs extends Ss{get onesignalId(){return this.getProperty(it)}set onesignalId(t){this.setProperty(it,t)}get externalId(){return this.getProperty(et)}set externalId(t){this.setProperty(et,t)}}function Os(t){return void 0!==t?.type&&void 0!==t?.id}class Is extends ws{P;$;T;_;constructor(t,e,i){super(),t&&e?(this.T=!e.optedOut,this._=i,this.$=e.subscriptionToken,OneSignal.coreDirector.getPushSubscriptionModel().then(t=>{Os(t)&&(this.P=t.id)}).catch(t=>{kt.error(t)}),OneSignal.emitter.on(OneSignal.EVENTS.SUBSCRIPTION_CHANGED,async t=>{this.P=t?.current.id,this.$=t?.current.token}),OneSignal.emitter.on(OneSignal.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_STRING,async t=>{this._=t})):kt.warn(`PushSubscriptionNamespace: skipping initialization. One or more required params are falsy: initialize: ${t}, subscription: ${e}`)}get id(){return this.P}get token(){return this.$}get optedIn(){return!!this.T&&"granted"===this._}async optIn(){Ii("optIn"),await Oi(),this.T=!0;"granted"===await OneSignal.context.permissionManager.getPermissionStatus()?await this.N(!0):await OneSignal.Notifications.requestPermission()}async optOut(){Ii("optOut"),await Oi(),this.T=!1,await this.N(!1)}addEventListener(t,e){OneSignal.emitter.on(t,e)}removeEventListener(t,e){OneSignal.emitter.off(t,e)}async N(t){await Oi();const e=await Ze(),i=await ni();if(!e.appId)throw ct;if("boolean"!=typeof t)throw wt("enabled");i.optedOut=!t,await si(i),async function(t){Ki.put("subscription.optedOut",t)}(i.optedOut).catch(t=>{kt.error(t)}),Ls().catch(t=>{kt.error(t)})}}class ks extends Ss{constructor(){super(),this.sdk=M,this.device_model=z(),this.device_os=K()}get onesignalId(){return this.getProperty("onesignalId")}set onesignalId(t){this.setProperty("onesignalId",t)}get id(){return this.getProperty("id")}set id(t){this.setProperty("id",t)}get enabled(){return this.getProperty("enabled")}set enabled(t){this.setProperty("enabled",t)}get type(){return this.getProperty("type")}set type(t){this.setProperty("type",t)}get token(){return this.getProperty("token")}set token(t){this.setProperty("token",t)}get notification_types(){return this.getProperty("notification_types")}set notification_types(t){this.setProperty("notification_types",t)}get sdk(){return this.getProperty("sdk")}set sdk(t){this.setProperty("sdk",t)}get device_model(){return this.getProperty("device_model")}set device_model(t){this.setProperty("device_model",t)}get device_os(){return this.getProperty("device_os")}set device_os(t){this.setProperty("device_os",t)}get web_auth(){return this.getProperty("web_auth")}set web_auth(t){this.setProperty("web_auth",t)}get web_p256(){return this.getProperty("web_p256")}set web_p256(t){this.setProperty("web_p256",t)}}const xs={LOCAL_PREFIX:"local-",createLocalId(){return`${this.LOCAL_PREFIX}${crypto.randomUUID()}`},isLocalId(t){return t?.startsWith(this.LOCAL_PREFIX)??!1}},Cs=0,Es=1,Ps=2;class $s extends Ss{constructor(t,e,i){super(),this.name=t,e&&(this.appId=e),i&&(this.onesignalId=i)}get name(){return this.getProperty("name")}set name(t){this.setProperty("name",t)}get appId(){return this.getProperty("appId")}set appId(t){this.setProperty("appId",t)}get onesignalId(){return this.getProperty("onesignalId")}set onesignalId(t){this.setProperty("onesignalId",t)}get applyToRecordId(){return this.onesignalId}get createComparisonKey(){return""}get groupComparisonType(){return Es}get canStartExecute(){return!xs.isLocalId(this.onesignalId)}translateIds(t){t[this.onesignalId]&&(this.onesignalId=t[this.onesignalId])}toString(){return JSON.stringify(this.toJSON())}}class Ts extends $s{constructor(t,e,i,n){super(J,t,e),i&&(this.externalId=i),n&&(this.existingOnesignalId=n)}get externalId(){return this.getProperty("externalId")}set externalId(t){this.setProperty("externalId",t)}get existingOnesignalId(){return this.getProperty("existingOnesignalId")}set existingOnesignalId(t){this.setProperty("existingOnesignalId",t)}get createComparisonKey(){return`${this.appId}.User.${this.onesignalId}`}get modifyComparisonKey(){return""}get groupComparisonType(){return Cs}get canStartExecute(){return!this.existingOnesignalId||!xs.isLocalId(this.existingOnesignalId)}get applyToRecordId(){return this.existingOnesignalId??this.onesignalId}translateIds(t){this.existingOnesignalId&&t[this.existingOnesignalId]&&(this.existingOnesignalId=t[this.existingOnesignalId])}}class _s{static singletonInstance;static createOrGetInstance(){if(!_s.singletonInstance){_s.singletonInstance=new _s;const t=OneSignal.coreDirector.getIdentityModel();if(!t.onesignalId){const e=xs.createLocalId();t.setProperty(it,e,ms)}}return _s.singletonInstance}get onesignalId(){return OneSignal.coreDirector.getIdentityModel().onesignalId}validateStringLabel(t,e){if("string"!=typeof t)throw ft(e);if(!t)throw pt(e)}validateArray(t,e){if(!Array.isArray(t))throw ft(e);if(0===t.length)throw pt(e);for(const i of t)this.validateLabel(i,"label")}validateObject(t,e){if(!mt(t))throw ft(e);if(!t||0===Object.keys(t).length)throw pt(e)}validateLabel(t,e){if(this.validateStringLabel(t,e),"external_id"===t||"onesignal_id"===t)throw new Error(`"${t}" is reserved`)}updateIdentityModel(t){const e=OneSignal.coreDirector.getIdentityModel();Object.keys(t).forEach(i=>{e.setProperty(i,t[i])})}addAlias(t,e){Ii("addAlias",{label:t,id:e}),this.validateStringLabel(t,"label"),this.validateStringLabel(e,"id"),this.addAliases({[t]:e})}addAliases(t){Ii("addAliases",{aliases:t}),this.validateObject(t,"aliases");for(const e of Object.keys(t))this.validateStringLabel(t[e],`key: ${e}`),this.validateLabel(e,`key: ${e}`);this.updateIdentityModel(t)}removeAlias(t){Ii("removeAlias",{label:t}),this.removeAliases([t])}removeAliases(t){Ii("removeAliases",{aliases:t}),this.validateArray(t,"aliases");const e=Object.fromEntries(t.map(t=>[t,void 0]));this.updateIdentityModel(e)}addEmail(t){if(Ii("addEmail",{email:t}),this.validateStringLabel(t,"email"),!function(t){return!!t&&!!t.match(/^([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x22([^\x0d\x22\x5c\x80-\xff]|\x5c[\x00-\x7f])*\x22)(\x2e([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x22([^\x0d\x22\x5c\x80-\xff]|\x5c[\x00-\x7f])*\x22))*\x40([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x5b([^\x0d\x5b-\x5d\x80-\xff]|\x5c[\x00-\x7f])*\x5d)(\x2e([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x5b([^\x0d\x5b-\x5d\x80-\xff]|\x5c[\x00-\x7f])*\x5d))*$/)}(t))throw wt("email");As({type:l,token:t})}addSms(t){Ii("addSms",{sms:t}),this.validateStringLabel(t,"sms"),As({type:u,token:t})}removeEmail(t){Ii("removeEmail",{email:t}),this.validateStringLabel(t,"email");OneSignal.coreDirector.getEmailSubscriptionModels().forEach(e=>{e.token===t&&OneSignal.coreDirector.removeSubscriptionModel(e.modelId)})}removeSms(t){Ii("removeSms",{smsNumber:t}),this.validateStringLabel(t,"smsNumber");OneSignal.coreDirector.getSmsSubscriptionModels().forEach(e=>{e.token===t&&OneSignal.coreDirector.removeSubscriptionModel(e.modelId)})}addTag(t,e){Ii("addTag",{key:t,value:e}),this.validateStringLabel(t,"key"),this.validateStringLabel(e,"value"),this.addTags({[t]:e})}addTags(t){xs.isLocalId(this.onesignalId)&&kt.warn("Call after login to sync tags"),Ii("addTags",{tags:t}),this.validateObject(t,"tags");const e=OneSignal.coreDirector.getPropertiesModel(),i={...e.tags,...t};e.tags=i}removeTag(t){Ii("removeTag",{tagKey:t}),this.validateStringLabel(t,"tagKey"),this.removeTags([t])}removeTags(t){Ii("removeTags",{tagKeys:t}),this.validateArray(t,"tagKeys");const e=OneSignal.coreDirector.getPropertiesModel(),i={...e.tags};t.forEach(t=>{i[t]=""}),e.tags=i}getTags(){return Ii("getTags"),OneSignal.coreDirector.getPropertiesModel().tags}setLanguage(t){Ii("setLanguage",{language:t}),this.validateStringLabel(t,"language");OneSignal.coreDirector.getPropertiesModel().language=t}getLanguage(){return Ii("getLanguage"),OneSignal.coreDirector.getPropertiesModel().language}trackEvent(t,e={}){const i=this.onesignalId;!xs.isLocalId(i)||Ns(i)?!function(t){if(!mt(t))return!1;try{return JSON.stringify(t),!0}catch(e){return!1}}(e)?kt.error("Properties must be JSON-serializable"):(Ii("trackEvent",{name:t,properties:e}),OneSignal.coreDirector.customEventController.sendCustomEvent({name:t,properties:e})):kt.error("User must be logged in first.")}}function Ns(t){return OneSignal.coreDirector.operationRepo.queue.find(e=>e.operation instanceof Ts&&e.operation.onesignalId===t)}function As({type:t,token:e}){if(OneSignal.coreDirector.subscriptionModelStore.list().find(i=>i.token===e&&i.type===t))return;const i=OneSignal.coreDirector.getIdentityModel(),n=i.onesignalId;if(xs.isLocalId(n)){const t=Mi.getAppId();Ns(n)||OneSignal.coreDirector.operationRepo.enqueue(new Ts(t,n,i.externalId))}const s={id:xs.createLocalId(),enabled:!0,notification_types:w,onesignalId:n,token:e,type:t},o=new ks;o.mergeData(s),OneSignal.coreDirector.addSubscriptionModel(o)}class Ms extends ws{A;PushSubscription=new Is(!1);static emitter=new Ei;constructor(t,e,i){super(),t&&(this.A=_s.createOrGetInstance(),this.PushSubscription=new Is(!0,e,i))}get onesignalId(){return this.A?.onesignalId}get externalId(){const t=OneSignal.coreDirector.getIdentityModel();return t?.externalId}addAlias(t,e){this.A?.addAlias(t,e)}addAliases(t){this.A?.addAliases(t)}removeAlias(t){this.A?.removeAlias(t)}removeAliases(t){this.A?.removeAliases(t)}addEmail(t){this.A?.addEmail(t)}removeEmail(t){this.A?.removeEmail(t)}addSms(t){this.A?.addSms(t)}removeSms(t){this.A?.removeSms(t)}addTag(t,e){this.A?.addTag(t,e)}addTags(t){this.A?.addTags(t)}removeTag(t){this.A?.removeTag(t)}removeTags(t){this.A?.removeTags(t)}getTags(){return this.A?.getTags()||{}}setLanguage(t){this.A?.setLanguage(t)}getLanguage(){return this.A?.getLanguage()||""}trackEvent(t,e){return this.A?.trackEvent(t,e)}addEventListener(t,e){Ms.emitter.on(t,e)}removeEventListener(t,e){Ms.emitter.off(t,e)}}class Ds{previousOneSignalId;previousExternalId}function Us(t,e){return t?t.filter(t=>t.type===e)[0]:void 0}function Bs(t){return t===jt||t===Kt}async function Ls(){Ii("checkAndTriggerSubscriptionChanged");const t=OneSignal.context,e=await OneSignal.context.subscriptionManager.isPushNotificationsEnabled(),i=await OneSignal.context.subscriptionManager.isOptedIn(),n=await Xe(),{lastKnownPushEnabled:s,lastKnownPushId:o,lastKnownPushToken:a,lastKnownOptedIn:r}=n,c=await Mi.getCurrentPushToken(),l=await OneSignal.coreDirector.getPushSubscriptionModel(),u=l?.id;if(!(e!==s||c!==a||u!==o))return;await t.subscriptionManager.updateNotificationTypes(),n.lastKnownPushEnabled=e,n.lastKnownPushToken=c,n.lastKnownPushId=u,n.lastKnownOptedIn=i,await ti(n);const h={previous:{id:o,token:a,optedIn:r??!0},current:{id:u,token:c,optedIn:i}};kt.info("Push Subscription state changed: ",h),function(t){$i.trigger(OneSignal.EVENTS.SUBSCRIPTION_CHANGED,t)}(h)}async function Rs(){Ii("checkAndTriggerUserChanged");const t=await(async()=>{const t=new Ds;return t.previousOneSignalId="",t.previousExternalId="",t.previousOneSignalId=await Je("previousOneSignalId"),t.previousExternalId=await Je("previousExternalId"),t})(),{previousOneSignalId:e,previousExternalId:i}=t,n=await OneSignal.coreDirector.getIdentityModel(),s=n?.onesignalId,o=n?.externalId;if(!(s!==e||o!==i))return;t.previousOneSignalId=s,t.previousExternalId=o,await(async t=>{await Ge.put("Options",{key:"previousOneSignalId",value:t.previousOneSignalId}),await Ge.put("Options",{key:"previousExternalId",value:t.previousExternalId})})(t);const a={current:{onesignalId:s,externalId:o}};kt.info("User state changed: ",a),function(t){$i.trigger(OneSignal.EVENTS.SUBSCRIPTION_CHANGED,t,Ms.emitter)}(a)}async function Ws(t){if(!0!==t)return;const e=OneSignal.context.appConfig.userConfig.promptOptions?.slidedown?.prompts;(function(t){if(!t)return!1;const e=Us(t,Kt);return!!e&&!!e.categories&&e.categories.length>0})(e)&&await OneSignal.context.tagManager.sendTags()}function Fs(t){!async function(t,e){if(OneSignal.S)return void kt.debug("Not showing welcome notification because user has previously subscribed.");const i=OneSignal.config?.userConfig.welcomeNotification;if(void 0!==i&&!0===i.disable)return;if(!0!==t)return;if(!e)return;let n=void 0!==i&&void 0!==i.title&&null!==i.title?i.title:"",s=void 0!==i&&void 0!==i.message&&null!==i.message&&i.message.length>0?i.message:"Thanks for subscribing!";const o=new URL(location.href).origin+"?_osp=do_not_open",a=i&&i.url&&i.url.length>0?i.url:o;n=hi(n),s=hi(s),kt.debug("Sending welcome notification."),Mi.showLocalNotification(n,s,a,void 0,{M:!0},void 0),$i.trigger(OneSignal.EVENTS.WELCOME_NOTIFICATION_SENT,{title:n,message:s,url:a})}(t?.current?.optedIn,t?.current?.id),Ws(t?.current?.optedIn),async function(){if(!OneSignal.config?.userConfig.notifyButton)return;const t=OneSignal.config.userConfig.notifyButton.displayPredicate;t&&"function"==typeof t&&OneSignal.notifyButton&&(!1!==await t()?(kt.debug("Showing notify button because display predicate returned true."),OneSignal.notifyButton.launcher.show()):(kt.debug("Hiding notify button because display predicate returned false."),OneSignal.notifyButton.launcher.hide()))}(),OneSignal.config?.userConfig.promptOptions&&new ns(OneSignal.config?.userConfig.promptOptions.customlink).initialize()}class js{static async registerForPush(){return await js.internalRegisterForPush()}static async internalRegisterForPush(){const t=OneSignal.context;let e=null;try{const i=await t.subscriptionManager.subscribe(ss);e=await t.subscriptionManager.registerSubscription(i),gs(),await _i(),await Ls()}catch(i){kt.error(i)}return e}static isPushSubscriptionType(t){switch(t){case c:case h:case d:case g:return!0;default:return!1}}static toSubscriptionChannel(t){switch(t){case l:return o;case u:return a;default:return this.isPushSubscriptionType(t)?r:void 0}}}async function Ks(){kt.debug("Called internalInit()"),await OneSignal.context.serviceWorkerManager.installWorker();const t=OneSignal.context.sessionManager;OneSignal.emitter.on(OneSignal.EVENTS.SESSION_STARTED,t.sendOnSessionUpdateFromPage.bind(t)),gs(),"visible"===document.visibilityState?await zs():ki(document,"visibilitychange",(t,e)=>{"visible"===document.visibilityState&&(e(),zs())},!0)}async function zs(){if(kt.debug("Called sessionInit()"),OneSignal.D)return void kt.debug("Returning from sessionInit because it has already been called.");OneSignal.D=!0;try{await async function(){const t=[];t.push(async function(){const t=await OneSignal.context.subscriptionManager.isPushNotificationsEnabled(),e=await OneSignal.context.permissionManager.getPermissionStatus(),i=await OneSignal.context.subscriptionManager.isOptedOut();Ki.put("subscription.optedOut",i),await Ge.put("Options",{key:"isPushEnabled",value:t}),await Ge.put("Options",{key:"notificationPermission",value:e})}()),t.push(async function(){try{if(navigator.permissions){(await navigator.permissions.query({name:"notifications"})).onchange=function(){_i()}}}catch(t){kt.warn(`Could not install native notification permission change hook w/ error: ${t}`)}}()),t.push(async function(){"granted"===await OneSignal.context.permissionManager.getNotificationPermission(OneSignal.context.appConfig.safariWebId)&&(OneSignal.S=!0)}()),t.push(async function(){if(navigator.serviceWorker&&window.isSecureContext)try{await OneSignal.context.serviceWorkerManager.establishServiceWorkerChannel()}catch(t){kt.error(t)}}()),t.push(async function(){if(!OneSignal.notifyButton){OneSignal.config.userConfig.notifyButton=OneSignal.config.userConfig.notifyButton||{},OneSignal.config.userConfig.bell&&(OneSignal.config.userConfig.bell={...OneSignal.config.userConfig.bell,...OneSignal.config.userConfig.notifyButton},OneSignal.config.userConfig.notifyButton={...OneSignal.config.userConfig.notifyButton,...OneSignal.config.userConfig.bell});const t=OneSignal.config.userConfig.notifyButton.displayPredicate;t&&"function"==typeof t?OneSignal.emitter.once(OneSignal.EVENTS.SDK_INITIALIZED,async()=>{!1!==await Promise.resolve(OneSignal.config.userConfig.notifyButton.displayPredicate?.())?(OneSignal.notifyButton=new Ji(OneSignal.config.userConfig.notifyButton),OneSignal.notifyButton.create()):kt.debug("Notify button display predicate returned false so not showing the notify button.")}):(OneSignal.notifyButton=new Ji(OneSignal.config.userConfig.notifyButton),OneSignal.notifyButton.create())}}()),t.push(async function(){const t=OneSignal.config;t.userConfig.promptOptions&&await new ns(t.userConfig.promptOptions.customlink).initialize()}());try{await Promise.all(t)}catch(e){throw kt.error(e),new Error("Unknown init error")}}()}catch(n){if(n instanceof Error)return;throw n}const t=await OneSignal.context.subscriptionManager.isOptedOut()??!1,e=await ni();e.optedOut=t,await si(e),await async function(t){if(kt.info("handleAutoResubscribe",{autoResubscribe:OneSignal.config?.userConfig.autoResubscribe,isOptedOut:t}),OneSignal.config?.userConfig.autoResubscribe&&!t){"granted"==await OneSignal.context.permissionManager.getNotificationPermission(OneSignal.context.appConfig.safariWebId)&&await js.registerForPush()}}(t);const i=await OneSignal.context.subscriptionManager.isPushNotificationsEnabled();await Ge.put("Options",{key:"isPushEnabled",value:!!i}),OneSignal.config?.userConfig.promptOptions?.autoPrompt&&!t&&OneSignal.context.promptsManager.spawnAutoPrompts(),OneSignal.D=!1,await $i.trigger(OneSignal.EVENTS.SDK_INITIALIZED)}async function Hs(){await js.registerForPush()}async function Vs(){const t=await async function(){const t=OneSignal.context;kt.debug("Checking subscription expiration...");if(!(await t.subscriptionManager.isSubscriptionExpiring()))return kt.debug("Subscription is not considered expired."),!1;kt.debug("Subscription is considered expiring.");const e=await t.subscriptionManager.subscribe(os);return await t.subscriptionManager.registerSubscription(e),!0}();await OneSignal.context.subscriptionManager.isAlreadyRegisteredWithOneSignal()?(OneSignal.context.sessionManager.setupSessionEventListeners(),t||await OneSignal.context.updateManager.sendOnSessionUpdate()):OneSignal.config?.userConfig.promptOptions?.autoPrompt||OneSignal.config?.userConfig.autoResubscribe||await OneSignal.context.updateManager.sendOnSessionUpdate(),await $i.trigger(OneSignal.EVENTS.SDK_INITIALIZED_PUBLIC)}class qs{modelName;changeSubscription=new ys;models=[];hasLoadedFromCache=!1;constructor(t){this.modelName=t}add(t,e=fs){const i=this.models.find(e=>e.modelId===t.modelId);i&&this.removeItem(i,e),this.addItem(t,e)}addAt(t,e,i=fs){const n=this.models.find(t=>t.modelId===e.modelId);n&&this.removeItem(n,i),this.addItem(e,i,t)}list(){return this.models}get(t){return this.models.find(e=>e.modelId===t)}remove(t,e=fs){const i=this.models.find(e=>e.modelId===t);i&&this.removeItem(i,e)}onChanged(t,e){this.persist(),this.changeSubscription.fire(i=>i.onModelUpdated(t,e))}replaceAll(t,e=fs){this.clear(e);for(const i of t)this.add(i,e)}clear(t=fs){for(const e of this.models)e.unsubscribe(this),this.changeSubscription.fire(i=>i.onModelRemoved(e,t)),Ge.delete(this.modelName,e.modelId);this.models=[]}addItem(t,e,i){void 0!==i?this.models.splice(i,0,t):this.models.push(t),t.subscribe(this),this.persist(),this.changeSubscription.fire(i=>i.onModelAdded(t,e))}async removeItem(t,e){const i=this.models.findIndex(e=>e.modelId===t.modelId);-1!==i&&this.models.splice(i,1),t.unsubscribe(this),await Ge.delete(this.modelName,t.modelId),this.persist(),this.changeSubscription.fire(i=>i.onModelRemoved(t,e))}async load(){if(!this.modelName)return;const t=await Ge.getAll(this.modelName),e=this.models.length>0;for(let i=t.length-1;i>=0;i--){const e=this.create(t[i]);e&&(this.models.unshift(e),e.subscribe(this))}this.hasLoadedFromCache=!0,e&&this.persist()}async persist(){if(this.modelName&&this.hasLoadedFromCache)for(const t of this.models)await Ge.put(this.modelName,{modelId:t.modelId,modelName:this.modelName,...t.toJSON()})}subscribe(t){this.changeSubscription.subscribe(t)}unsubscribe(t){this.changeSubscription.unsubscribe(t)}get hasSubscribers(){return this.changeSubscription.hasSubscribers}}class Gs extends qs{U;constructor(t,e){super(e),this.U=t,this.load()}create(t){const e=this.U();return null!=t&&e.initializeFromJson(t),e}}class Js{store;changeSubscription=new ys;constructor(t){this.store=t,t.subscribe(this)}get model(){const t=this.store.list()[0];if(t)return t;const e=this.store.create();if(!e)throw new Error(`Unable to initialize model from store ${this.store}`);return this.store.add(e),e}replace(t,e){const i=this.model;i.initializeFromModel(i.modelId,t),this.store.persist(),this.changeSubscription.fire(t=>t.onModelReplaced(i,e))}subscribe(t){this.changeSubscription.subscribe(t)}unsubscribe(t){this.changeSubscription.unsubscribe(t)}get hasSubscribers(){return this.changeSubscription.hasSubscribers}onModelAdded(){}onModelUpdated(t,e){this.changeSubscription.fire(i=>i.onModelUpdated(t,e))}onModelRemoved(){}}class Ys extends Js{constructor(){super(new Gs(()=>new vs,"identity"))}}class Qs extends $s{constructor(t){super(tt,t?.appId,t?.onesignalId),t?.externalId&&(this.externalId=t.externalId),t?.timestamp&&(this.timestamp=t.timestamp),t?.event&&(this.event=t.event)}get externalId(){return this.getProperty("externalId")}set externalId(t){this.setProperty("externalId",t)}get timestamp(){return this.getProperty("timestamp")}set timestamp(t){this.setProperty("timestamp",t)}get event(){return this.getProperty("event")}set event(t){this.setProperty("event",t)}get key(){return`${this.appId}.User.${this.onesignalId}.CustomEvent.${this.event.name}`}get createComparisonKey(){return this.key}get modifyComparisonKey(){return this.key}get groupComparisonType(){return Ps}get canStartExecute(){return!xs.isLocalId(this.onesignalId)}get applyToRecordId(){return this.onesignalId}translateIds(t){t[this.onesignalId]&&(this.onesignalId=t[this.onesignalId])}}class Zs{B;L;constructor(t,e){this.B=t,this.L=e}sendCustomEvent(t){const e=Mi.getAppId(),i=this.B.model,n=new Qs({appId:e,onesignalId:i.onesignalId,externalId:i.externalId,timestamp:(new Date).toISOString(),event:t});this.L.enqueue(n)}}const Xs=0,to=1,eo=2,io=3,no=4;function so(t){switch(t){case 400:case 402:return Xs;case 401:case 403:return eo;case 404:case 410:return io;case 409:return no;default:return to}}class oo{result;idTranslations;operations;retryAfterSeconds;constructor(t,e,i,n){this.result=t,this.retryAfterSeconds=e,this.operations=i,this.idTranslations=n}}const ao=0,ro=1,co=2,lo=3,uo=4,ho=5,go=6;class po{get operations(){return[tt]}get eventMetadata(){return{sdk:M,device_model:z(),device_os:K(),type:j()}}async execute(t){kt.debug(`CustomEventsOperationExecutor(operations: ${JSON.stringify(t)})`);const e=t[0];if(!(e instanceof Qs))throw new Error(`Unrecognized operation! Expected TrackEventOperation, got: ${e.constructor.name}`);const i=await async function(t,e){const{appId:i}=t;return Ct.post(`apps/${i}/custom_events`,{events:[e]},t.jwtHeader)}({appId:e.appId},{name:e.event.name,onesignal_id:e.onesignalId,external_id:e.externalId,timestamp:e.timestamp,payload:{...e.event.properties??{},os_sdk:this.eventMetadata}}),{ok:n,status:s}=i,o=so(s);return new oo(n?ao:o===to?co:lo)}}class wo{R=new Map;get records(){return this.R}add(t){this.R.set(t,Date.now())}canAccess(t){if(!t)return!0;const e=this.R.get(t);return!e||Date.now()-e>=500}isInMissingRetryWindow(t){const e=this.R.get(t);return!!e&&Date.now()-e<=15e3}}class fo extends $s{constructor(t,e,i,n){super(t,e,i),n&&(this.label=n)}get label(){return this.getProperty("label")}set label(t){this.setProperty("label",t)}}class mo extends fo{constructor(t,e,i){super(V,t,e,i)}get modifyComparisonKey(){return`${this.appId}.User.${this.onesignalId}.Alias.${this.label}`}get groupComparisonType(){return Ps}}class bo extends fo{constructor(t,e,i,n){super(H,t,e,i),n&&(this.value=n)}get value(){return this.getProperty("value")}set value(t){this.setProperty("value",t)}get modifyComparisonKey(){return`${this.appId}.User.${this.onesignalId}.Identity.${this.label}`}}class yo{B;W;F;constructor(t,e,i){this.B=t,this.W=e,this.F=i}get operations(){return[H,V]}async execute(t){kt.debug(`IdentityOperationExecutor(operations: ${JSON.stringify(t)})`);if(t.filter(t=>!(t instanceof bo||t instanceof mo)).length>0)throw new Error(`Unrecognized operation(s)! Attempted operations:\n${JSON.stringify(t)}`);const e=t.some(t=>t instanceof bo),i=t.some(t=>t instanceof mo);if(e&&i)throw new Error("Can't process SetAliasOperation and DeleteAliasOperation at the same time.");const n=t[t.length-1],s=n instanceof bo,o=s?async function(t,e,i){const{appId:n}=t;return Ct.patch(`apps/${n}/users/by/${e.label}/${e.id}/identity`,{identity:i},t.jwtHeader)}({appId:n.appId},{label:it,id:n.onesignalId},{[n.label]:n.value}):async function(t,e,i){const{appId:n}=t;return Ct.delete(`apps/${n}/users/by/${e.label}/${e.id}/identity/${i}`,t.jwtHeader)}({appId:n.appId},{label:it,id:n.onesignalId},n.label),{ok:a,status:r,retryAfterSeconds:c}=await o;if(a)return this.B.model.onesignalId===n.onesignalId&&this.B.model.setProperty(n.label,s?n.value:void 0,bs),new oo(ao);switch(so(r)){case to:return new oo(co,c);case Xs:return new oo(lo);case no:return s?new oo(ho,c):new oo(ao);case eo:return new oo(uo,c);case io:if(404===r&&this.F.isInMissingRetryWindow(n.onesignalId))return new oo(co,c);if(s){const t=await this.W.getRebuildOperationsIfCurrentUser(n.appId,n.onesignalId);return null==t?new oo(lo):new oo(co,c,t)}return new oo(ao)}}}class So extends Ss{constructor(){super()}get onesignalId(){return this.getProperty("onesignalId")}set onesignalId(t){this.setProperty("onesignalId",t)}get ip(){return this.getProperty("ip")}set ip(t){this.setProperty("ip",t)}get country(){return this.getProperty("country")}set country(t){this.setProperty("country",t)}get language(){return this.getProperty("language")}set language(t){this.setProperty("language",t)}get timezone_id(){return this.getProperty("timezone_id")}set timezone_id(t){this.setProperty("timezone_id",t)}get tags(){return this.getProperty("tags")??{}}set tags(t){this.setProperty("tags",t)}}class vo extends Js{constructor(){super(new Gs(()=>new So,"properties"))}}class Oo extends Gs{constructor(){super(()=>new ks,"subscriptions")}getBySubscriptionId(t){return super.list().find(e=>e.id===t)}replaceAll(t,e){if(e!==bs)return super.replaceAll(t,e);for(const i of t)if(js.isPushSubscriptionType(i.type)){const t=this.get(i.modelId);t&&(i.sdk=t.sdk,i.device_os=t.device_os);break}super.replaceAll(t,e)}}class Io extends $s{constructor(t,e,i,n){super(t,e,i),n&&(this.subscriptionId=n)}get subscriptionId(){return this.getProperty("subscriptionId")}set subscriptionId(t){this.setProperty("subscriptionId",t)}get createComparisonKey(){return`${this.appId}.User.${this.onesignalId}`}get modifyComparisonKey(){return`${this.appId}.User.${this.onesignalId}.Subscription.${this.subscriptionId}`}get canStartExecute(){return!xs.isLocalId(this.onesignalId)&&!xs.isLocalId(this.subscriptionId)}get applyToRecordId(){return this.subscriptionId}translateIds(t){super.translateIds(t),t[this.subscriptionId]&&(this.subscriptionId=t[this.subscriptionId])}}class ko extends Io{constructor(t,e,i,n){super(t,e,i),n&&(this.sdk=M,this.device_model=z(),this.device_os=K(),this.enabled=n.enabled,this.notification_types=n.notification_types,this.subscriptionId=n.subscriptionId,this.token=n.token,this.type=n.type,this.web_auth=n.web_auth,this.web_p256=n.web_p256)}get type(){return this.getProperty("type")}set type(t){this.setProperty("type",t)}get token(){return this.getProperty("token")}set token(t){this.setProperty("token",t)}get enabled(){return this.getProperty("enabled")}set enabled(t){this.setProperty("enabled",t)}get notification_types(){return this.getProperty("notification_types")}set notification_types(t){this.setProperty("notification_types",t)}get sdk(){return this.getProperty("sdk")}set sdk(t){this.setProperty("sdk",t)}get device_model(){return this.getProperty("device_model")}set device_model(t){this.setProperty("device_model",t)}get device_os(){return this.getProperty("device_os")}set device_os(t){this.setProperty("device_os",t)}get web_auth(){return this.getProperty("web_auth")}set web_auth(t){this.setProperty("web_auth",t)}get web_p256(){return this.getProperty("web_p256")}set web_p256(t){this.setProperty("web_p256",t)}}class xo extends ko{constructor(t){super(Y,t?.appId,t?.onesignalId,t)}get canStartExecute(){return!xs.isLocalId(this.onesignalId)}get applyToRecordId(){return this.onesignalId}translateIds(t){t[this.onesignalId]&&(this.onesignalId=t[this.onesignalId])}}class Co extends Io{constructor(t,e,i){super(Z,t,e),i&&(this.subscriptionId=i)}get groupComparisonType(){return Ps}}class Eo extends $s{constructor(t,e){super(G,t,e)}get createComparisonKey(){return`${this.appId}.User.${this.onesignalId}.Refresh`}get modifyComparisonKey(){return`${this.appId}.User.${this.onesignalId}.Refresh`}get groupComparisonType(){return Cs}}class Po extends Io{constructor(t,e,i){super(X,t,e),i&&(this.subscriptionId=i)}get groupComparisonType(){return Ps}get modifyComparisonKey(){return`${this.appId}.Subscription.${this.subscriptionId}.Transfer`}}class $o extends ko{constructor(t){super(Q,t?.appId,t?.onesignalId,t)}}class To{j;B;K;H;constructor(t,e,i,n){this.j=t,this.B=e,this.K=i,this.H=n}get operations(){return[J]}async execute(t){kt.debug(`LoginUserOperationExecutor(operation: ${JSON.stringify(t)})`);const e=t[0];if(e instanceof Ts)return this.loginUser(e,t.slice(1));throw new Error(`Unrecognized operation: ${e.name}`)}async loginUser(t,e){const i=cs(),n=await ei();if(i&&!n)throw new Error("Consent required but not given");if(!t.existingOnesignalId||!t.externalId)return this.createUser(t,e);const s=await this.j.execute([new bo(t.appId,t.existingOnesignalId,et,t.externalId)]);switch(s.result){case ao:{const e=t.existingOnesignalId,i=t.onesignalId;return this.B.model.onesignalId===i&&this.B.model.setProperty(it,e,bs),this.K.model.onesignalId===i&&this.K.model.setProperty("onesignalId",e,bs),new oo(ro,void 0,void 0,{[t.onesignalId]:e})}case ho:return kt.debug(`Handling 409 for externalId: ${t.externalId}`),this.createUser(t,e);case lo:return kt.error(`Recovering from SetAlias failure for externalId: ${t.externalId}`),this.createUser(t,e);default:return new oo(s.result)}}async createUser(t,e){const i={};let n={};const s={timezone_id:Intl.DateTimeFormat().resolvedOptions().timeZone,language:Ao()};t.externalId&&(i[et]=t.externalId);for(const l of e){if(!(l instanceof xo||l instanceof Po||l instanceof $o||l instanceof Co))throw new Error(`Unrecognized operation: ${l.name}`);n=this.createSubscriptionsFromOperation(l,n)}const o=Object.entries(n),a=await async function(t,e){const{appId:i,subscriptionId:n}=t,s=n?{"OneSignal-Subscription-Id":n}:void 0;let o={};return s&&(o={...o,...s}),t.jwtHeader&&(o={...o,...t.jwtHeader}),e.refresh_device_metadata=!0,Ct.post(`apps/${i}/users`,e,o)}({appId:t.appId},{identity:i,subscriptions:o.map(([,t])=>t),properties:s});if(a.ok){const e=a.result.identity.onesignal_id,n=t.onesignalId,s={[t.onesignalId]:e};this.B.model.onesignalId===n&&this.B.model.setProperty(it,e,bs),this.K.model.onesignalId===n&&this.K.model.setProperty("onesignalId",e,bs);const r=a.result.properties;if(r)for(const[t,i]of Object.entries(r))this.K.model.setProperty(t,i,bs);for(let t=0;t<o.length;t++){const[i]=o[t],n=a.result.subscriptions?.[t];if(!n||!("id"in n))continue;s[i]=n.id;const r=this.H.getBySubscriptionId(i);r?.setProperty("id",n.id,bs),r?.setProperty("onesignalId",e,bs)}Rs();const c=Object.keys(i).length>0?[new Eo(t.appId,e)]:void 0;return new oo(ao,void 0,c,s)}const{status:r,retryAfterSeconds:c}=a;switch(so(r)){case to:return new oo(co,c);case eo:return new oo(uo,c);default:return new oo(go)}}createSubscriptionsFromOperation(t,e){switch(!0){case t instanceof xo:{const i=t.subscriptionId;return{...e,[i]:{enabled:t.enabled,device_model:t.device_model,device_os:t.device_os,notification_types:t.notification_types,sdk:t.sdk,token:t.token,type:t.type,web_auth:t.web_auth,web_p256:t.web_p256}}}case t instanceof $o:{const i=t.subscriptionId;return e[i]?{...e,[i]:{...e[i],enabled:t.enabled,notification_types:t.notification_types,token:t.token}}:e}case t instanceof Po:{const i=t.subscriptionId;return{...e,[i]:{...e[i],id:i}}}case t instanceof Co:{const i={...e};return delete i[t.subscriptionId],i}default:return e}}}const _o=["tw","hant"],No=["cn","hans"],Ao=()=>{let t=navigator.language;if(t){t=t.toLowerCase();const e=t.split("-");if("zh"==e[0]){for(const t of _o)if(-1!==e.indexOf(t))return"zh-Hant";for(const t of No)if(-1!==e.indexOf(t))return"zh-Hans";return"zh-Hant"}return e[0].substring(0,2)}return"en"};class Mo{B;K;H;W;F;constructor(t,e,i,n,s){this.B=t,this.K=e,this.H=i,this.W=n,this.F=s}get operations(){return[G]}async execute(t){if(kt.debug(`RefreshUserOperationExecutor(operation: ${JSON.stringify(t)})`),t.some(t=>!(t instanceof Eo)))throw new Error(`Unrecognized operation(s)! Attempted operations:\n${JSON.stringify(t)}`);const e=t[0];return this.getUser(e)}async getUser(t){const e=await async function(t,e){const{appId:i}=t;return Ct.get(`apps/${i}/users/by/${e.label}/${e.id}`,t.jwtHeader)}({appId:t.appId},{label:it,id:t.onesignalId}),{ok:i,result:n,retryAfterSeconds:s,status:o}=e;if(i){if(t.onesignalId!==this.B.model.onesignalId)return new oo(ao);const e=new vs;for(const[t,c]of Object.entries(n.identity))e.setProperty(t,c);const i=new So;i.onesignalId=t.onesignalId;const{properties:s={},subscriptions:o=[]}=n;Object.entries(s).forEach(([t,e])=>{i.setProperty(t,e)});const a=[];for(const n of o){const e=new ks;e.id=n.id,e.token=n.token??"",e.notification_types=n.notification_types??w,e.type=n.type,e.enabled=e.notification_types!==f,e.sdk=n.sdk,e.device_os=n.device_os,e.device_model=n.device_model,e.onesignalId=t.onesignalId,js.isPushSubscriptionType(e.type)||a.push(e)}const r=await OneSignal.coreDirector.getPushSubscriptionModel();return r&&(r.onesignalId=t.onesignalId,a.push(r)),this.B.replace(e,bs),this.K.replace(i,bs),this.H.replaceAll(a,bs),new oo(ao)}switch(so(o)){case to:return new oo(co,s);case eo:return new oo(uo,s);case io:{if(404===o&&this.F.isInMissingRetryWindow(t.onesignalId))return new oo(co,s);const e=await this.W.getRebuildOperationsIfCurrentUser(t.appId,t.onesignalId);return e?new oo(co,s,e):new oo(lo)}default:return new oo(lo)}}}class Do{V;W;F;constructor(t,e,i){this.V=t,this.W=e,this.F=i}get operations(){return[Y,Q,Z,X]}async execute(t){kt.debug(`SubscriptionOperationExecutor(operations: ${t})`);const e=t[0];if(e instanceof xo)return this.createSubscription(e,t);if(t.some(t=>t instanceof Co)){if(t.length>1)throw new Error(`Only supports one operation! Attempted operations:\n${t}`);return this.deleteSubscription(t[0])}if(e instanceof $o)return this.updateSubscription(t);if(e instanceof Po){if(t.length>1)throw new Error(`TransferSubscriptionOperation only supports one operation! Attempted operations:\n${t}`);return this.transferSubscription(e)}throw new Error(`Unrecognized operation: ${e}`)}async createSubscription(t,e){if(e.some(t=>t instanceof Co))return new oo(ao);const i=e.toReversed().find(t=>t instanceof $o),n=i?.enabled??t.enabled,s=i?.token??t.token,o=i?.notification_types??t.notification_types,a={sdk:t.sdk,type:t.type,enabled:n,token:s,notification_types:o},r=await async function(t,e,i){const{appId:n}=t;return Ct.post(`apps/${n}/users/by/${e.label}/${e.id}/subscriptions`,i,t.jwtHeader)}({appId:t.appId},{label:it,id:t.onesignalId},{subscription:a});if(r.ok){const{subscription:e}=r.result,i=this.V.getBySubscriptionId(t.subscriptionId),n=e?.id;return n&&(i?.setProperty("id",n,bs),i?.setProperty("onesignalId",t.onesignalId,bs)),new oo(ao,void 0,n?void 0:[new Eo(t.appId,t.onesignalId)],n?{[t.subscriptionId]:n}:void 0)}const{retryAfterSeconds:c,status:l}=r;switch(so(l)){case to:return new oo(co,c);case eo:return new oo(uo,c);case no:case Xs:return new oo(lo);case io:{if(404===l&&this.F.isInMissingRetryWindow(t.onesignalId))return new oo(co,c);const e=await this.W.getRebuildOperationsIfCurrentUser(t.appId,t.onesignalId);return e?new oo(co,c,e):new oo(lo)}}}async updateSubscription(t){const e=t[t.length-1],i={type:e.type,enabled:e.enabled,token:e.token,notification_types:e.notification_types,web_auth:e.web_auth,web_p256:e.web_p256},n=await async function(t,e,i){const{appId:n}=t;return Ct.patch(`apps/${n}/subscriptions/${e}`,{subscription:i})}({appId:e.appId},e.subscriptionId,i);if(n.ok)return new oo(ao);const{retryAfterSeconds:s,status:o}=n;switch(so(o)){case to:return new oo(co,s);case io:return 404===o&&[e.onesignalId,e.subscriptionId].some(t=>this.F.isInMissingRetryWindow(t))?new oo(co,s):new oo(lo,void 0,[new xo({appId:e.appId,enabled:e.enabled,notification_types:e.notification_types,onesignalId:e.onesignalId,subscriptionId:e.subscriptionId,token:e.token,type:e.type})]);default:return new oo(lo)}}async transferSubscription(t){const e=await async function(t,e,i,n){const{appId:s}=t;return Ct.patch(`apps/${s}/subscriptions/${e}/owner`,{identity:{...i},retain_previous_owner:n},t.jwtHeader)}({appId:t.appId},t.subscriptionId,{onesignal_id:t.onesignalId},!1);if(e.ok)return new oo(ao);const{retryAfterSeconds:i,status:n}=e;return so(n)===to?new oo(co,i):new oo(lo)}async deleteSubscription(t){const e=await async function(t,e){const{appId:i}=t;return Ct.delete(`apps/${i}/subscriptions/${e}`)}({appId:t.appId},t.subscriptionId);if(e.ok)return this.V.remove(t.subscriptionId,bs),new oo(ao);const{retryAfterSeconds:i,status:n}=e;switch(so(n)){case io:return[t.onesignalId,t.subscriptionId].some(t=>this.F.isInMissingRetryWindow(t))?new oo(co,i):new oo(ao);case to:return new oo(co,i);default:return new oo(lo)}}}class Uo{ip;tags;language;timezone_id;country;constructor(t={}){this.ip=t.ip,this.tags=t.tags,this.language=t.language,this.timezone_id=t.timezone_id,this.country=t.country}get hasAtLeastOnePropertySet(){return Object.values(this).some(t=>void 0!==t)}}class Bo extends $s{constructor(t,e,i,n){super(q,t,e),i&&n&&(this.property=i,this.value=n)}get property(){return this.getProperty("property")}set property(t){this.setProperty("property",t)}get value(){return this.getProperty("value")}set value(t){this.setProperty("value",t)}get modifyComparisonKey(){return`${this.appId}.User.${this.onesignalId}`}}class Lo{static createPropertiesFromOperation(t,e){if(t instanceof Bo){const i=t.property;return Object.keys(e).includes(i)?new Uo({...e,[i]:t.value}):new Uo({...e})}throw new Error(`Unsupported operation type: ${t.name}`)}}class Ro{B;K;W;F;constructor(t,e,i,n){this.B=t,this.K=e,this.W=i,this.F=n}get operations(){return[q]}processOperations(t){let e=null,i=null,n=new Uo;for(const s of t){if(!(s instanceof Bo))throw new Error(`Unrecognized operation: ${s}`);e||(e=s.appId,i=s.onesignalId),n=Lo.createPropertiesFromOperation(s,n)}return{appId:e,onesignalId:i,propertiesObject:n,refreshDeviceMetadata:!1}}async execute(t){kt.debug(`UpdateUserOperationExecutor(operation: ${t})`);const{appId:e,onesignalId:i,propertiesObject:n,refreshDeviceMetadata:s}=this.processOperations(t);if(!e||!i)return new oo(ao);const o=await Pt({appId:e},{label:it,id:i},{properties:n,refresh_device_metadata:s}),{ok:a,retryAfterSeconds:r,status:c}=o,l=t=>"tags"===t.property;if(a){if(this.B.model.onesignalId===i)for(const e of t)if(e instanceof Bo){let t=e.value;if(l(e)){t={...e.value};for(const e in t)""===t[e]&&delete t[e]}this.K.model.setProperty(e.property,t,bs)}return new oo(ao)}switch(so(c)){case to:return new oo(co,r);case eo:return new oo(uo,r);case io:{if(404===c&&this.F.isInMissingRetryWindow(i))return new oo(co,r);const t=await this.W.getRebuildOperationsIfCurrentUser(e,i);return t?new oo(co,r,t):new oo(lo)}default:return new oo(lo)}}}class Wo{store;opRepo;constructor(t,e){this.store=t,this.opRepo=e,this.store.subscribe(this)}onModelReplaced(t,e){if(e!==fs)return;const i=this.getReplaceOperation(t);null!=i&&this.opRepo.enqueue(i)}onModelUpdated(t,e){if(e!==fs)return;const i=this.getUpdateOperation(t.model,t.property,t.oldValue,t.newValue);null!=i&&this.opRepo.enqueue(i)}}class Fo extends Wo{constructor(t,e){super(t,e)}getReplaceOperation(t){return null}getUpdateOperation(t,e,i,n){const s=Mi.getAppId();return null!=n&&"string"==typeof n?new bo(s,t.onesignalId,e,n):new mo(s,t.onesignalId,e)}}class jo{store;opRepo;constructor(t,e){this.store=t,this.opRepo=e,this.store.subscribe(this)}close(){this.store.unsubscribe(this)}onModelAdded(t,e){if(e!==fs)return;const i=this.getAddOperation(t);null!=i&&this.opRepo.enqueue(i)}async onModelUpdated(t,e){if(e!==fs)return;const i=await this.getUpdateOperation(t.model,t.property,t.oldValue,t.newValue);null!=i&&this.opRepo.enqueue(i)}async onModelRemoved(t,e){if(e!==fs)return;const i=await this.getRemoveOperation(t);null!=i&&this.opRepo.enqueue(i)}}class Ko extends Wo{constructor(t,e){super(t,e)}getReplaceOperation(t){return null}getUpdateOperation(t,e,i,n){const s=Mi.getAppId();return new Bo(s,t.onesignalId,e,n)}}class zo extends jo{B;constructor(t,e,i){super(t,e),this.B=i}getAddOperation(t){const{enabled:e,notification_types:i}=zo.getSubscriptionEnabledAndStatus(t),n=Mi.getAppId();return new xo({appId:n,onesignalId:this.B.model.onesignalId,subscriptionId:t.id,type:t.type,enabled:e,token:t.token,notification_types:i})}getRemoveOperation(t){const e=Mi.getAppId();return new Co(e,this.B.model.onesignalId,t.id)}getUpdateOperation(t){const{enabled:e,notification_types:i}=zo.getSubscriptionEnabledAndStatus(t),n=Mi.getAppId();return new $o({appId:n,onesignalId:this.B.model.onesignalId,subscriptionId:t.id,type:t.type,enabled:e,token:t.token,notification_types:i,web_auth:t.web_auth,web_p256:t.web_p256})}static getSubscriptionEnabledAndStatus(t){let e,i;return t.enabled&&t.notification_types===w&&t.token?(e=!0,i=w):(e=!1,i=t.enabled?t.notification_types:f),{enabled:e,notification_types:i}}}class Ho extends qs{constructor(){super("operations")}async loadOperations(){return this.load()}create(t){if(null===t)return kt.error("null jsonObject sent to OperationModelStore.create"),null;if(!this.isValidOperation(t))return null;const e=t.name;let i;switch(e){case H:i=new bo;break;case V:i=new mo;break;case Y:i=new xo;break;case Q:i=new $o;break;case Z:i=new Co;break;case X:i=new Po;break;case J:i=new Ts;break;case G:i=new Eo;break;case q:i=new Bo;break;case tt:i=new Qs;break;default:throw new Error(`Unrecognized operation: ${e}`)}return i.initializeFromJson(t),i}isValidOperation(t){const e=t?.name;if(!e)return kt.error("jsonObject must have 'name' attribute"),!1;const i=new Set([J]);return!(!t.onesignalId&&!i.has(e))||(kt.error(`${e} jsonObject must have 'onesignalId' attribute`),!1)}}class Vo{B;K;H;constructor(t,e,i){this.B=t,this.K=e,this.H=i}async getRebuildOperationsIfCurrentUser(t,e){const i=new vs;i.initializeFromModel(null,this.B.model);(new So).initializeFromModel(null,this.K.model);for(const o of this.H.list()){(new ks).initializeFromModel(null,o)}if(i.onesignalId!==e)return null;const n=[];n.push(new Ts(t,e,i.externalId));const s=await OneSignal.coreDirector.getPushSubscriptionModel();return s&&n.push(new xo({appId:t,onesignalId:e,subscriptionId:s.id,type:s.type,enabled:s.enabled,token:s.token,notification_types:s.notification_types})),n.push(new Eo(t,e)),n}}const qo=t=>{Ge.delete("operations",t.modelId)};class Go{operation;bucket;retries;resolver;constructor(t){this.operation=t.operation,this.bucket=t.bucket,this.retries=t.retries??0,this.resolver=t.resolver}toString(){return`bucket:${this.bucket}, retries:${this.retries}, operation:${this.operation}\n`}}class Jo{executorsMap;queue=[];paused=!0;enqueueIntoBucket=0;operationModelStore;newRecordState;constructor(t,e,i){this.operationModelStore=e,this.newRecordState=i,this.executorsMap=new Map;for(const n of t)for(const t of n.operations)this.executorsMap.set(t,n)}clear(){this.queue=[]}get isPaused(){return this.paused}get records(){return this.newRecordState.records}get executeBucket(){return 0===this.enqueueIntoBucket?0:this.enqueueIntoBucket-1}containsInstanceOf(t){return this.queue.some(e=>e.operation instanceof t)}async start(){this.paused=!1,await this.loadSavedOperations(),this.processQueueForever()}enqueue(t){kt.debug(`OperationRepo.enqueue(operation: ${t})`),this.internalEnqueue(new Go({operation:t,bucket:this.enqueueIntoBucket}),!0)}async enqueueAndWait(t){kt.debug(`OperationRepo.enqueueAndWaitoperation: ${t})`),await new Promise(e=>{this.internalEnqueue(new Go({operation:t,bucket:this.enqueueIntoBucket,resolver:e}),!0)})}internalEnqueue(t,e,i){this.queue.some(e=>e.operation.modelId===t.operation.modelId)?kt.debug(`OperationRepo: internalEnqueue - operation.modelId: ${t.operation.modelId} already exists in the queue.`):(void 0!==i?this.queue.splice(i,0,t):this.queue.push(t),e&&this.operationModelStore.add(t.operation))}async processQueueForever(){this.enqueueIntoBucket++;let t=!1;setInterval(async()=>{if(this.paused)return kt.debug("OpRepo is paused");if(t)return kt.debug("Operations in progress");const e=this.getNextOps(this.executeBucket);kt.debug(`processQueueForever:ops:\n${e}`),e?(t=!0,await this.executeOperations(e),t=!1):this.enqueueIntoBucket++},500)}async executeOperations(t){try{const e=t[0],i=this.executorsMap.get(e.operation.name);if(!i)throw new Error(`Could not find executor for operation ${e.operation.name}`);const n=t.map(t=>t.operation),s=await i.execute(n),o=s.idTranslations;kt.debug(`OperationRepo: execute response = ${s.result}`),o&&(t.forEach(t=>t.operation.translateIds(o)),this.queue.forEach(t=>t.operation.translateIds(o)),Object.values(o).forEach(t=>this.newRecordState.add(t)));let a=0;switch(s.result){case ao:t.forEach(t=>{this.operationModelStore.remove(t.operation.modelId)}),t.forEach(t=>t.resolver?.(!0));break;case uo:case lo:case ho:kt.error(`Operation execution failed without retry: ${n}`),t.forEach(t=>{this.operationModelStore.remove(t.operation.modelId)}),t.forEach(t=>t.resolver?.(!1));break;case ro:this.operationModelStore.remove(e.operation.modelId),e.resolver?.(!0),t.filter(t=>t!==e).reverse().forEach(t=>this.queue.unshift(t));break;case co:kt.error(`Operation execution failed, retrying: ${n}`),t.toReversed().forEach(t=>{qo(t.operation),t.retries++,t.retries>a&&(a=t.retries),this.queue.unshift(t)});break;case go:kt.error(`Operation execution failed with eventual retry, pausing the operation repo: ${n}`),this.paused=!0,t.toReversed().forEach(t=>{qo(t.operation),this.queue.unshift(t)})}if(s.operations)for(const t of s.operations.toReversed()){const e=new Go({operation:t,bucket:0});this.queue.unshift(e),this.operationModelStore.addAt(0,e.operation)}await this.delayBeforeNextExecution(a,s.retryAfterSeconds),s.idTranslations&&await St(500)}catch(e){kt.error(`Error attempting to execute operation: ${t}`,e),t.forEach(t=>{this.operationModelStore.remove(t.operation.modelId)}),t.forEach(t=>t.resolver?.(!1))}}async delayBeforeNextExecution(t,e){kt.debug(`retryAfterSeconds: ${e}`);const i=1e3*(e||0),n=1e3*t,s=Math.max(n,i);s<1||(kt.error(`Operations being delay for: ${s} ms`),await St(s))}getNextOps(t){const e=this.queue.findIndex(e=>e.operation.canStartExecute&&this.newRecordState.canAccess(e.operation.applyToRecordId)&&e.bucket<=t);if(-1!==e){const t=this.queue[e];return this.queue.splice(e,1),this.getGroupableOperations(t)}return null}getGroupableOperations(t){const e=[t];if(t.operation.groupComparisonType===Ps)return e;const i=t.operation.groupComparisonType===Cs?t.operation.createComparisonKey:t.operation.modifyComparisonKey,n=[...this.queue];for(const s of n){const n=t.operation.groupComparisonType===Cs?s.operation.createComparisonKey:s.operation.modifyComparisonKey;if(""===n&&""===i)throw new Error("Both comparison keys cannot be blank!");if(this.newRecordState.canAccess(s.operation.applyToRecordId)&&n===i){const t=this.queue.indexOf(s);-1!==t&&(this.queue.splice(t,1),e.push(s))}}return e}async loadSavedOperations(){await this.operationModelStore.loadOperations();const t=this.operationModelStore.list().toReversed();for(const e of t)this.internalEnqueue(new Go({operation:e,bucket:this.enqueueIntoBucket}),!1,0)}}class Yo{operationModelStore;operationRepo;newRecordsState;subscriptionModelStore;identityModelStore;propertiesModelStore;customEventController;initPromise;rebuildUserService;executors;listeners;constructor(){this.newRecordsState=new wo,this.operationModelStore=new Ho,this.identityModelStore=new Ys,this.propertiesModelStore=new vo,this.subscriptionModelStore=new Oo,this.rebuildUserService=new Vo(this.identityModelStore,this.propertiesModelStore,this.subscriptionModelStore),this.executors=this.initializeExecutors(),this.operationRepo=new Jo(this.executors,this.operationModelStore,this.newRecordsState),this.customEventController=new Zs(this.identityModelStore,this.operationRepo),this.listeners=this.initializeListeners(),this.initPromise=this.operationRepo.start()}async init(){return Ii("CoreModule.init"),this.initPromise}initializeListeners(){return this.operationRepo?[new Fo(this.identityModelStore,this.operationRepo),new Ko(this.propertiesModelStore,this.operationRepo),new zo(this.subscriptionModelStore,this.operationRepo,this.identityModelStore)]:[]}initializeExecutors(){const t=new yo(this.identityModelStore,this.rebuildUserService,this.newRecordsState);return[t,new To(t,this.identityModelStore,this.propertiesModelStore,this.subscriptionModelStore),new Mo(this.identityModelStore,this.propertiesModelStore,this.subscriptionModelStore,this.rebuildUserService,this.newRecordsState),new Do(this.subscriptionModelStore,this.rebuildUserService,this.newRecordsState),new Ro(this.identityModelStore,this.propertiesModelStore,this.rebuildUserService,this.newRecordsState),new po]}}class Qo{w3cEndpoint;w3cP256dh;w3cAuth;safariDeviceToken;static setFromW3cSubscription(t){const e=new Qo;if(t&&(e.w3cEndpoint=new URL(t.endpoint),t.getKey)){let n=null;try{n=t.getKey("p256dh")}catch(i){}let s=null;try{s=t.getKey("auth")}catch(i){}if(n){const t=btoa(String.fromCharCode(...new Uint8Array(n)));e.w3cP256dh=t}if(s){const t=btoa(String.fromCharCode(...new Uint8Array(s)));e.w3cAuth=t}}return e}setFromSafariSubscription(t){t&&(this.safariDeviceToken=t)}serialize(){return{w3cEndpoint:this.w3cEndpoint?this.w3cEndpoint.toString():null,w3cP256dh:this.w3cP256dh,w3cAuth:this.w3cAuth,safariDeviceToken:this.safariDeviceToken}}static deserialize(t){const e=new Qo;if(!t)return e;try{e.w3cEndpoint=new URL(t.w3cEndpoint)}catch(i){}return e.w3cP256dh=t.w3cP256dh,e.w3cAuth=t.w3cAuth,e.safariDeviceToken=t.safariDeviceToken,e}}class Zo{type;token;enabled;notificationTypes;sdk;deviceModel;deviceOs;webAuth;webp256;constructor(t){this.token=this.q(t),this.type=j(),this.enabled=!0,this.notificationTypes=w,this.sdk=M,this.deviceModel=z(),this.deviceOs=K(),this.webAuth=t.w3cAuth,this.webp256=t.w3cP256dh}q(t){return t.w3cEndpoint?t.w3cEndpoint.toString():t.safariDeviceToken}serialize(){return{type:this.type,token:this.token,enabled:this.enabled,notification_types:this.notificationTypes,sdk:this.sdk,device_model:this.deviceModel,device_os:this.deviceOs,web_auth:this.webAuth,web_p256:this.webp256}}}class Xo{core;constructor(t){this.core=t}get operationRepo(){return this.core.operationRepo}get identityModelStore(){return this.core.identityModelStore}get propertiesModelStore(){return this.core.propertiesModelStore}get subscriptionModelStore(){return this.core.subscriptionModelStore}get newRecordsState(){return this.core.newRecordsState}get customEventController(){return this.core.customEventController}generatePushSubscriptionModel(t){Ii("CoreModuleDirector.generatePushSubscriptionModel",{rawPushSubscription:t});const e=new ks;return e.initializeFromJson(new Zo(t).serialize()),e.id=xs.createLocalId(),this.core.subscriptionModelStore.add(e,bs),e}addSubscriptionModel(t){this.core.subscriptionModelStore.add(t)}removeSubscriptionModel(t){this.core.subscriptionModelStore.remove(t)}getEmailSubscriptionModels(){Ii("CoreModuleDirector.getEmailSubscriptionModels");return this.core.subscriptionModelStore.list().filter(t=>t.type===l)}async hasEmail(){const t=this.getEmailSubscriptionModels();return Object.keys(t).length>0}getSmsSubscriptionModels(){Ii("CoreModuleDirector.getSmsSubscriptionModels");return this.core.subscriptionModelStore.list().filter(t=>t.type===u)}async hasSms(){const t=this.getSmsSubscriptionModels();return Object.keys(t).length>0}getAllPushSubscriptionModels(){Ii("CoreModuleDirector.getAllPushSubscriptionModels");return this.core.subscriptionModelStore.list().filter(t=>js.isPushSubscriptionType(t.type))}async getPushSubscriptionModelByCurrentToken(){Ii("CoreModuleDirector.getPushSubscriptionModelByCurrentToken");const t=await Mi.getCurrentPushToken();if(t)return this.getSubscriptionOfTypeWithToken(r,t)}async getPushSubscriptionModelByLastKnownToken(){Ii("CoreModuleDirector.getPushSubscriptionModelByLastKnownToken");const t=await(async()=>await Je("lastPushToken"))();if(t)return this.getSubscriptionOfTypeWithToken(r,t)}async getPushSubscriptionModel(){return Ii("CoreModuleDirector.getPushSubscriptionModel"),await this.getPushSubscriptionModelByCurrentToken()||await this.getPushSubscriptionModelByLastKnownToken()}getIdentityModel(){return Ii("CoreModuleDirector.getIdentityModel"),this.core.identityModelStore.model}getPropertiesModel(){return Ii("CoreModuleDirector.getPropertiesModel"),this.core.propertiesModelStore.model}async getAllSubscriptionsModels(){Ii("CoreModuleDirector.getAllSubscriptionsModels");const t=this.getEmailSubscriptionModels(),e=this.getSmsSubscriptionModels(),i=await this.getPushSubscriptionModel();return[...t,...e,...i?[i]:[]]}getSubscriptionOfTypeWithToken(t,e){let i;switch(Ii("CoreModuleDirector.getSubscriptionOfTypeWithToken",{type:t,token:e}),t){case o:i=this.getEmailSubscriptionModels();break;case a:i=this.getSmsSubscriptionModels();break;case r:i=this.getAllPushSubscriptionModels();break;default:return}return i.find(t=>t.token===e)}}class ta{static async createUserOnServer(){const t=OneSignal.coreDirector.getIdentityModel(),e=Mi.getAppId(),i=OneSignal.coreDirector.subscriptionModelStore.list().length>0,n=!!t.externalId;if(!i&&!n)return void kt.error("No subscriptions or external ID found, skipping user creation");const s=await OneSignal.coreDirector.getPushSubscriptionModel();if(s){const i=s.toJSON();OneSignal.coreDirector.operationRepo.enqueue(new Ts(e,t.onesignalId,t.externalId)),await OneSignal.coreDirector.operationRepo.enqueueAndWait(new xo({...i,appId:e,onesignalId:t.onesignalId,subscriptionId:s.id}))}else OneSignal.coreDirector.operationRepo.enqueue(new Ts(e,t.onesignalId,t.externalId))}static resetUserModels(){const t=new vs,e=new So,i=xs.createLocalId();t.onesignalId=i,e.onesignalId=i,OneSignal.coreDirector.identityModelStore.replace(t),OneSignal.coreDirector.propertiesModelStore.replace(e)}}class ea{static switchingUsersPromise=Promise.resolve();static async login(t,e){await(this.switchingUsersPromise=ea.G(t,e))}static async G(t,e){e&&Ge.put("Ids",{id:e,type:"jwtToken"});let i=OneSignal.coreDirector.getIdentityModel();const n=xs.isLocalId(i.onesignalId)?void 0:i.onesignalId,s=i.externalId;if(s===t)return void kt.debug("Login: External ID already set, skipping login");ta.resetUserModels(),i=OneSignal.coreDirector.getIdentityModel(),i.setProperty(et,t,bs);const o=i.onesignalId,a=Mi.getAppId(),r=[OneSignal.coreDirector.getPushSubscriptionModel().then(t=>{t&&OneSignal.coreDirector.operationRepo.enqueue(new Po(a,o,t.id))}),OneSignal.coreDirector.operationRepo.enqueueAndWait(new Ts(a,o,t,s?void 0:n))];await Promise.all(r)}static async logout(){await(this.switchingUsersPromise=ea.J())}static async J(){return OneSignal.coreDirector.getIdentityModel().externalId?(ta.resetUserModels(),ta.createUserOnServer()):kt.debug("Logout: User is not logged in, skipping logout")}}function ia(t){const e=t.active||t.installing||t.waiting;return e||kt.warn("Could not find an available ServiceWorker instance!"),e}class na{replies;constructor(){this.replies={}}addListener(t,e,i){const n={callback:e,onceListenerOnly:i},s=this.replies[t.toString()];s?s.push(n):this.replies[t.toString()]=[n]}findListenersForMessage(t){return this.replies[t.toString()]||[]}deleteListenerRecords(t){this.replies[t.toString()]=null}deleteAllListenerRecords(){this.replies={}}deleteListenerRecord(t,e){const i=this.replies[t.toString()];if(null!=i)for(let n=i.length-1;n>=0;n--){i[n]===e&&i.splice(n,1)}}}class sa{context;replies;constructor(t,e=new na){this.context=t,this.replies=e}on(t,e){this.replies.addListener(t,e,!1)}once(t,e){this.replies.addListener(t,e,!0)}off(t){t?this.replies.deleteListenerRecords(t):this.replies.deleteAllListenerRecords()}}class oa extends sa{async listen(){B()&&await this.listenForPage()}async listenForPage(){navigator.serviceWorker.addEventListener("message",this.onPageMessageReceivedFromServiceWorker.bind(this)),kt.debug(`(${location.origin}) [Worker Messenger] Page is now listening for messages.`)}onPageMessageReceivedFromServiceWorker(t){const e=t.data;if(!e||!e.command)return;const i=this.replies.findListenersForMessage(e.command),n=[],s=[];kt.debug("[Worker Messenger] Page received message:",t.data);for(const o of i)o.onceListenerOnly&&n.push(o),s.push(o);for(let o=n.length-1;o>=0;o--){const t=n[o];this.replies.deleteListenerRecord(e.command,t)}for(const o of s)o.callback.apply(null,[e.payload])}async unicast(t,e){kt.debug(`[Worker Messenger] [Page -> SW] Unicasting '${t.toString()}' to service worker.`),this.directPostMessageToSW(t,e)}async directPostMessageToSW(t,e){kt.debug(`[Worker Messenger] [Page -> SW] Direct command '${t.toString()}' to service worker.`);const i=await(this.context?.serviceWorkerManager.getOneSignalRegistration());if(!i)return void kt.error("`[Worker Messenger] [Page -> SW] Could not get ServiceWorkerRegistration to postMessage!");const n=ia(i);n?n.postMessage({command:t,payload:e}):kt.error("`[Worker Messenger] [Page -> SW] Could not get ServiceWorker to postMessage!")}}class aa{static QUERY_STRING="?";path;constructor(t){if(!t)throw pt("path");this.path=t.trim()}getQueryString(){const t=this.path.indexOf("?");return-1===t?null:this.path.length>t?this.path.substring(t+1):null}getWithoutQueryString(){return this.path.split(aa.QUERY_STRING)[0]}getFileName(){return this.getWithoutQueryString().split("\\").pop()?.split("/").pop()}getFileNameWithQuery(){return this.path.split("\\").pop()?.split("/").pop()}getFullPath(){return this.path}}class ra{outcomeName;config;appId;isUnique;constructor(t,e,i,n){this.outcomeName=i,this.config=e,this.appId=t,this.isUnique=n}async getAttribution(){return await async function(t){if(t.direct&&t.direct.enabled){const t=await(async()=>(await Ge.getAll("Outcomes.NotificationClicked")).map(t=>{return{appId:(e=t).appId,notificationId:e.notificationId,timestamp:e.timestamp};var e}))();if(t.length>0)return{type:Nt,notificationIds:[t[0].notificationId]}}if(t.indirect&&t.indirect.enabled){const e=60*t.indirect.influencedTimePeriodMin*1e3,i=new Date((new Date).getTime()-e).getTime(),n=await(async()=>(await Ge.getAll("Outcomes.NotificationReceived")).map(t=>{return{appId:(e=t).appId,notificationId:e.notificationId,timestamp:e.timestamp};var e}))();if(kt.debug(`\tFound total of ${n.length} received notifications`),n.length>0){const e=t.indirect.influencedNotificationsLimit,s=function(t,e,i=!1,n=!0){const s=n?t:t.slice();return s.sort((t,n)=>{const s=e(t),o=e(n);return s>o?i?-1:1:s<o?i?1:-1:0}),s}(n,t=>t.timestamp,!0,!1),o=s.filter(t=>t.timestamp>=i).slice(0,e).map(t=>t.notificationId);kt.debug(`\tTotal of ${o.length} received notifications are within reporting window.`);const a=s.filter(t=>-1===o.indexOf(t.notificationId)).map(t=>t.notificationId);if(a.forEach(t=>Ge.delete("Outcomes.NotificationReceived",t)),kt.debug(`\t${a.length} received notifications will be deleted.`),o.length>0)return{type:At,notificationIds:o}}}if(t.unattributed&&t.unattributed.enabled)return{type:Mt,notificationIds:[]};return{type:Dt,notificationIds:[]}}(this.config)}async beforeOutcomeSend(){if(Ii(this.isUnique?"sendUniqueOutcome":"sendOutcome",this.outcomeName),!this.config)return kt.debug("Outcomes feature not supported by main application yet."),!1;if(!this.outcomeName)return kt.error("Outcome name is required"),!1;await Oi();return!!(await OneSignal.context.subscriptionManager.isPushNotificationsEnabled())||(kt.warn("Reporting outcomes is supported only for subscribed users."),!1)}async getAttributedNotifsByUniqueOutcomeName(){return(await Ge.getAll("SentUniqueOutcome")).filter(t=>t.outcomeName===this.outcomeName).reduce((t,e)=>[...t,...e.notificationIds||[]],[])}async getNotifsToAttributeWithUniqueOutcome(t){const e=await this.getAttributedNotifsByUniqueOutcomeName();return t.filter(t=>-1===e.indexOf(t))}shouldSendUnique(t,e){return t.type===Mt||e.length>0}async saveSentUniqueOutcome(t){const e=this.outcomeName,i=await Ge.get("SentUniqueOutcome",e),n=await Ye(),s=[...i?i.notificationIds:[],...t],o=n?n.startTimestamp:null;await Ge.put("SentUniqueOutcome",{outcomeName:e,notificationIds:s,sentDuringSession:o})}async wasSentDuringSession(){const t=await Ge.get("SentUniqueOutcome",this.outcomeName);if(!t)return!1;const e=await Ye(),i=e&&t.sentDuringSession===e.startTimestamp,n=!e&&!!t.sentDuringSession;return i||n}async send(t){const{type:e,notificationIds:i,weight:n}=t;switch(e){case Nt:return this.isUnique&&await this.saveSentUniqueOutcome(i),void(await OneSignal.context.updateManager.sendOutcomeDirect(this.appId,i,this.outcomeName,n));case At:return this.isUnique&&await this.saveSentUniqueOutcome(i),void(await OneSignal.context.updateManager.sendOutcomeInfluenced(this.appId,i,this.outcomeName,n));case Mt:if(this.isUnique){if(await this.wasSentDuringSession())return void kt.warn("(Unattributed) unique outcome was already sent during this session");await this.saveSentUniqueOutcome([])}return void(await OneSignal.context.updateManager.sendOutcomeUnattributed(this.appId,this.outcomeName,n));default:return void kt.warn("You are on a free plan. Please upgrade to use this functionality.")}}}function ca(t,e,i){return function(t,e,i){const n=new URL(t,It()).href,s=_t({appId:e}),o=_t({sdkVersion:i});return`${n}?${s}&${o}`}(t.workerPath.getFullPath(),e,i)}const la="OneSignal Worker",ua="3rd Party",ha="None",da="GetWorkerVersion",ga="notification.willDisplay",pa="notification.clicked",wa="notification.dismissed",fa="os.session.upsert",ma="os.session.deactivate",ba="os.page_focused_request",ya="os.page_focused_response";class Sa{context;config;constructor(t,e){this.context=t,this.config=e}async getRegistration(){return async function(t){try{const e=location.origin+t;return await navigator.serviceWorker.getRegistration(e)}catch(e){return void kt.warn("[Service Worker Status] Error Checking service worker registration",t,e)}}(this.config.registrationOptions.scope)}async getOneSignalRegistration(){if(await this.getActiveState()===la)return this.getRegistration()}async getActiveState(){const t=await this.getRegistration();if(!t)return ha;const e=Sa.activeSwFileName(t);return this.swActiveStateByFileName(e)}static activeSwFileName(t){const e=ia(t);if(!e)return null;const i=new URL(e.scriptURL).pathname,n=new aa(i).getFileName();if("akam-sw.js"==n){const t=new URLSearchParams(new URL(e.scriptURL).search).get("othersw");if(t)return kt.debug("Found a ServiceWorker under Akamai's akam-sw.js?othersw=",t),new aa(new URL(t).pathname).getFileName()}return n}swActiveStateByFileName(t){if(!t)return ha;return t==this.config.workerPath.getFileName()||"OneSignalSDK.sw.js"==t?la:ua}async getWorkerVersion(){return new Promise(async t=>{this.context.workerMessenger.once(da,e=>{t(e)}),await this.context.workerMessenger.unicast(da)})}async shouldInstallWorker(){if(!B())return!1;if(!OneSignal.config)return!1;const t=await this.getActiveState();if(kt.debug("[shouldInstallWorker] workerState",t),t===ha||t===ua){const t="granted"===await OneSignal.context.permissionManager.getNotificationPermission(OneSignal.config.safariWebId);return t&&kt.info("[shouldInstallWorker] Notification Permissions enabled, will install ServiceWorker"),t}return!!(await this.haveParamsChanged())||this.workerNeedsUpdate()}async haveParamsChanged(){const t=await this.getRegistration();if(!t)return kt.info("[changedServiceWorkerParams] workerRegistration not found at scope",this.config.registrationOptions.scope),!0;const e=new URL(t.scope).pathname,i=this.config.registrationOptions.scope;if(e!=i)return kt.info("[changedServiceWorkerParams] ServiceWorker scope changing",{a_old:e,b_new:i}),!0;const n=ia(t),s=ca(this.config,this.context.appConfig.appId,M);return!n?.scriptURL||s!==n.scriptURL&&(kt.info("[changedServiceWorkerParams] ServiceWorker href changing:",{a_old:n?.scriptURL,b_new:s}),!0)}async workerNeedsUpdate(){let t;kt.info("[Service Worker Update] Checking service worker version...");try{t=await function(t,e){const i=new Promise((t,i)=>{setTimeout(()=>{i(new Error("Async operation timed out"))},e)});return Promise.race([t,i])}(this.getWorkerVersion(),2e3)}catch(e){return kt.info("[Service Worker Update] Worker did not reply to version query; assuming older version and updating."),!0}return t!==M?(kt.info(`[Service Worker Update] Updating service worker from ${t} --\x3e ${M}.`),!0):(kt.info(`[Service Worker Update] Service worker version is current at ${t} (no update required).`),!1)}async establishServiceWorkerChannel(){kt.debug("establishServiceWorkerChannel");const t=this.context.workerMessenger;t.off(),t.on(ga,async t=>{kt.debug(location.origin,"Received notification display event from service worker.");const e={notification:t.notification,preventDefault:function(){throw new Error("Browser does not support preventing display.")}};await $i.trigger(OneSignal.EVENTS.NOTIFICATION_WILL_DISPLAY,e)}),t.on(pa,async t=>{0===OneSignal.emitter.numberOfListeners(OneSignal.EVENTS.NOTIFICATION_CLICKED)?kt.debug("notification.clicked event received, but no event listeners; storing event in IndexedDb for later retrieval."):await function(t){const e={notification:t.notification,result:t.result};return $i.trigger(OneSignal.EVENTS.NOTIFICATION_CLICKED,e)}(t)}),t.on(wa,async t=>{await $i.trigger(OneSignal.EVENTS.NOTIFICATION_DISMISSED,t)});const e=U();t.on(ba,async i=>{if(e){const e={timestamp:i.timestamp,focused:document.hasFocus()};await t.directPostMessageToSW(ya,e)}})}async installWorker(){if(!(await this.shouldInstallWorker()))return this.getOneSignalRegistration();kt.info("Installing worker...");await this.getActiveState()===ua&&kt.info("[Service Worker Installation] 3rd party service worker detected.");const t=ca(this.config,this.context.appConfig.appId,M),e=`${It()}${this.config.registrationOptions.scope}`;let i;kt.info(`[Service Worker Installation] Installing service worker ${t} ${e}.`);try{i=await navigator.serviceWorker.register(t,{scope:e,type:void 0})}catch(n){kt.error(`[Service Worker Installation] Installing service worker failed ${n}`),i=await this.fallbackToUserModelBetaWorker()}return kt.debug("[Service Worker Installation] Service worker installed. Waiting for activation"),await function(t){return new Promise(e=>{const i=t.installing||t.waiting;i&&i.addEventListener("statechange",()=>{kt.debug("OneSignal Service Worker state changed:",i.state),t.active&&e()}),t.active&&e()})}(i),kt.debug("[Service Worker Installation] Service worker active"),await this.establishServiceWorkerChannel(),i}async fallbackToUserModelBetaWorker(){const t="OneSignalSDK.sw.js",e=ca({workerPath:new aa(`/${t}`)},this.context.appConfig.appId,M),i=`${It()}${this.config.registrationOptions.scope}`;kt.info(`[Service Worker Installation] Attempting to install v16 Beta Worker ${e} ${i}.`);try{const n=await navigator.serviceWorker.register(e,{scope:i}),s=`\n        [Service Worker Installation] Successfully installed v16 Beta Worker.\n        Deprecation warning: support for the v16 beta worker name of ${t}\n        will be removed May 5 2024. We have decided to keep the v15 name.\n        To avoid breaking changes for your users, please host both worker files:\n        OneSignalSDK.sw.js & OneSignalSDKWorker.js.\n      `;return kt.error(s),n}catch(n){const t=await fetch(e);if(403===t.status||404===t.status)throw new at(t.status,t.statusText);throw n}}}class va{context;config;constructor(t,e){this.context=t,this.config=e}async registerSubscription(t,e){t&&(t=Qo.deserialize(t)),await this.isAlreadyRegisteredWithOneSignal()?"updateManager"in this.context&&await this.context.updateManager.sendPushDeviceRecordUpdate():"sessionManager"in this.context&&this.context.sessionManager.upsertSession(We);const i=await ni();return i.deviceId="99999999-9999-9999-9999-999999999999",i.optedOut=!1,t?R()?i.subscriptionToken=t.safariDeviceToken:i.subscriptionToken=t.w3cEndpoint?t.w3cEndpoint.toString():null:i.subscriptionToken=null,await si(i),$i.trigger(OneSignal.EVENTS.REGISTERED),"undefined"!=typeof OneSignal&&(OneSignal.D=!1),i}async isAlreadyRegisteredWithOneSignal(){const{deviceId:t}=await ni();return!!t}async subscribeWithVapidKey(t,e){const i=await t.getSubscription();switch(e){case ss:if(!i)break;i.options?kt.debug("[Subscription Manager] An existing push subscription exists and it's options is not null."):(kt.debug("[Subscription Manager] An existing push subscription exists and options is null. Unsubscribing from push first now."),await va.doPushUnsubscribe(i));break;case os:i&&await va.doPushUnsubscribe(i)}const[n,s]=await va.doPushSubscribe(t,this.getVapidKeyForBrowser());await va.updateSubscriptionTime(s,n.expirationTime);return Qo.setFromW3cSubscription(n)}getVapidKeyForBrowser(){let t;return t=_()===O?this.config.onesignalVapidPublicKey:this.config.vapidPublicKey,t?function(t){const e=(t+"=".repeat((4-t.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),i=atob(e),n=new Uint8Array(i.length);for(let s=0;s<i.length;++s)n[s]=i.charCodeAt(s);return n}(t).buffer:void 0}static async updateSubscriptionTime(t,e){const i=await ni();t&&(i.createdAt=(new Date).getTime()),i.expirationTime=e,await si(i)}static async doPushSubscribe(t,e){if(!e)throw new Error("Missing required 'applicationServerKey' to subscribe for push notifications!");const i={userVisibleOnly:!0,applicationServerKey:e};kt.debug("[Subscription Manager] Subscribing to web push with these options:",i);try{const e=await t.getSubscription();return[await t.subscribe(i),!e]}catch(n){if(n instanceof Error){kt.warn("[Subscription Manager] Couldn't re-subscribe due to applicationServerKey changing, unsubscribe and attempting to subscribe with new key.",n);const e=await t.getSubscription();return e&&await va.doPushUnsubscribe(e),[await t.subscribe(i),!0]}throw n}}static async doPushUnsubscribe(t){kt.debug("[Subscription Manager] Unsubscribing existing push subscription.");const e=await t.unsubscribe();return kt.debug(`[Subscription Manager] Unsubscribing existing push subscription result: ${e}`),e}}const Oa=new Error("Not implemented");const Ia=async t=>{await ea.switchingUsersPromise;let e=await OneSignal.coreDirector.getPushSubscriptionModel();if(!e)return e=OneSignal.coreDirector.generatePushSubscriptionModel(t),ta.createUserOnServer();if(xs.isLocalId(e.id))return ta.createUserOnServer();const i=new Zo(t).serialize();for(const n in i){const t=n;e.setProperty(t,i[t])}};class ka extends va{safariPermissionPromptFailed=!1;async isPushNotificationsEnabled(){const t=await this.getSubscriptionState();return t.subscribed&&!t.optedOut}async updateNotificationTypes(){const t=await this.getNotificationTypes();await this.updatePushSubscriptionNotificationTypes(t)}async updatePushSubscriptionNotificationTypes(t){const e=await OneSignal.coreDirector.getPushSubscriptionModel();e?(e.notification_types=t,e.enabled=t===w):kt.info("No Push Subscription yet to update notification_types.")}async getNotificationTypes(){const{optedOut:t}=await ni();if(t)return f;return"granted"===await OneSignal.context.permissionManager.getPermissionStatus()?w:p}async isOptedIn(){const t=await this.getSubscriptionState();return"granted"===await OneSignal.context.permissionManager.getPermissionStatus()&&!t.optedOut}async isOptedOut(t){Ii("isOptedOut",t);const{optedOut:e}=await ni();return function(t,...e){if(t)t.apply(null,e)}(t,e),e}async unsubscribe(t){throw Oa}async getSubscriptionState(){const{optedOut:t,subscriptionToken:e}=await ni(),i=Os(await OneSignal.coreDirector.getPushSubscriptionModel());if(R()){const n=window.safari?.pushNotification?.permission(this.config.safariWebId);return{subscribed:!!(i&&e&&"granted"===n?.permission&&n?.deviceToken),optedOut:!!t}}const n=await this.context.serviceWorkerManager.getOneSignalRegistration(),s=await this.context.permissionManager.getNotificationPermission(this.context.appConfig.safariWebId);if(!n)return{subscribed:!1,optedOut:!!t};return{subscribed:!(!i||!e||"granted"!==s),optedOut:!!t}}async subscribe(t){let e;if("denied"===await OneSignal.context.permissionManager.getPermissionStatus())throw ut;if(R()){e=await this.subscribeSafari(),await Ia(e),kt.info("Installing SW on Safari");try{await this.context.serviceWorkerManager.installWorker(),kt.info("SW on Safari successfully installed")}catch(i){kt.error("SW on Safari failed to install.")}}else e=await this.subscribeFcmFromPage(t),await Ia(e);return e}async subscribeSafari(){const t=new Qo;if(!this.config.safariWebId)throw dt;const{deviceToken:e}=window.safari?.pushNotification?.permission(this.config.safariWebId)||{};if(e)return t.setFromSafariSubscription(e.toLowerCase()),t;$i.trigger(OneSignal.EVENTS.PERMISSION_PROMPT_DISPLAYED);const i=await this.subscribeSafariPromptPermission();if(_i(),!i)throw this.safariPermissionPromptFailed=!0,new Error("Safari url/icon/certificate invalid or in private mode");return t.setFromSafariSubscription(i),t}async subscribeSafariPromptPermission(){const t=t=>new Promise(e=>{window.safari?.pushNotification?.requestPermission(t,this.config.safariWebId,{app_id:this.config.appId},t=>{t&&t.deviceToken?e(t.deviceToken.toLowerCase()):e(null)})});return this.safariPermissionPromptFailed?t(`${F({legacy:!0}).toString()}safari`):t(`${F({legacy:!0}).toString()}safari/apps/${this.config.appId}`)}async subscribeFcmFromPage(t){if("default"===Notification.permission){await $i.trigger(OneSignal.EVENTS.PERMISSION_PROMPT_DISPLAYED);const t=await ka.requestPresubscribeNotificationPermission(),e="default"===t;switch(await _i(e),t){case"default":throw kt.debug("Exiting subscription and not registering worker because the permission was dismissed."),OneSignal.D=!1,new Error("Permission dismissed");case"denied":throw kt.debug("Exiting subscription and not registering worker because the permission was blocked."),OneSignal.D=!1,ut}}let e;try{e=await this.context.serviceWorkerManager.installWorker()}catch(i){throw i instanceof at&&(403===i.status?await this.context.subscriptionManager.registerFailedSubscription(m):404===i.status&&await this.context.subscriptionManager.registerFailedSubscription(b)),i}if(!e)throw new Error("OneSignal service worker not found!");return kt.debug("[Subscription Manager] Service worker is ready to continue subscribing."),await this.subscribeWithVapidKey(e.pushManager,t)}async registerFailedSubscription(t){ps()&&(this.context.subscriptionManager.registerSubscription(new Qo,t),gs())}static async requestPresubscribeNotificationPermission(){return await ka.requestNotificationPermission()}static async requestNotificationPermission(){return await window.Notification.requestPermission()}async isSubscriptionExpiring(){if(await this.context.serviceWorkerManager.getActiveState()!==la)return!1;const t=await this.context.serviceWorkerManager.getOneSignalRegistration();if(!t)return!1;if(!t.pushManager)return!1;const e=await t.pushManager.getSubscription();if(!e)return!1;if(!e.expirationTime)return!1;let{createdAt:i}=await ni();if(!i){const t=31536e6;i=(new Date).getTime()+t}const n=i+(e.expirationTime-i)/2;return!!e.expirationTime&&((new Date).getTime()>=e.expirationTime||(new Date).getTime()>=n)}}class xa{static get STORED_PERMISSION_KEY(){return"storedNotificationPermission"}async getPermissionStatus(){if(!OneSignal.context)throw new Error("OneSignal.context is undefined. Call init first");return await OneSignal.context.permissionManager.getNotificationPermission(OneSignal.config.safariWebId)}async getNotificationPermission(t){return R()?xa.getLegacySafariNotificationPermission(t):this.getW3cNotificationPermission()}static getLegacySafariNotificationPermission(t){if(t)return window.safari?.pushNotification?.permission(t).permission;throw pt("safariWebId")}getW3cNotificationPermission(){return Notification.permission}}class Ca{context;onSessionSent=!1;constructor(t){this.context=t}async notifySWToUpsertSession(t,e,i){const n={onesignalId:t,subscriptionId:e,appId:this.context.appConfig.appId,sessionThreshold:this.context.appConfig.sessionThreshold||0,enableSessionDuration:!!this.context.appConfig.enableSessionDuration,sessionOrigin:i,isSafari:U(),outcomesConfig:this.context.appConfig.userConfig.outcomes};B()?(kt.debug("Notify SW to upsert session"),await this.context.workerMessenger.unicast(fa,n)):kt.debug("Notify upsert: do nothing")}async notifySWToDeactivateSession(t,e,i){const n={appId:this.context.appConfig.appId,subscriptionId:e,onesignalId:t,sessionThreshold:this.context.appConfig.sessionThreshold,enableSessionDuration:this.context.appConfig.enableSessionDuration,sessionOrigin:i,isSafari:U(),outcomesConfig:this.context.appConfig.userConfig.outcomes};B()?(kt.debug("Notify SW to deactivate session"),await this.context.workerMessenger.unicast(ma,n)):kt.debug("Notify deactivate: do nothing")}async Y(){const t=OneSignal.coreDirector.getIdentityModel(),e=await OneSignal.coreDirector.getPushSubscriptionModel();if(!t||!t.onesignalId)throw new Error("No identity");if(!e||!Os(e))throw new Error("No subscription");const{onesignalId:i}=t,{id:n}=e;return{onesignalId:i,subscriptionId:n}}async handleVisibilityChange(){if(await ea.switchingUsersPromise,_s.singletonInstance?.onesignalId)try{const t=document.visibilityState,{onesignalId:e,subscriptionId:i}=await this.Y();if("visible"===t)return this.setupOnFocusAndOnBlurForSession(),kt.debug("handleVisibilityChange","visible",`hasFocus: ${document.hasFocus()}`),void(document.hasFocus()&&await this.notifySWToUpsertSession(e,i,je));if("hidden"===t)return kt.debug("handleVisibilityChange","hidden"),OneSignal.cache.focusHandler&&OneSignal.cache.isFocusEventSetup&&(window.removeEventListener("focus",OneSignal.cache.focusHandler,!0),OneSignal.cache.isFocusEventSetup=!1),OneSignal.cache.blurHandler&&OneSignal.cache.isBlurEventSetup&&(window.removeEventListener("blur",OneSignal.cache.blurHandler,!0),OneSignal.cache.isBlurEventSetup=!1),void(await this.notifySWToDeactivateSession(e,i,Ke));kt.warn("Unhandled visibility state happened",t)}catch(t){kt.error("Error handling visibility change:",t)}}async handleOnBeforeUnload(){if(await ea.switchingUsersPromise,_s.singletonInstance?.onesignalId)try{const{onesignalId:t,subscriptionId:e}=await this.Y(),i={appId:this.context.appConfig.appId,onesignalId:t,subscriptionId:e,sessionThreshold:this.context.appConfig.sessionThreshold,enableSessionDuration:this.context.appConfig.enableSessionDuration,sessionOrigin:ze,isSafari:U(),outcomesConfig:this.context.appConfig.userConfig.outcomes};kt.debug("Notify SW to deactivate session (beforeunload)"),this.context.workerMessenger.directPostMessageToSW(ma,i)}catch(t){kt.error("Error handling onbeforeunload:",t)}}async handleOnFocus(t){if(await ea.switchingUsersPromise,kt.debug("handleOnFocus",t),_s.singletonInstance?.onesignalId)try{if(t.target!==window)return;const{onesignalId:e,subscriptionId:i}=await this.Y();await this.notifySWToUpsertSession(e,i,He)}catch(e){kt.error("Error handling focus:",e)}}async handleOnBlur(t){if(await ea.switchingUsersPromise,kt.debug("handleOnBlur",t),_s.singletonInstance?.onesignalId)try{if(t.target!==window)return;const{onesignalId:e,subscriptionId:i}=await this.Y();await this.notifySWToDeactivateSession(e,i,Ve)}catch(e){kt.error("Error handling blur:",e)}}async upsertSession(t){if(await ea.switchingUsersPromise,_s.singletonInstance?.onesignalId){const{onesignalId:e,subscriptionId:i}=await this.Y();await this.notifySWToUpsertSession(e,i,t)}B()?this.setupSessionEventListeners():(this.onSessionSent=t===We,OneSignal.emitter.emit(OneSignal.EVENTS.SESSION_STARTED))}setupSessionEventListeners(){B()?(this.setupOnFocusAndOnBlurForSession(),OneSignal.cache.isVisibilityChangeEventSetup||(document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this),!0),OneSignal.cache.isVisibilityChangeEventSetup=!0),OneSignal.cache.isBeforeUnloadEventSetup||(window.addEventListener("beforeunload",t=>{this.handleOnBeforeUnload(),delete t.returnValue},!0),OneSignal.cache.isBeforeUnloadEventSetup=!0)):kt.debug("Not setting session event listeners. No service worker possible.")}setupOnFocusAndOnBlurForSession(){kt.debug("setupOnFocusAndOnBlurForSession"),OneSignal.cache.focusHandler||(OneSignal.cache.focusHandler=this.handleOnFocus.bind(this)),OneSignal.cache.isFocusEventSetup||(window.addEventListener("focus",OneSignal.cache.focusHandler,!0),OneSignal.cache.isFocusEventSetup=!0),OneSignal.cache.blurHandler||(OneSignal.cache.blurHandler=this.handleOnBlur.bind(this)),OneSignal.cache.isBlurEventSetup||(window.addEventListener("blur",OneSignal.cache.blurHandler,!0),OneSignal.cache.isBlurEventSetup=!0)}async sendOnSessionUpdateFromPage(){if(this.onSessionSent||!ps())return;const t=OneSignal.coreDirector.getIdentityModel().onesignalId;if(!t)return void kt.debug("Not sending the on session because user is not registered with OneSignal (no onesignal id)");const e=await OneSignal.coreDirector.getPushSubscriptionModel();if(e?.notification_types!==w&&!0!==OneSignal.config?.enableOnSession)return;let i;Os(e)&&(i=e?.id);try{const e={label:it,id:t},s={refresh_device_metadata:!0,deltas:{session_count:1}},o=Mi.getAppId();!function(t){if(!t)throw new Error("App id cannot be empty")}(o),function(t){if(!t.id)throw new Error("Alias id cannot be empty")}(e);try{await Pt({appId:o,subscriptionId:i},e,s),this.onSessionSent=!0}catch(n){kt.debug("Error updating user session:",n)}}catch(n){n instanceof Error&&kt.error(`Failed to update user session. Error "${n.message}" ${n.stack}`)}}}class Ea{context;onSessionSent;constructor(t){this.context=t,this.onSessionSent=ds()>1}async sendPushDeviceRecordUpdate(){_s.singletonInstance?.onesignalId?this.onSessionSent||await this.sendOnSessionUpdate():kt.debug("Not sending the update because user is not registered with OneSignal (no onesignal_id)")}async sendOnSessionUpdate(){if(this.onSessionSent)return;if(!ps())return;if(!(await this.context.subscriptionManager.isAlreadyRegisteredWithOneSignal()))return void kt.debug("Not sending the on session because user is not registered with OneSignal (no device id)");const t=await OneSignal.coreDirector.getPushSubscriptionModel();if(t?.notification_types===w||!0===OneSignal.config?.enableOnSession)try{this.context.sessionManager.upsertSession(Fe),this.onSessionSent=!0}catch(e){e instanceof Error&&kt.error(`Failed to update user session. Error "${e.message}" ${e.stack}`)}}async sendOutcomeDirect(t,e,i,n){Ii("sendOutcomeDirect");const s=await OneSignal.coreDirector.getPushSubscriptionModel();if(s&&Os(s)){const o={id:i,app_id:t,notification_ids:e,direct:!0,subscription:{id:s.id,type:j()}};return void 0!==n&&(o.weight=n),void(await Ut.sendOutcome(o))}kt.warn("Send outcome aborted because pushSubscriptionModel is not available.")}async sendOutcomeInfluenced(t,e,i,n){Ii("sendOutcomeInfluenced");const s=await OneSignal.coreDirector.getPushSubscriptionModel();if(s&&Os(s)){const o={id:i,app_id:t,notification_ids:e,direct:!1,subscription:{id:s.id,type:j()}};return void 0!==n&&(o.weight=n),void(await Ut.sendOutcome(o))}kt.warn("Send outcome aborted because pushSubscriptionModel is not available.")}async sendOutcomeUnattributed(t,e,i){Ii("sendOutcomeUnattributed");const n=await OneSignal.coreDirector.getPushSubscriptionModel();if(n&&Os(n)){const s={id:e,app_id:t,subscription:{id:n.id,type:j()}};return void 0!==i&&(s.weight=i),void(await Ut.sendOutcome(s))}kt.warn("Send outcome aborted because pushSubscriptionModel is not available.")}}const Pa="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/css/intlTelInput.min.css",$a="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/js/intlTelInput.min.js",Ta="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/js/utils.js",_a="sha512-yye/u0ehQsrVrfSd6biT17t39Rg9kNc+vENcCXZuMz2a+LWFGvXUnYuWUW6pbfYj1jcBb/C39UZw2ciQvwDDvg==",Na="sha512-OnkjbJ4TwPpgSmjXACCb5J4cJwi880VRe+vWpPDlr8M38/L3slN5uUAeOeWU2jN+4vN0gImCXFGdJmc0wO4Mig==",Aa="sha512-bUcJxlqkiGA3cmoYPuZaLRsyc5ChG9APG4ajom2AXKSlBtOmx4kLV3c8uv/6uSz43FMjI4Q2QI21+D223rT76w==";class Ma{smsInputFieldIsValid=!0;emailInputFieldIsValid=!0;promptOptions;itiOneSignal;constructor(t){this.promptOptions=t}generateHtml(){const t=document.createElement("div");let e,i,n;switch(ci(t,Ln),t.id=Ln,this.promptOptions.type){case zt:e=this.promptOptions.text.smsLabel||"Phone Number",i=this.getInputWithValidationElement(zt,e),t.appendChild(i);break;case Ht:e=this.promptOptions.text.emailLabel||"Email",n=this.getInputWithValidationElement(Ht,e),t.appendChild(n);break;case Vt:e=this.promptOptions.text.emailLabel||"Email",n=this.getInputWithValidationElement(Ht,e),t.appendChild(n),e=this.promptOptions.text.smsLabel||"Phone Number",i=this.getInputWithValidationElement(zt,e),t.appendChild(i)}return t}getValidationElementWithMessage(t){const e=document.createElement("div"),i=document.createElement("img"),n=document.createElement("p");return n.innerText=t,i.setAttribute("src","data:image/svg+xml;charset=UTF-8,%3csvg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M7.98775 -0.00114406C5.85015 0.0338508 3.81219 0.908665 2.31442 2.43419C1.565 3.18031 0.973715 4.06987 0.575897 5.04969C0.17808 6.02952 -0.0180997 7.07949 -0.000914196 8.13686C-0.00214385 9.17005 0.200528 10.1933 0.595487 11.148C0.990446 12.1028 1.56993 12.9702 2.30072 13.7005C3.03151 14.4309 3.89925 15.0098 4.85421 15.4042C5.80916 15.7986 6.83256 16.0007 7.86575 15.9989H8.00842C10.1467 15.9769 12.1889 15.1075 13.6869 13.5816C15.185 12.0557 16.0165 9.99781 15.9991 7.85952C16.0015 6.8138 15.7949 5.77814 15.3913 4.81345C14.9876 3.84876 14.3952 2.97451 13.6488 2.24213C12.9023 1.50974 12.017 0.933994 11.0448 0.548751C10.0726 0.163508 9.03324 -0.0234551 7.98775 -0.00114406ZM6.99909 11.0269C6.99428 10.8961 7.01558 10.7658 7.06175 10.6434C7.10792 10.521 7.17803 10.4091 7.26797 10.3141C7.35792 10.2191 7.4659 10.143 7.58559 10.0903C7.70529 10.0375 7.8343 10.0092 7.96509 10.0069H7.98309C8.24616 10.0074 8.49882 10.1097 8.6881 10.2924C8.87739 10.4751 8.9886 10.724 8.99842 10.9869C9.00331 11.1176 8.98207 11.248 8.93594 11.3704C8.8898 11.4928 8.8197 11.6048 8.72974 11.6998C8.63978 11.7948 8.53176 11.8709 8.41202 11.9236C8.29229 11.9763 8.16323 12.0046 8.03242 12.0069H8.01442C7.75145 12.006 7.49897 11.9036 7.30976 11.721C7.12054 11.5383 7.00923 11.2896 6.99909 11.0269ZM7.33242 8.33219V4.33219C7.33242 4.15538 7.40266 3.98581 7.52768 3.86079C7.65271 3.73576 7.82227 3.66552 7.99909 3.66552C8.1759 3.66552 8.34547 3.73576 8.47049 3.86079C8.59551 3.98581 8.66575 4.15538 8.66575 4.33219V8.33219C8.66575 8.509 8.59551 8.67857 8.47049 8.80359C8.34547 8.92862 8.1759 8.99886 7.99909 8.99886C7.82227 8.99886 7.65271 8.92862 7.52768 8.80359C7.40266 8.67857 7.33242 8.509 7.33242 8.33219Z' fill='%23E54B4D'/%3e%3c/svg%3e"),e.appendChild(i),e.appendChild(n),e}getInputWithValidationElement(t,e){const i=this.getTypeSpecificVariablesForValidationElemGeneration(t),n=document.createElement("label"),s=document.createElement("input"),o=document.createElement("div"),a=document.createElement("div"),r=this.getValidationElementWithMessage(i.message),c=document.createElement("div");return o.setAttribute("style","clear:both"),a.setAttribute("style","clear:both"),ci(r,Kn),ci(r,zn),r.id=i.validationElementId,n.title=e,n.innerText=e,n.htmlFor=i.inputElementId,s.type=i.domElementType,s.id=i.inputElementId,s.tabIndex=i.tabIndex,ci(s,i.inputClass),ci(c,Rn),c.id=i.wrappingDivId,c.appendChild(n),c.appendChild(o),c.appendChild(s),c.appendChild(a),c.appendChild(r),c}getTypeSpecificVariablesForValidationElemGeneration(t){if(t===Ht)return{message:"Please enter a valid email",domElementType:"email",validationElementId:Yn,inputElementId:Gn,inputClass:jn,wrappingDivId:Vn,tabIndex:1};if(t===zt)return{message:"Please enter a valid phone number",domElementType:"tel",validationElementId:Jn,inputElementId:qn,inputClass:Fn,wrappingDivId:Hn,tabIndex:2};throw new Error("invalid channel type for input validation")}initializePhoneInputLibrary(){const t=ri(`#${qn}`);t&&window.intlTelInput?this.itiOneSignal=window.intlTelInput(t,{autoPlaceholder:"off",separateDialCode:!0}):kt.error("OneSignal: there was a problem initializing International Telephone Input")}addSmsInputEventListeners(){const t=ri(`#${qn}`);t.addEventListener("keyup",e=>{this.smsInputFieldIsValid=this.itiOneSignal?.isValidNumber()||""===t?.value,"Enter"===e.key&&document.getElementById(pn)?.click(),this.updateValidationOnSmsInputChange()}),t.addEventListener("blur",()=>{this.smsInputFieldIsValid=this.itiOneSignal?.isValidNumber()||""===t?.value,this.updateValidationOnSmsInputChange()})}addEmailInputEventListeners(){const t=ri(`#${Gn}`);t.addEventListener("keyup",e=>{const i=t?.value;this.emailInputFieldIsValid=Ma.validateEmailInputWithReturnVal(i),"Enter"===e.key&&document.getElementById(pn)?.click(),this.updateValidationOnEmailInputChange()})}updateValidationOnSmsInputChange(){const t=ri(`#${Hn}`),e=ri(`#${Jn}`);li(t,Wn),ci(e,Kn)}updateValidationOnEmailInputChange(){const t=ri(`#${Vn}`),e=ri(`#${Yn}`);li(t,Wn),ci(e,Kn)}async loadPhoneLibraryScripts(){if(OneSignal.Z)return;const t=document.createElement("script"),e=document.createElement("script"),i=document.createElement("link");t.src=$a,e.src=Ta,i.href=Pa,i.rel="stylesheet",t.integrity=Na,e.integrity=Aa,i.integrity=_a,t.crossOrigin="anonymous",e.crossOrigin="anonymous",i.crossOrigin="anonymous",document.head.appendChild(t),document.head.appendChild(e),document.head.appendChild(i);const n=new Promise(e=>{t.onload=()=>{e()}}),s=new Promise(t=>{e.onload=()=>{t()}});await Promise.all([n,s]),OneSignal.Z=!0}async mount(){const t=Ma.isUsingSmsInputField(this.promptOptions.type),e=Ma.isUsingEmailInputField(this.promptOptions.type);t&&await this.loadPhoneLibraryScripts();const i=this.generateHtml();ri(`#${wn}`).appendChild(i),t&&(this.initializePhoneInputLibrary(),this.addSmsInputEventListeners()),e&&this.addEmailInputEventListeners()}isEmailInputFieldEmpty(){return""===this.getValueFromEmailInput()}isSmsInputFieldEmpty(){return""===this.getValueFromSmsInput()}getValueFromEmailInput(){const t=ri(`#${Gn}`);return t?.value||""}getValueFromSmsInput(){return this.itiOneSignal?.getNumber(window.intlTelInputUtils?.numberFormat.E164)||""}static showSmsInputError(t){const e=document.querySelector(`#${Jn}`),i=document.querySelector(`#${Hn}`);e&&i?t?(e.classList.remove(Kn),i.classList.add(Wn)):(e.classList.add(Kn),i.classList.remove(Wn)):kt.error("OneSignal: couldn't find slidedown validation element")}static showEmailInputError(t){const e=document.querySelector(`#${Yn}`),i=document.querySelector(`#${Vn}`);e&&i?t?(e.classList.remove(Kn),i.classList.add(Wn)):(e.classList.add(Kn),i.classList.remove(Wn)):kt.error("OneSignal: couldn't find slidedown validation element")}static resetInputErrorStates(t){switch(t){case zt:Ma.showSmsInputError(!1);break;case Ht:Ma.showEmailInputError(!1);break;case Vt:Ma.showSmsInputError(!1),Ma.showEmailInputError(!1)}}static validateEmailInputWithReturnVal(t){return/^\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/.test(t||"")||""===t}static isUsingSmsInputField(t){return t===zt||t===Vt}static isUsingEmailInputField(t){return t===Ht||t===Vt}}function Da(t){return`<svg viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" width="24px" height="24px" fill="${t}"> <g transform="rotate(0 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.916s" repeatCount="indefinite"/> </rect> </g> <g transform="rotate(30 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.833s" repeatCount="indefinite"/> </rect> </g> <g transform="rotate(60 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.75s" repeatCount="indefinite"/> </rect> </g> <g transform="rotate(90 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.666s"/> </rect> </g> <g transform="rotate(120 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.583s"/> </rect> </g> <g transform="rotate(150 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.5s"/> </rect> </g> <g transform="rotate(180 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.416s"/> </rect> </g> <g transform="rotate(210 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.333s"/> </rect> </g> <g transform="rotate(240 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.25s"/> </rect> </g> <g transform="rotate(270 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.166s"/> </rect> </g> <g transform="rotate(300 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.083s"/> </rect> </g> <g transform="rotate(330 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="0s"/> </rect> </g> </svg>`}class Ua{options;notificationIcons;channelCaptureContainer;isShowingFailureState;tagCategories;savingButton=Xt;errorButton=Qt;updateMessage;positiveUpdateButton;negativeUpdateButton;constructor(t){switch(this.options=t,this.options.text.actionMessage=t.text.actionMessage.substring(0,90),this.options.text.acceptButton=t.text.acceptButton.substring(0,16),this.options.text.cancelButton=t.text.cancelButton.substring(0,16),this.notificationIcons=null,this.channelCaptureContainer=null,this.isShowingFailureState=!1,t.type){case Kt:this.negativeUpdateButton=this.options.text.negativeUpdateButton?.substring(0,16),this.positiveUpdateButton=this.options.text.positiveUpdateButton?.substring(0,16),this.updateMessage=this.options.text.updateMessage?.substring(0,90),this.tagCategories=t.categories,this.errorButton=Ot(this.options.text.positiveUpdateButton,Qt);break;case zt:case Ht:case Vt:this.errorButton=Ot(this.options.text.acceptButton,Qt)}}async create(t){if(null===this.notificationIcons){const e=await Mi.getNotificationIcons();this.notificationIcons=e,this.container.className.includes(Zi)&&ai(`#${bn}`);const i=t&&this.tagCategories?this.positiveUpdateButton:this.options.text.acceptButton,n=t&&this.tagCategories?this.negativeUpdateButton:this.options.text.cancelButton,s=function(t){const{icon:e,messageText:i,positiveButtonText:n,negativeButtonText:s}=t,o=e===ln?"data:image/svg+xml,%3Csvg fill='none' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'%3E%3Cg clip-path='url(%23clip0)'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M33.232 28.434a2.5 2.5 0 001.768.733 1.667 1.667 0 010 3.333H5a1.667 1.667 0 110-3.333 2.5 2.5 0 002.5-2.5v-8.104A13.262 13.262 0 0118.333 5.122V1.667a1.666 1.666 0 113.334 0v3.455A13.262 13.262 0 0132.5 18.563v8.104a2.5 2.5 0 00.732 1.767zM16.273 35h7.454a.413.413 0 01.413.37 4.167 4.167 0 11-8.28 0 .417.417 0 01.413-.37z' fill='%23BDC4CB'/%3E%3C/g%3E%3Cdefs%3E%3CclipPath id='clip0'%3E%3Cpath fill='%23fff' d='M0 0h40v40H0z'/%3E%3C/clipPath%3E%3C/defs%3E%3C/svg%3E":e,a=e===ln?ln:"",r=document.createElement("div"),c=document.createElement("div"),l=document.createElement("div"),u=document.createElement("div"),h=document.createElement("div"),d=document.createElement("div"),g=document.createElement("button"),p=document.createElement("button"),w=document.createElement("div"),f=document.createElement("div"),m=document.createElement("img");return ci(c,Yi),ci(u,rn),ci(l,cn),ci(d,tn),ci(w,hn),ci(f,hn),ci(g,In),ci(g,kn),ci(g,Cn),ci(p,In),ci(p,xn),ci(p,Cn),r.id=vn,c.id=wn,h.id=On,g.id=pn,p.id=mn,d.id=Sn,a&&ci(m,a),m.setAttribute("alt","notification icon"),m.setAttribute("src",o||""),l.innerText=i||"",g.innerText=n||"",p.innerText=s||"",u.appendChild(m),c.appendChild(u),c.appendChild(l),c.appendChild(w),c.appendChild(h),d.appendChild(g),d.appendChild(p),d.appendChild(f),r.appendChild(c),r.appendChild(d),r}({messageText:t&&this.tagCategories?this.updateMessage:this.options.text.actionMessage,icon:this.options.icon||this.getPlatformNotificationIcon(),positiveButtonText:i,negativeButtonText:n}),o=document.createElement("div"),a=document.createElement("div");o.id=bn,ci(o,Zi),ci(o,en),ri("body").appendChild(o),a.id=yn,ci(a,Xi),a.appendChild(s),this.container.appendChild(a),ci(this.container,$()?sn:on),this.allowButton.addEventListener("click",this.onSlidedownAllowed.bind(this)),this.cancelButton.addEventListener("click",this.onSlidedownCanceled.bind(this))}}static async triggerSlidedownEvent(t){await $i.trigger(t)}async onSlidedownAllowed(t){await Ua.triggerSlidedownEvent(Ua.EVENTS.ALLOW_CLICK)}onSlidedownCanceled(t){Ua.triggerSlidedownEvent(Ua.EVENTS.CANCEL_CLICK),this.close(),Ua.triggerSlidedownEvent(Ua.EVENTS.CLOSED)}close(){ci(this.container,an),ki(this.dialog,"animationend",(t,e)=>{t.target!==this.dialog||"slideDownExit"!==t.animationName&&"slideUpExit"!==t.animationName||(ai(`#${bn}`),e())},!0)}setSaveState(){this.allowButton.disabled=!0,this.allowButton.textContent=null,this.allowButton.insertAdjacentElement("beforeend",this.getTextSpan(this.savingButton)),this.allowButton.insertAdjacentElement("beforeend",this.getIndicatorHolder()),oi(this.buttonIndicatorHolder,"beforeend",Da(Un)),ci(this.allowButton,"disabled"),ci(this.allowButton,nn)}removeSaveState(){this.allowButton.textContent=this.positiveUpdateButton??"",ai(`#${Qi}`),this.allowButton.disabled=!1,li(this.allowButton,"disabled"),li(this.allowButton,nn)}setFailureState(){this.allowButton.textContent=null,this.allowButton.insertAdjacentElement("beforeend",this.getTextSpan(this.errorButton)),this.options.type===Kt&&(this.allowButton.insertAdjacentElement("beforeend",this.getIndicatorHolder()),oi(this.buttonIndicatorHolder,"beforeend",function(t="#FFFFFF"){return`<svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.711 2.652a5.489 5.489 0 00-4.044 4.05 5.513 5.513 0 00.104 2.968.167.167 0 00.25.089l.893-.588a.667.667 0 011.02.692l-.61 2.937a.667.667 0 01-.786.52L.6 12.713a.667.667 0 01-.232-1.21l.933-.615a.166.166 0 00.063-.2 7.167 7.167 0 018.828-9.516.833.833 0 01-.507 1.587 5.489 5.489 0 00-2.974-.108zM15.75 3.542c.09.096.15.216.172.346a.667.667 0 01-.301.681l-.898.564a.166.166 0 00-.066.2 7.167 7.167 0 01-8.77 9.514.835.835 0 01-.154-1.544.831.831 0 01.646-.048 5.5 5.5 0 006.856-6.949.167.167 0 00-.176-.114.164.164 0 00-.071.026l-.962.604a.667.667 0 01-1.005-.713l.667-2.924a.667.667 0 01.8-.502l2.925.667c.129.03.246.096.336.192z" fill="${t}"/></svg>`}()),ci(this.allowButton,"onesignal-error-state-button")),this.isShowingFailureState=!0}setFailureStateForInvalidChannelInput(t){switch(t){case nt:Ma.showSmsInputError(!0);break;case st:Ma.showEmailInputError(!0);break;case ot:Ma.showSmsInputError(!0),Ma.showEmailInputError(!0)}}removeFailureState(){ai("#onesignal-button-indicator-holder"),li(this.allowButton,"onesignal-error-state-button"),Bs(this.options.type)||Ma.resetInputErrorStates(this.options.type),this.isShowingFailureState=!1}getPlatformNotificationIcon(){return Ci(this.notificationIcons)}getIndicatorHolder(){const t=document.createElement("div");return t.id=fn,ci(t,Qi),t}getTextSpan(t){const e=document.createElement("span");return e.textContent=t,e}get container(){return ri(`#${bn}`)}get dialog(){return ri(`#${yn}`)}get allowButton(){return ri(`#${pn}`)}get cancelButton(){return ri(`#${mn}`)}get buttonIndicatorHolder(){return ri(`#${fn}`)}get slidedownFooter(){return ri(`#${Sn}`)}static get EVENTS(){return{ALLOW_CLICK:"slidedownAllowClick",CANCEL_CLICK:"slidedownCancelClick",SHOWN:"slidedownShown",CLOSED:"slidedownClosed",QUEUED:"slidedownQueued"}}}class Ba{isNativePromptShowing;context;eventHooksInstalled;constructor(t){this.isNativePromptShowing=!1,this.context=t,this.eventHooksInstalled=!1}shouldForceSlidedownOverNative(){const t=N();return _()===y&&t>=63&&(P()||$())||A()}async spawnAutoPrompts(){const t=OneSignal.config?.userConfig.promptOptions,e=this.shouldForceSlidedownOverNative(),i=this.getDelayedPromptOptions(t,Ft),n=this.isPageViewConditionMet(i),s=i.enabled&&n,o=e&&s;if(s&&!o)return void this.internalShowDelayedPrompt(Ft,i.timeDelay||0);const a=!!Us(t?.slidedown?.prompts,jt);o&&!a&&this.internalShowDelayedPrompt(jt,i.timeDelay||0);const r=t?.slidedown?.prompts;if(r&&r?.length>0)for(let c=0;c<r.length;c++){const e=r[c],i=this.getDelayedPromptOptions(t,e.type),n=this.isPageViewConditionMet(i),s={slidedownPromptOptions:e};i.enabled&&n&&this.internalShowDelayedPrompt(e.type,i.timeDelay||0,s)}}async internalShowDelayedPrompt(t,e,i){if(Ii("internalShowDelayedPrompt"),"number"==typeof e)switch(A()&&t===Ft&&(t=jt),e>0&&await St(1e3*e),t){case Ft:await this.internalShowNativePrompt();break;case jt:await this.internalShowSlidedownPrompt(i);break;case Kt:await this.internalShowCategorySlidedown(i);break;case zt:await this.internalShowSmsSlidedown(i);break;case Ht:await this.internalShowEmailSlidedown(i);break;case Vt:await this.internalShowSmsAndEmailSlidedown(i);break;default:kt.error("Invalid Delayed Prompt type")}else kt.error("internalShowDelayedPrompt: timeDelay not a number")}async internalShowNativePrompt(){Ii("internalShowNativePrompt"),this.isNativePromptShowing?kt.debug("Already showing autoprompt. Abort showing a native prompt."):(this.isNativePromptShowing=!0,await Hs(),this.isNativePromptShowing=!1,vi.markPromptDismissedWithType(di))}async internalShowSlidedownPrompt(t={force:!1}){Ii("internalShowSlidedownPrompt"),t.slidedownPromptOptions||(t.slidedownPromptOptions=ee);await this.context.dynamicResourceLoader.loadSdkStylesheet()===Bi?(this.eventHooksInstalled||this.installEventHooksForSlidedown(),await this.context.slidedownManager.createSlidedown(t)):kt.debug("Not showing slidedown permission message because styles failed to load.")}async internalShowCategorySlidedown(t){Ii("internalShowCategorySlidedown"),await this.internalShowParticularSlidedown(Kt,t)}async internalShowSmsSlidedown(t){Ii("internalShowSmsSlidedown"),await this.internalShowParticularSlidedown(zt,t)}async internalShowEmailSlidedown(t){Ii("internalShowEmailSlidedown"),await this.internalShowParticularSlidedown(Ht,t)}async internalShowSmsAndEmailSlidedown(t){Ii("internalShowSmsAndEmailSlidedown"),await this.internalShowParticularSlidedown(Vt,t)}async internalShowParticularSlidedown(t,e){const i=this.context.appConfig.userConfig.promptOptions?.slidedown?.prompts,n=e?.slidedownPromptOptions||Us(i,t);if(!n){if(t!==jt)return void kt.error(`OneSignal: slidedown of type '${t}' couldn't be shown. Check your configuration on the OneSignal dashboard or your custom code initialization.`);kt.warn("The OneSignal 'push' slidedown will be shown with default text settings. To customize, see the OneSignal documentation.")}await this.internalShowSlidedownPrompt({...e,slidedownPromptOptions:n})}installEventHooksForSlidedown(){this.eventHooksInstalled=!0,OneSignal.emitter.on(Ua.EVENTS.SHOWN,()=>{this.context.slidedownManager.setIsSlidedownShowing(!0)}),OneSignal.emitter.on(Ua.EVENTS.CLOSED,()=>{this.context.slidedownManager.setIsSlidedownShowing(!1),this.context.slidedownManager.showQueued()}),OneSignal.emitter.on(Ua.EVENTS.ALLOW_CLICK,async()=>{await this.context.slidedownManager.handleAllowClick(),$i.trigger(OneSignal.EVENTS.TEST_FINISHED_ALLOW_CLICK_HANDLING)}),OneSignal.emitter.on(Ua.EVENTS.CANCEL_CLICK,()=>{if(!this.context.slidedownManager.slidedown)return;const t=this.context.slidedownManager.slidedown?.options.type;switch(t){case jt:case Kt:kt.debug("Setting flag to not show the slidedown to the user again."),vi.markPromptDismissedWithType(di);break;default:kt.debug("Setting flag to not show the slidedown to the user again."),vi.markPromptDismissedWithType(gi)}})}isPageViewConditionMet(t){if(!t||void 0===t.pageViews)return!1;if(!t.autoPrompt||!t.enabled)return!1;return ls()>=t.pageViews}getDelayedPromptOptions(t,e){const i={enabled:!1,autoPrompt:!1,timeDelay:qt.timeDelay,pageViews:qt.pageViews};if(!t||!t.native||!t.slidedown)return i;switch(e){case Ft:{const e=t.native;return{enabled:e?.enabled,autoPrompt:e?.autoPrompt,timeDelay:e?.timeDelay,pageViews:e?.pageViews}}case jt:case Kt:case Ht:case zt:case Vt:{const{userConfig:t}=this.context.appConfig,i=Us(t.promptOptions?.slidedown?.prompts||[],e);return{enabled:!!i,autoPrompt:!!i?.autoPrompt,timeDelay:i?.delay?.timeDelay,pageViews:i?.delay?.pageViews}}default:return i}}}class La{static convertTagsApiToBooleans(t){const e={};return Object.keys(t).forEach(i=>{e[i]="1"===t[i]}),e}static convertTagsBooleansToApi(t){const e={};return Object.keys(t).forEach(i=>{e[i]=!0===t[i]?"1":"0"}),e}static getObjectDifference(t,e){const i={};return Object.keys(t).forEach(n=>{e[n]!==t[n]&&(i[n]=t[n])}),i}static markAllTagsAsSpecified(t,e){t.forEach(t=>{t.checked=e})}static isTagObjectEmpty(t){return 0===Object.keys(t).length}static getCheckedTagCategories(t,e){if(!e)return t;if(La.isTagObjectEmpty(e)){const e=structuredClone(t);return La.markAllTagsAsSpecified(e,!0),e}return structuredClone(t).map(t=>{const i=e[t.tag];return t.checked=La.getCheckedStatusForTagValue(i),t})}static getCheckedStatusForTagValue(t){return void 0===t||t}}class Ra{message;constructor(t){this.message=t}async show(){const t=document.createElement("div"),e=document.createElement("p");e.innerText=this.message,t.appendChild(e);const i=document.createElement("div"),n=document.createElement("div");i.id=bn,t.id=gn,ci(t,dn),ci(i,Zi),ci(i,en),ri("body").appendChild(i),n.id=yn,ci(n,Xi),n.appendChild(t),this.container.appendChild(n),ci(this.container,$()?sn:on),Ra.triggerSlidedownEvent(Ra.EVENTS.SHOWN)}static async triggerSlidedownEvent(t){await $i.trigger(t)}close(){ci(this.container,an),ki(this.dialog,"animationend",(t,e)=>{t.target!==this.dialog||"slideDownExit"!==t.animationName&&"slideUpExit"!==t.animationName||(ai(`#${bn}`),e())},!0)}get container(){return ri(`#${bn}`)}get dialog(){return ri(`#${yn}`)}static get EVENTS(){return{SHOWN:"toastShown",CLOSED:"toastClosed"}}}class Wa{mount(t,e){const i=this.generateHtml(t,e);ri(`#${wn}`).appendChild(i),this.taggingContainer&&this.taggingContainer.addEventListener("change",this.toggleCheckedTag);const n=ri(`#${pn}`);n.disabled=!1,li(n,"disabled"),ai(`#${On}`)}load(){const t=ri(`#${On}`),e=ri(`#${pn}`),i=document.createElement("div");ci(t,`${un}`),ci(i,An),ci(e,"disabled"),oi(t,"beforeend",Da(Dn)),i.innerText=Bn,t.appendChild(i),e.disabled=!0}generateHtml(t,e){const i=La.getCheckedTagCategories(t,e),n=i.filter(t=>i.indexOf(t)%2==0),s=i.filter(t=>i.indexOf(t)%2),o=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div");return ci(o,Nn),ci(a,Nn),ci(r,_n),r.id=Mn,n.forEach(t=>{o.appendChild(this.getCategoryLabelElement(t))}),s.forEach(t=>{a.appendChild(this.getCategoryLabelElement(t))}),r.appendChild(o),r.appendChild(a),r}getCategoryLabelElement(t){const{label:e}=t,i=document.createElement("label"),n=document.createElement("span"),s=document.createElement("input"),o=document.createElement("span"),a=document.createElement("div"),r=document.createElement("div");return ci(i,$n),ci(n,Pn),ci(s,En),ci(o,Tn),i.title=e,n.innerText=e,s.type="checkbox",s.value=t.tag,s.checked=!!t.checked,i.appendChild(n),i.appendChild(s),i.appendChild(o),a.setAttribute("style","clear:both"),r.appendChild(i),r.appendChild(a),r}get taggingContainer(){return ri(`#${wn} > div.${_n}`)}toggleCheckedTag(t){const e=t.target;if(e&&"checkbox"===e.getAttribute("type")){const t=e.checked;e.setAttribute("checked",t.toString())}}static getValuesFromTaggingContainer(){const t=`#${wn} > div.${_n}> div > div > label > input[type=checkbox]`,e=document.querySelectorAll(t),i={};return e.forEach(t=>{i[t.value]=t.checked}),i}}class Fa{context;slidedownQueue;isSlidedownShowing;slidedown;constructor(t){this.context=t,this.slidedownQueue=[],this.isSlidedownShowing=!1}async checkIfSlidedownShouldBeShown(t){const e="denied"===await OneSignal.context.permissionManager.getPermissionStatus();let i;const n=await OneSignal.context.subscriptionManager.getSubscriptionState(),{subscribed:s,optedOut:o}=n,a=t.slidedownPromptOptions?.type;let r=!1;if(a&&(r=Bs(a)),r){if(s)return!!t.isInUpdateMode||(kt.info(new Error("User is already subscribed")),!1);if(i=vi.wasPromptOfTypeDismissed(di),o)throw new Error("User is opted out");if(e)return kt.info(ut),!1}else{if(!t.force){const t=await OneSignal.coreDirector.hasSms(),e=await OneSignal.coreDirector.hasEmail(),i=t&&e;if(t&&a===zt)return kt.info(gt(zt)),!1;if(e&&a===Ht)return kt.info(gt(Ht)),!1;if(i&&a===Vt)return kt.info(gt(Vt)),!1}i=vi.wasPromptOfTypeDismissed(gi)}return!(i&&!t.force&&!t.isInUpdateMode)||(kt.info(new Error(`${a||"unknown"} was previously dismissed`)),!1)}async handleAllowForCategoryType(){if(!this.slidedown)throw ja;const t=Wa.getValuesFromTaggingContainer();this.context.tagManager.storeTagValuesToUpdate(t),Hs(),await this.context.tagManager.sendTags(!0)}async handleAllowForEmailType(){if(!this.slidedown)throw ja;const t=this.slidedown.channelCaptureContainer?.emailInputFieldIsValid,e=this.slidedown.channelCaptureContainer?.isEmailInputFieldEmpty();if(!t||e)throw new rt(st);const i=this.slidedown.channelCaptureContainer?.getValueFromEmailInput();this.updateEmail(i)}async handleAllowForSmsType(){if(!this.slidedown)throw ja;const t=this.slidedown.channelCaptureContainer?.smsInputFieldIsValid,e=this.slidedown.channelCaptureContainer?.isSmsInputFieldEmpty();if(!t||e)throw new rt(nt);const i=this.slidedown.channelCaptureContainer?.getValueFromSmsInput();this.updateSMS(i)}async handleAllowForSmsAndEmailType(){if(!this.slidedown)throw ja;const t=this.slidedown.channelCaptureContainer?.smsInputFieldIsValid,e=this.slidedown.channelCaptureContainer?.emailInputFieldIsValid,i=this.slidedown.channelCaptureContainer?.isEmailInputFieldEmpty(),n=this.slidedown.channelCaptureContainer?.isSmsInputFieldEmpty();if(!t&&!e||i&&n)throw new rt(ot);const s=this.slidedown.channelCaptureContainer?.getValueFromEmailInput(),o=this.slidedown.channelCaptureContainer?.getValueFromSmsInput();if(!e)throw new rt(st);if(i||this.updateEmail(s),!t)throw new rt(nt);n||this.updateSMS(o)}updateEmail(t){t&&OneSignal.User.addEmail(t)}updateSMS(t){t&&OneSignal.User.addSms(t)}async showConfirmationToast(){if(!this.slidedown)throw ja;const t=this.slidedown.options.text.confirmMessage;if(!t)return;await St(1e3);const e=new Ra(t);await e.show(),await St(5e3),e.close(),Ra.triggerSlidedownEvent(Ra.EVENTS.CLOSED)}async mountAuxiliaryContainers(t){switch(t.slidedownPromptOptions?.type){case Kt:this.mountTaggingContainer(t);break;case Ht:case zt:case Vt:await this.mountChannelCaptureContainer(t)}}async mountTaggingContainer(t){Ii("mountTaggingContainer");try{let e={};const i=new Wa,n=t.slidedownPromptOptions?.categories;if(!n)throw new Error("Categories not defined");const s=OneSignal.coreDirector.getPropertiesModel().tags;t.isInUpdateMode&&s?(this.context.tagManager.storeRemotePlayerTags(s),e=La.convertTagsApiToBooleans(s)):La.markAllTagsAsSpecified(n,!0),i.mount(n,e)}catch(e){kt.error("OneSignal: Attempted to create tagging container with error",e)}}async mountChannelCaptureContainer(t){Ii("mountChannelCaptureContainer");try{if(t.slidedownPromptOptions){const e=new Ma(t.slidedownPromptOptions);e.mount(),this.slidedown&&(this.slidedown.channelCaptureContainer=e)}}catch(e){kt.error("OneSignal: Attempted to create channel capture container with error",e)}}async handleAllowClick(){if(!this.slidedown)throw ja;const t=this.slidedown.options.type;this.slidedown.isShowingFailureState&&this.slidedown.removeFailureState();try{switch(t){case jt:Hs();break;case Kt:await this.handleAllowForCategoryType();break;case Ht:await this.handleAllowForEmailType();break;case zt:await this.handleAllowForSmsType();break;case Vt:await this.handleAllowForSmsAndEmailType()}}catch(e){return kt.warn("OneSignal Slidedown failed to update:",e),this.slidedown.removeSaveState(),this.slidedown.setFailureState(),void(e instanceof rt&&this.slidedown.setFailureStateForInvalidChannelInput(e.reason))}switch(this.slidedown&&(this.slidedown.close(),Bs(t)||await this.showConfirmationToast(),await St(1e3),Ua.triggerSlidedownEvent(Ua.EVENTS.CLOSED)),t){case jt:case Kt:kt.debug("Setting flag to not show the slidedown to the user again."),vi.markPromptDismissedWithType(di);break;default:kt.debug("Setting flag to not show the slidedown to the user again."),vi.markPromptDismissedWithType(gi)}}setIsSlidedownShowing(t){this.isSlidedownShowing=t}async showQueued(){if(this.slidedownQueue.length>0){const t=this.dequeue();t&&await this.createSlidedown(t)}}enqueue(t){this.slidedownQueue.push(t),Ua.triggerSlidedownEvent(Ua.EVENTS.QUEUED)}dequeue(){return this.slidedownQueue.shift()}async createSlidedown(t){Ii("createSlidedown");try{if(!(await this.checkIfSlidedownShouldBeShown(t)))return}catch(e){return void kt.warn("checkIfSlidedownShouldBeShown returned an error",e)}if(function(){const t=OneSignal.notifyButton;t&&t.options?.enable&&"hidden"!==OneSignal.notifyButton?.launcher?.state&&OneSignal.notifyButton?.launcher?.waitUntilShown().then(()=>{OneSignal.notifyButton?.launcher?.hide()}),OneSignal.emitter.once(Ua.EVENTS.CLOSED,()=>{OneSignal.notifyButton&&OneSignal.notifyButton.options.enable&&OneSignal.notifyButton.launcher.show()})}(),this.isSlidedownShowing)this.enqueue(t);else try{this.setIsSlidedownShowing(!0);const e=t.slidedownPromptOptions||ee;this.slidedown=new Ua(e),await this.slidedown.create(t.isInUpdateMode),await this.mountAuxiliaryContainers(t),kt.debug("Showing OneSignal Slidedown"),Ua.triggerSlidedownEvent(Ua.EVENTS.SHOWN)}catch(e){kt.error("There was an error showing the OneSignal Slidedown:",e),this.setIsSlidedownShowing(!1),this.slidedown?.close()}}}const ja=new Error("Slidedown is missing");class Ka{tagsFromTaggingContainer={};context;remoteTags={};constructor(t){this.context=t}async sendTags(){kt.info("Category Slidedown Local Tags:",this.tagsFromTaggingContainer);const t=La.convertTagsBooleansToApi(this.tagsFromTaggingContainer),e=La.getObjectDifference(t,this.remoteTags);return La.isTagObjectEmpty(e)?(kt.warn("OneSignal: no change detected in Category preferences. Skipping tag update."),e):(await OneSignal.User.addTags(e),e)}storeTagValuesToUpdate(t){this.tagsFromTaggingContainer=t}storeRemotePlayerTags(t){this.context.tagManager.remoteTags=t}}class za{appConfig;dynamicResourceLoader;subscriptionManager;serviceWorkerManager;workerMessenger;permissionManager;updateManager;promptsManager;sessionManager;tagManager;slidedownManager;constructor(t){var e,i;this.appConfig=t,this.subscriptionManager=new ka(e=this,{safariWebId:(i=e.appConfig).safariWebId,appId:i.appId,vapidPublicKey:i.vapidPublicKey,onesignalVapidPublicKey:i.onesignalVapidPublicKey}),this.serviceWorkerManager=function(t){const e=t.appConfig,i={workerPath:new aa(Wt),registrationOptions:Rt};return e.userConfig&&(e.userConfig.path&&(i.workerPath=new aa(`${e.userConfig.path}${e.userConfig.serviceWorkerPath}`)),e.userConfig.serviceWorkerParam&&(i.registrationOptions=e.userConfig.serviceWorkerParam)),new Sa(t,i)}(this),this.permissionManager=new xa,this.workerMessenger=new oa(this),this.updateManager=new Ea(this),this.sessionManager=new Ca(this),this.tagManager=new Ka(this),this.slidedownManager=new Fa(this),this.promptsManager=new Ba(this),this.dynamicResourceLoader=new Ri}}class Ha{setLogLevel(t){kt.setLevel(t)}}class Va extends ws{_;X;constructor(t){super(),this.X=t,this._="granted"===t,"undefined"!=typeof OneSignal&&OneSignal.emitter.on(OneSignal.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_STRING,t=>{this.X=t,this._="granted"===t})}get permissionNative(){return this.X}get permission(){return this._}async setDefaultUrl(t){if(Ii("setDefaultUrl",t),void 0===t)throw pt("url");if("string"!=typeof t)throw ft("url");if(!bt(t,{allowNull:!0}))throw wt("url");await Oi(),Ii("setDefaultNotificationUrl",t);const e=await Xe();e.defaultNotificationUrl=t,await ti(e)}async setDefaultTitle(t){if(Ii("setDefaultTitle",t),void 0===t)throw pt("title");if("string"!=typeof t)throw ft("title");await Oi();const e=await Xe();e.defaultNotificationTitle=t,await ti(e)}isPushSupported(){return Ii("isPushNotificationsSupported"),!0}async requestPermission(){await Oi(),await OneSignal.context.promptsManager.internalShowNativePrompt()}addEventListener(t,e){OneSignal.emitter.on(t,e)}removeEventListener(t,e){OneSignal.emitter.off(t,e)}}const qa={NOTIFICATION_PERMISSION_CHANGED_AS_STRING:"permissionChangeAsString",NOTIFICATION_PERMISSION_CHANGED_AS_BOOLEAN:"permissionChange",SUBSCRIPTION_CHANGED:"change",WELCOME_NOTIFICATION_SENT:"sendWelcomeNotification",NOTIFICATION_WILL_DISPLAY:"foregroundWillDisplay",NOTIFICATION_DISMISSED:"dismiss",NOTIFICATION_CLICKED:"click",SDK_INITIALIZED:"initializeInternal",SDK_INITIALIZED_PUBLIC:"initialize",REGISTERED:"register",PERMISSION_PROMPT_DISPLAYED:"permissionPromptDisplay",TEST_FINISHED_ALLOW_CLICK_HANDLING:"testFinishedAllowClickHandling",SESSION_STARTED:"os.sessionStarted"};class Ga{async sendOutcome(t,e){const i=OneSignal.config?.userConfig.outcomes;if(!i)return void kt.error(`Could not send ${t}. No outcomes config found.`);const n=new ra(OneSignal.config.appId,i,t,!1);if(void 0!==e&&"number"!=typeof e)return void kt.error("Outcome weight can only be a number if present.");if(!(await n.beforeOutcomeSend()))return;const s=await n.getAttribution();await n.send({type:s.type,notificationIds:s.notificationIds,weight:e})}async sendUniqueOutcome(t){const e=OneSignal.config?.userConfig.outcomes;if(!e)return void kt.error(`Could not send ${t}. No outcomes config found.`);const i=new ra(OneSignal.config.appId,e,t,!0);if(!(await i.beforeOutcomeSend()))return;const n=await i.getAttribution();if(n.type===Dt)return void kt.warn("You are on a free plan. Please upgrade to use this functionality.");const{notificationIds:s}=n,o=await i.getNotifsToAttributeWithUniqueOutcome(s);i.shouldSendUnique(n,o)?await i.send({type:n.type,notificationIds:o}):kt.warn(`'${t}' was already reported for all notifications.`)}}class Ja extends ws{constructor(){super()}async promptPush(t){await Oi(),await OneSignal.context.promptsManager.internalShowParticularSlidedown(jt,t)}async promptPushCategories(t){await Oi();const e=await OneSignal.context.subscriptionManager.isPushNotificationsEnabled();await OneSignal.context.promptsManager.internalShowCategorySlidedown({...t,isInUpdateMode:e})}async promptSms(t){await Oi(),await OneSignal.context.promptsManager.internalShowSmsSlidedown({...t})}async promptEmail(t){await Oi(),await OneSignal.context.promptsManager.internalShowEmailSlidedown({...t})}async promptSmsAndEmail(t){await Oi(),await OneSignal.context.promptsManager.internalShowSmsAndEmailSlidedown({...t})}addEventListener(t,e){OneSignal.emitter.on(t,e)}removeEventListener(t,e){OneSignal.emitter.off(t,e)}}let Ya=class t{static EVENTS=qa;static async tt(){const e=new Yo;await e.init(),t.coreDirector=new Xo(e);const i=await ni(),n=await t.context.permissionManager.getPermissionStatus();t.User=new Ms(!0,i,n),this.Notifications=new Va(n)}static async et(e){const i=await fe(e);kt.debug("OneSignal: Final web app config:",i),t.config=i,t.context=new za(i),t.config=t.context.appConfig}static async login(t,e){if(Ii("login",{externalId:t,jwtToken:e}),void 0===t)throw pt("externalId");if("string"!=typeof t)throw ft("externalId");if(void 0!==e&&"string"!=typeof e)throw ft("jwtToken");await ea.login(t,e)}static async logout(){Ii("logout"),await ea.logout()}static async init(e){if(Ii("init"),kt.debug(`Browser Environment: ${_()} ${N()}`),localStorage.removeItem("isOptedOut"),localStorage.removeItem("isPushNotificationsEnabled"),function(){if(OneSignal.it)throw new Error("SDK already initialized");OneSignal.it=!0}(),await t.et(e),!t.config)throw new Error("OneSignal config not initialized!");if(_()!==v||t.config.safariWebId){if(await t.tt(),cs()){if(!(await ei()))return void(t.pendingInit=!0)}await t.nt()}else kt.warn(dt)}static async nt(){async function e(){t.st||(t.st=!0,t.emitter.on(t.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_STRING,Ls),t.emitter.on(t.EVENTS.SUBSCRIPTION_CHANGED,Fs),t.emitter.on(t.EVENTS.SDK_INITIALIZED,Vs),window.addEventListener("focus",()=>{Mi.checkAndTriggerNotificationPermissionChanged()}),await async function(){const t=Mi.getAppId(),e=OneSignal.config;await Ge.put("Ids",{type:"appId",id:t});const i=e.siteName||document.title||"Notification";await Ge.put("Options",{key:"pageTitle",value:i}),kt.info(`OneSignal: Set pageTitle to be '${i}'.`)}(),await async function(){const t=[],e=OneSignal.config?.userConfig.persistNotification;t.push(Ge.put("Options",{key:"persistNotification",value:null==e||e}));const i=OneSignal.config?.userConfig.webhooks;return["notification.willDisplay","notification.clicked","notification.dismissed"].forEach(e=>{i&&i[e]?t.push(Ge.put("Options",{key:`webhooks.${e}`,value:i[e]})):t.push(Ge.put("Options",{key:`webhooks.${e}`,value:!1}))}),i&&i.cors?t.push(Ge.put("Options",{key:"webhooks.cors",value:!0})):t.push(Ge.put("Options",{key:"webhooks.cors",value:!1})),OneSignal.config?.userConfig.notificationClickHandlerMatch?t.push(Ge.put("Options",{key:"notificationClickHandlerMatch",value:OneSignal.config.userConfig.notificationClickHandlerMatch})):t.push(Ge.put("Options",{key:"notificationClickHandlerMatch",value:"exact"})),OneSignal.config?.userConfig.notificationClickHandlerAction?t.push(Ge.put("Options",{key:"notificationClickHandlerAction",value:OneSignal.config.userConfig.notificationClickHandlerAction})):t.push(Ge.put("Options",{key:"notificationClickHandlerAction",value:"navigate"})),Promise.all(t)}(),await Ks())}t.pendingInit=!1,t.context.workerMessenger.listen(),"complete"===document.readyState||"interactive"===document.readyState?await e():(kt.debug("OneSignal: Waiting for DOMContentLoaded or readyStateChange event before continuing initialization..."),window.addEventListener("DOMContentLoaded",()=>{e()}),document.onreadystatechange=()=>{"complete"!==document.readyState&&"interactive"!==document.readyState||e()})}static async setConsentGiven(e){if(Ii("setConsentGiven",{consent:e}),void 0===e)throw pt("consent");if("boolean"!=typeof e)throw ft("consent");await Ge.put("Options",{key:"userConsent",value:e}),e&&t.pendingInit&&await t.nt()}static async setConsentRequired(t){if(Ii("setConsentRequired",{requiresConsent:t}),void 0===t)throw pt("requiresConsent");if("boolean"!=typeof t)throw ft("requiresConsent");var e;e=t,localStorage.setItem(rs,e.toString())}static async push(e){return function(t,e){if("function"==typeof e)return e(t);throw new Error("Callback is not a function")}(t,e)}static S;static VERSION=M;static config=null;static D=!1;static h=!1;static timedLocalStorage=bi;static initialized=!1;static Z=!1;static notifyButton=null;static database=Ge;static pendingInit=!0;static emitter=new Ei;static cache={};static it=!1;static st=!1;static context;static coreDirector;static Notifications=new Va;static Slidedown=new Ja;static Session=new Ga;static User=new Ms(!1);static Debug=new Ha};kt.info(`OneSignal Web SDK loaded (version ${M},\n  ${L} environment).`),kt.debug(`Current Page URL: ${"undefined"==typeof location?"NodeJS":location.href}`),function(){if(window.__oneSignalSdkLoadCount=xi()+1,xi()>1)return kt.warn("OneSignal: The web push SDK is included more than once. For optimal performance, please include our SDK only once on your page."),void kt.debug(`OneSignal: Exiting from SDK initialization to prevent double-initialization errors. Occurred ${xi()} times.`);window.OneSignal=Ya,window.OneSignalDeferred=window.OneSignalDeferred??[];const t=async function(t){for(const i of t)try{await Ya.push(i)}catch(e){kt.error(e)}}(window.OneSignalDeferred);Object.defineProperty(window.OneSignalDeferred,"push",{value:async function(e){return await t,Ya.push(e)}})}()}();
//# sourceMappingURL=OneSignalSDK.page.es6.js.map
